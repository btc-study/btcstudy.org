<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><title>闪电网络：技术与用户体验（三）：路由</title><meta name=keywords content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name=description content=比特币思想的中文集结地><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1"><link rel=icon href=/favicon.ico><link rel=stylesheet href="/style/common/bulma.css?v=1682773100887"><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href="/style/common/iconfont.css?v=1682773100887"><link rel=stylesheet href="/style/base.css?v=1682773100887"><link rel=stylesheet href="/style/common/helper.css?v=1682773100887"><link rel=stylesheet href="/style/themes/animation.css?v=1682773100887"><script>function ready(){var e=document.querySelector(".body-container"),t=localStorage.getItem("theme")||"light";["light","dark"].includes(t)||(t="light",localStorage.setItem("theme","light")),e.classList.remove("appearance-auto"),e.classList.add("appearance-"+t),quickInitialTheme()}function quickInitialTheme(){var e=localStorage.getItem("theme")||"light",t=document.querySelector(".logo-light"),o=document.querySelector(".logo-dark"),d=document.querySelector("#mobile-header-logo > .logo-light"),l=document.querySelector("#mobile-header-logo > .logo-dark"),a=document.getElementById("theme-btn"),i=document.querySelector(".slide-theme-light"),c=document.querySelector(".slide-theme-dark");document.body.classList.add(e),("dark"===e?(t.classList.add("hidden"),o.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden"),a.classList.remove("icon-icon_dark"),a.classList.add("icon-icon_light"),i):c).classList.remove("hidden")}document.addEventListener("DOMContentLoaded",ready)</script><script src="/js/common.js?v=1682773100887"></script><script src=/js/libs/zepto.min.js></script><link rel=stylesheet href="/style/post.css?v=1682773100887"><link rel=stylesheet href="/style/themes/highlight.css?v=1682773100887"><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title="BTC Study" type=application/atom+xml></head><body class="is-flex is-flex-direction-column" onload=initialTheme()><div class=clip></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id=header><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href=/ ><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id=header-menu><a class="is-inline-block header-activity mr-4" href=/ >首页</a><a class="is-inline-block mr-4" href=/archives>全站目录</a><a class="is-inline-block mr-4" href=/tags>标签</a><a class="is-inline-block mr-4" href=/maps>地图</a><a class="is-inline-block mr-4" href=/tools>工具</a><a class="is-inline-block mr-4" target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input type=range min=12 max=32 step=2></div></div></div><i class="iconfont icon-icon_dark mr-1" id=theme-btn></i><div class=search-wrap><input class=pl-3 id=search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search" id=search-input-btn></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopic><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">闪电网络：技术与用户体验（三）：路由</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn2></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input2 type=range min=12 max=32 step=2></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id=mobile-header><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id=mobile-header-logo><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopicMobile><p class=is-full-height>闪电网络：技术与用户体验（三）：路由</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class=mobile-search-wrap><div class=search-input><input class=pl-3 id=mobile-search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class=mobile-search-input-btn>搜 索</button></div></div></header><div class=mobile-slide-menu><a class=header-activity href=/ >首页</a><a href=/archives>全站目录</a><a href=/tags>标签</a><a href=/maps>地图</a><a href=/tools>工具</a><a target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class=slide-menu-fontsize><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1682773100887"></script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%B7%AF%E7%94%B1><span class=toc-text>路由</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%85%AC%E5%BC%80%E4%BF%A1%E6%81%AF><span class=toc-text>公开信息</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%A7%81%E4%BA%BA%E4%BF%A1%E6%81%AF%E4%B8%8E%E5%8F%91%E7%A5%A8><span class=toc-text>私人信息与发票</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95><span class=toc-text>路由算法</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%94%AF%E4%BB%98%E8%BD%AC%E5%8F%91%E6%8C%87%E4%BB%A4><span class=toc-text>支付转发指令</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%BB%93%E8%AF%AD><span class=toc-text>结语</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%9A%E8%B7%AF%E5%BE%84%E6%94%AF%E4%BB%98><span class=toc-text>多路径支付</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#PTLC-%E4%B8%8E%E5%8E%9F%E5%AD%90%E5%8C%96%E7%9A%84%E5%A4%9A%E8%B7%AF%E5%BE%84%E6%94%AF%E4%BB%98><span class=toc-text>PTLC 与原子化的多路径支付</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%B9%A6%E5%BA%8A%E8%B7%AF%E7%94%B1><span class=toc-text>蹦床路由</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%B7%AF%E5%BE%84%E7%9B%B2%E5%8C%96><span class=toc-text>路径盲化</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BB%93%E8%AF%AD-1><span class=toc-text>结语</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%84%9A%E6%B3%A8><span class=toc-text>脚注</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id=postTitle>闪电网络：技术与用户体验（三）：路由</h1><div class=page-author><div class="is-flex is-flex-direction-row page-data mr-6"><img class=mr-1 src=/images/default_avatar.png alt=Anony><div class=page-author-info><strong>Anony</strong><time class=has-text-grey datetime=2024-02-23T10:11:45.000Z>2024-02-23</time></div></div><div class=is-flex><a href=/tags/%E9%97%AA%E7%94%B5%E7%BD%91%E7%BB%9C><i class="page-tag mr-1 px-1">闪电网络</i></a><a href=/tags/%E7%9B%B2%E5%8C%96%E8%B7%AF%E7%94%B1><i class="page-tag mr-1 px-1">盲化路由</i></a><a href=/tags/PTLC><i class="page-tag mr-1 px-1">PTLC</i></a></div></div><article class="mt-4 post-content"><blockquote><p><em>作者：Anony</em></p><p><a href=https://www.btcstudy.org/2024/02/07/lightning-network-technology-improvement-and-users-experience-part-2/ ><em>前篇见此处</em></a></p></blockquote><p>在上一篇文章中，我们了解了如何借助比特币的脚本和交易特性，实现双方可以无限次更新状态的共有资金（“通道”）；并在此基础上实现可以获得收据的 “支付”。与链上支付相比，这种基于通道的支付具有低手续费、确认速度快的特点，因此扩大了比特币的吞吐量（“可扩展性”）。</p><p>但是，这只表明，通道是可以实现的，跨通道的多跳支付也是可以实现的。具体来说，在一个网络中，到底如何运用这些技术，向另一个节点支付呢？本篇将解决这个问题。</p><p>本篇所述的内容，将使读者对闪电网络的 “网络” 特性有更直观的理解，也将意识到，这里有多么大的改进空间。本文也将解释一些已经发生和正在发生的改进。同时，其中的关键事实，也解释了闪电网络当前的一些用户体验。</p><h2 id=路由><a href=#路由 class=headerlink title=路由></a>路由</h2><p>“路由（routing）” 的字面意思是 “寻找路径”。</p><p>假设你要去一个从没去过的地方，你需要哪些信息？首先，你需要一张地图；其次，你需要在地图上找出你身处的位置以及目的地的位置；最后，在两个点之间找出一条可以走得通的线路。互联网导航软件在做的也是同样的事情。</p><p>在闪电网络中找出由通道前后连接而成的、给特定对象支付的路径，也是一样的道理。为此我们要借助两部分信息。</p><h3 id=公开信息><a href=#公开信息 class=headerlink title=公开信息></a>公开信息</h3><p>整个闪电网络的公开通道的连接情形，也即网络的拓扑图，在闪电网络中属于公开的信息。任何一个节点都可以从其它节点处获得该节点所掌握的拓扑信息。每一个节点在新建一条公开通道时，也都会向自己所知的其它对等节点播报（<code>channel_announment</code>）<sup><a href=#note1 id=jump-1>1</a></sup>，从而更新这些公开的信息。</p><blockquote><p>闪电网络中有两种通道，一种是公开的通道，另一种则是不公开的（unannounced channel）。如此处所述，前者的许多信息属于全网可得的公开信息。后者的这些信息并不向整个网络公开，但有可能被第三方知晓，比如，节点出于收款的需要而主动暴露给支付方。</p></blockquote><p>另一种公开的信息，是这些公开通道的容量（双方共有的资金总额）。新的公开通道在播报出来的时候，也会公开该通道所使用的 UTXO（被称为 “channel point”），该 UTXO 的面额自然也就是这条通道的容量。通道容量的信息在规划支付路径时显然是有用的，它使我们可以不必尝试那些容量显然不够的通道，或者说，可以不在一条通道上尝试超过该通道容量的支付。</p><blockquote><p>但是，这一信息也常常被诟病为对隐私性的侵害：能够同时观察链上数据和闪电网络拓扑信息的人，将知道哪一个节点在使用哪一条通道（哪一个 UTXO），并猜测汇入这个 UTXO 的哪一部分资金属于这个节点，甚至能从该 UTXO 的后续变化中了解该节点的情况，例如，该节点广播一笔非合作式结算该通道的交易之后，使用自己的另一个 UTXO 来为这笔交易追加手续费。</p><p>如果有一种技术，可以在不曝光通道 UTXO 的前提下可信地证明其容量，将是对闪电网络隐私性的重大改进。</p></blockquote><p>还有一种公开的信息，是通道在转发特定方向的支付时的收费条件，以及允许 HTLC 留存的时间。由于一条通道有两个端点，所以它可以媒介两种方向的支付。每一种方向的支付的收费条件，都是由负责的节点自己定义的（通过 <code>channel_update</code> 消息来更新）<sup><a href=#note2 id=jump-2>2</a></sup>。显然，这也是对寻路有用的信息，支付方可以优先选择收费更便宜的路线。</p><p>值得一提的是，有一种信息并不是全网公开的信息：每一条通道的双方实时余额。显然，如果有这种信息，寻路问题将变得非常容易解决：一条路径到底能不能支付成功，只需观察路径上的通道的实时余额就可以知道了。但是，每个人都知道，这对隐私性来说是多么大的灾难：第三方观察者将能轻松地从通道余额的变动中找出哪个节点在给哪个节点支付、支付额是多少。这是闪电网络作出的取舍，牺牲支付的效率来提高隐私性。我认为这种取舍是值得的。</p><p>除了这些公开信息，我们还需借助一些私人信息。</p><h3 id=私人信息与发票><a href=#私人信息与发票 class=headerlink title=私人信息与发票></a>私人信息与发票</h3><p>为了发起支付，我们需要知道自己在给哪一个节点支付 —— 这就是我们需要接收者提供的信息：接收方节点在网络中的位置。</p><p>在最常规的情形中， 这就是收款方要向支付方出示 “闪电发票（invoice）”<sup><a href=#note3 id=jump-3>3</a></sup> 的原因。发票中包含了接收方节点的签名，可用于复原出接收方节点的公钥，也即其 <code>node_id</code>，从而允许我们定位到闪电网络中的具体一个节点。发票中也包含了支付额以及支付哈希值，允许支付方使用这个哈希值来建立 HTLC。发票还可以包含要求支付方写明的备注、支付过期时间等信息。</p><p>依据公开信息（地图）和接收方提供的私人信息，我们就可以尝试在网络中找出一条路径，给接收方支付一定的数额。</p><h3 id=路由算法><a href=#路由算法 class=headerlink title=路由算法></a>路由算法</h3><p>在网络中找出一条令人满意的路径始终是一个有挑战性的事情，因为网络的情形是不断变化的。具备足够容量的通道可能恰好有节点下线了，或者在支付者希望传递支付的方向上没有足够多的余额。或者，虽然能找出路径，但所需的转发费用超出了支付者愿意负担的程度。</p><p>当前闪电网络的两个主要客户端实现 LND 和 Core Lightning 都使用 Dijkstra 算法<sup><a href=#note4 id=jump-4>4</a></sup> 的某个变种<sup><a href=#note5 id=jump-5>5</a></sup> <sup><a href=#note6 id=jump-6>6</a></sup>。该算法常常用于在固定一个起点时寻找触达其它点的最短路径。</p><p>不过，闪电网络规范（BOLT）并不规定寻路算法，也就是说人们可以按自己的想法尝试各种不同的算法，这不会导致你的节点无法参与闪电网络。</p><p>当前，改进路由算法最新的一些尝试包括：假设通道总是不平衡的（大部分余额会位于一端），以此来猜测并获得已尝试过的通道的一些信息；在支付之前用失败支付来 “打探” 一条路径是否能成功；等等。</p><h3 id=支付转发指令><a href=#支付转发指令 class=headerlink title=支付转发指令></a>支付转发指令</h3><p>最后一个问题是，假定一个节点掌握了网络的拓扑图，并从接收者传来的发票中得知了接收者节点的 id，以及本次支付的支付额以及支付哈希值；然后，它使用路由算法，在网络中找出了很有可能支付成功的一条路径；那么，它该怎么告诉路径上的节点、请求他们使用 HTLC 来转发支付呢？</p><p>就像接力传递 HTLC 一样，这样的指令也是接力传递的。假设现在 Alice 在收到 Diana 的发票之后，找出了一条给 Diana 支付的路径：</p><pre><code>Alice --&gt; Bob --&gt; Carol --&gt; Diana
</code></pre><p>那么：</p><ul><li>Alice 向 Bob 表示自己可以提供一个 HTLC，同时发送一个加密的数据包，以及一些元数据 <sup><a href=#note7 id=jump-7>7</a></sup>；（双方会更新承诺交易以增设这个 HTLC 输出）</li><li>Bob 依靠元数据解密数据包后，得到一段可读的消息以及一个新的加密数据包；该消息指示他向 Carol 提供一个 HTLC，并将这个新的加密数据包转发给 Carol；</li><li>Bob 向 Carol 提供 HTLC 并发送上一步中得到的加密数据包，以及一些元数据；（双方更新承诺交易）</li><li>Carol 依靠所得的元数据解密所得的加密数据包，得到一段可读的消息以及新的一个加密数据包；该消息指示她向 Diana 提供一个 HTLC，并将新的加密数据包转发给 Diana。</li><li>Carol 向 Diana 提供 HTLC 并发送上一步中得到的加密数据包，以及一些元数据；（双方更新承诺交易）</li><li>Diana 依靠所得的元数据解密加密数据包，并从中知晓自己是最终的接收者。</li><li>Diana 向 Carol 释放原像，双方更新承诺交易。原像一路回传，导致支付路径上的 HTLC 都得到结算。最终，Alice 获得原像，即支付证据。</li></ul><p>可见，一个节点在转发支付时要做什么，完全是由发送者在加密消息中指定的。（转发节点为什么愿意遵从这些指令呢？因为他们期待从中收到转发费用。）</p><p>发送者在一开始计算好路径之后，就构造出给每一个转发节点的指令，然后以加密的方式，确保相应的指令只能被相应的节点知晓。因此，每一个节点都不知道后续的节点收到的是什么样的指令。</p><p>其次，因为每个节点收到的加密数据包中，都没有此前节点的信息遗存，所以每个节点也都不知道自己之前的节点收到的指令。</p><p>最后，因为每个节点在解密、删去自己可读的消息之后，往下一个节点传递加密数据包时，会用垃圾数据将它填充到自己所获得的加密数据包的长度，所以，每一个节点收到的加密数据包的长度都是相同的。所以，没有任何一个节点能从这些数据中知道自己前面有几个节点、后面有几个节点 —— 它只知道自己的上一个节点和下一个节点，而无法知晓整条支付路径。这就实现了相当好的隐私性。</p><blockquote><p>这是使用一种叫做 “Sphinx” 的消息构造技术实现的。其关键是按支付路径的倒序构造支付指令和加密包，并且层层加密：Alice 先构造给 Diana 的指令，填充垃圾数据成特定的长度（1300 字节），执行加密；然后在结果的前面加入给 Carol 的指令、删去后面多余的字节使数据成特定的长度（1300 字节），再次加密；再加入给 Bob 的指令、删去多余的字节，再次加密。</p><p>如果我们用括号表示加密的话，最终 Alice 发给 Bob 的加密数据包相当于是这样的：<code>(给 Bob 的指令 + (给 Carol 的指令 + (给 Diana 的指令)))</code>。每个人都只能解开一层加密，了解一些信息，然后将剩余的加密数据包（在填充垃圾数据成 1300 字节后）转发给下一个节点。</p><p>与加密包伴随的是一段元数据，可被对应的节点用来解密（但对其他人是无用的）。给下一个节点的元数据总能依据本节点得到的元数据构造出来，所以 Alice 只需构造给 Bob 的元数据就可以了。</p><p>最终，每个转发节点收到的消息都是 1366 字节，其中 1300 字节是加密数据包；而剩余的 66 字节则是元数据。</p></blockquote><p>这种在构造时层层加密、读取时层层解密的消息，非常类似于洋葱（onion），这就是为什么整套协议被命名为 “洋葱路由”。但它与 “洋葱消息” 是两种独立的特性。</p><blockquote><p>“洋葱消息” 在闪电网络的语境下有特殊的含义，指的是一种 “闪电网络节点间直接通信” 的协议，我们会在下一篇文章中介绍。</p></blockquote><p>此处所说的加密消息包的构造过程图示，可见这篇文章 <sup><a href=#note8 id=jump-8>8</a></sup>。</p><blockquote><p>除此之外，由于给每一个中间节点的指令中都包含了其应在通道中保留 HTLC 的时间以及相应的面额，而这两个数值是逐跳递减的（以保证资金安全性并支付转发费用），为了避免中间节点从中猜出接收者节点与自身的距离，还应该在这两个数额中加入一些冗余，或使用多余的跳，以优化接收者节点的隐私性。</p></blockquote><h3 id=结语><a href=#结语 class=headerlink title=结语></a>结语</h3><p>虽然发送者节点需要在拓扑图上运行路由算法、构造给路径上每一个节点的指令、每一个节点都要解密消息并给自己的通道对手更新状态，但是，整个过程的带宽和计算负担都很小。每两个节点之间只需传递两次消息，只需更新两次通道状态（一次是增加 HTLC 输出，一次是结算或表示失败），更新通道状态只需要生成一些签名并发送给对方（而无需实际上发送承诺交易，因为承诺交易的构造是确定性的）。所以，闪电网络的用户会发现，在成功的支付中，它的速度总是相当快，一般几秒之内就能确认支付成功。</p><p>接下来，我们探讨一些优化措施。这些优化措施分别优化了支付的成功率、发送者的负担和接收者的隐私性。</p><h2 id=多路径支付><a href=#多路径支付 class=headerlink title=多路径支付></a>多路径支付</h2><p>在上面的例子中，Alice 找出了<strong>一条路径</strong>给 Diana 支付。但仔细想想，如果支付只能走一条路径，显然是不够理想的。因为闪电网络是一个网络 —— 这意味着 Alice 有多条路径可以触达 Diana，每一条都在所需要的方向上都有一定的支付能力。如果只能走一条路径，就没有用尽闪电网络的潜能，可允许的支付额度会更小，或只能采用更远的路径而使费用变高。</p><p>我们仍以<a href=https://www.btcstudy.org/2024/01/25/lightning-network-technology-improvement-and-users-experience-part-1/#%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E7%8E%87>第一篇中的例子</a>举例：</p><pre><code>甲  &lt;--------&gt;  乙  &lt;--------&gt;  丙  &lt;--------&gt;  丁
500          300  200        300  500        500

甲  &lt;----------------&gt;  戊  &lt;----------------&gt;  丁
500                 200   300                500
</code></pre><p>如果只能采用一条路径，甲最多只能给丁支付 300 聪；如果能同时运用两条路径，就能支付 500 聪。</p><p>幸运的是，闪电网络的支付形式 HTLC 并不妨碍我们通过多条路径送达支付，反正，每一条路径上的每一个节点，要采取什么样的行动，都是发送者节点可以指定的！发送者可以将一笔支付额拆成多笔更小额的支付，每一笔都使用相同的哈希值建构 HTLC，然后使用不同的支付路径送达。这就是所谓的 “多路径支付（MPP）”。</p><p>事实上，在发送者给接收者构造的消息中，有两个字段，分别指明当前这条消息将送达的支付数额，以及发送者意图支付的总数额，这就可以告知接收者，发送者是否在使用多路径支付。</p><p>敏锐的读者会立即意识到一个问题：拆开的多笔支付不一定能同时送达，甚至可能只有一些会送达，而另一些会失败。这该怎么办呢？如果接收者在只收到一部分支付碎片时就回传原像，岂不就遭遇了损失？答案是，不怎么办 —— 只要接收者节点不在所有支付碎片都到达之前回传原像，就不会遭遇经济损失，而这是接收者节点出于自己的利益，会自然而然采取的行为。当然，在这个过程中，由于成功的路径不能获得回传的原像，各个通道中都会有一些资金被锁定一段时间，但这是可以优化的，发送者可以及时回传支付失败的信息，从而解除资金占用。</p><blockquote><p>LND 客户端实现了一种叫做 “原子化多路径支付” 的技术。顾名思义，就是可以保证所有支付碎片要么一起成功，要么一起失败 —— 尽管仍可能遭遇一些支付碎片无法送达的情形，但接收者却一定不会遭遇损失，不会在只收到部分碎片的时候就返回原像。这是因为，用来构建 HTLC 的哈希值并不是由接收者给出的，而是由发送者指定的，并且发送者将原像的信息分散在不同路径的支付转发消息中。只有所有消息都到达，发送者才能抽取完整的原像信息，并让所有支付路径都回传原像。</p><p>这种技术听起来很美妙，但实际上，它却缺乏一个关键的元素：发送者无法收到支付证据。跟这些支付相关的原像信息，是发送者早就已经知道的。这使它更像一种高级的 “Keysend” 功能 —— 我们会在下一篇文章中介绍。</p></blockquote><p>当前，所有主要的闪电网络客户端（Core Lightning、Eclair、LND）都已经实现了多路径支付。</p><h3 id=PTLC-与原子化的多路径支付><a href=#PTLC-与原子化的多路径支付 class=headerlink title="PTLC 与原子化的多路径支付"></a>PTLC 与原子化的多路径支付</h3><p>在上一篇文章中我们提到，PTLC 可以替代 HTLC 并获得更好的隐私性。但 PTLC 能做的还不止如此。</p><p>PTLC 与 HTLC 的关键区别在于，它使用了另一种检查秘密值的方式：椭圆曲线点乘法（私钥与公钥的对应）。而它是 “可加的”。即：</p><pre><code>a.G + b.G = (a + b).G = A + B
</code></pre><p>这就意味着，当支付发送者要用 PTLC 交换秘密值（私钥）<code>a</code> 的时候，也完全可以使用公钥 <code>A + B</code> 来检查，只要发送者以某种方式，将 <code>b</code> 告诉支付接收者 —— 而这正是支付转发消息可以做到的事。</p><p>因此，发送者可以创建一种基于 PTLC 的、可以收到支付证据的、原子化的多路径支付：生成 n 个秘密值 <code>s_i</code>，这些秘密值的和为 <code>s</code>；在不同支付碎片的支付转发消息中告诉接收者不同的 <code>s_i</code>，并在支付路径的最后一跳中要求检查 <code>S + A</code> 的秘密值，也即 <code>s + a</code>。 仅当所有的支付转发消息（支付碎片）都送达的时候，接收者才能知道 <code>s</code>，然后才能在所有支付路径中回传秘密值。而发送者也可以收到支付证据 <code>a</code>。</p><h2 id=蹦床路由><a href=#蹦床路由 class=headerlink title=蹦床路由></a>蹦床路由</h2><p>在上文的例子中，支付路径是由支付的发送者 Alice 根据自己所知的网络拓扑图构造的。这意味着，支付者要先有这个拓扑图。但是，拓扑图既需要存储空间，也会时时变化。到了闪电网络用户这里，就意味着，每次上线，都需要先拨出一个时间来获取拓扑图的更新并完成处理，然后才能支付。对于闪电网络的目标用户（使用移动设备的小额支付用户）来说，这种时延可能会构成很大的困扰。</p><p>“蹦床路由（Trampoline payments）” 就是一种解决这个问题的技术，其思路是：假定 Franky 具有完整的拓扑图，而发送者 Alice 没有，但是知道 Franky 的闪电网络位置；那么，Alice 先找出触达蹦床节点 Franky 的路径，然后再由 Franky 找出触达接收者 Diana 的路径。这就把保存和更新拓扑图、规划路径的工作外包给了 Franky。</p><p>因为 Franky 要寻找触达 Diana 的路径，Alice 当然要把 Diana 的闪电网络位置告诉他，这就影响了接收者的隐私性。对应的一种解决办法是，使用多个蹦床节点，也即，Alice 指示 Franky 寻找的，不是最终接收者 Diana，而是另一个蹦床节点 Gloria。当需要寻找的节点既可能是蹦床节点、也可能是最终接收者的时候，Franky 自然就不能肯定到底是哪一种情况。</p><p>别忘了，在支付路径上，一个中间节点要做什么，能够了解什么信息，完全是由发送者决定的。这给了我们相当大的自由来实现蹦床路由这样的技术。</p><p>蹦床路由的另一个缺点是，它可能会使用更长的路径，因此支付者需要付出更高的手续费，但这是可以接受的。</p><p>迄今，所有主要的闪电网络客户端都已经实现了蹦床路由。值得一提的是，接收者节点并不需要支持蹦床路由，就能接收支付。</p><p>蹦床路由的基本介绍可见这两篇文章 <sup><a href=#note9 id=jump-9>9</a></sup> <sup><a href=#note10 id=jump-10>10</a></sup>。</p><h2 id=路径盲化><a href=#路径盲化 class=headerlink title=路径盲化></a>路径盲化</h2><p>最后一个我们要介绍的改进，与接收者的隐私性有关。</p><p>如前所述，因为洋葱路由的采用，闪电支付的发送方享有非常好的隐私性：支付路径上的转发节点并不知道自己前面有多少跳，也就难以确定发送方的位置。但是，接收者的隐私性，相对来说就没有那么好。转发节点可以通过 HTLC 的持续时间和数额猜测自己跟最终接收者的距离；接收者的节点位置首先要暴露给发送者，还有可能被发送者暴露给第三方（蹦床节点）。这些都是接收者隐私性的瑕疵。</p><p>那么，有没有一种办法可以不暴露接收者节点的位置，而依然能接收支付呢？</p><p>“路径盲化（route blinding）” 就是旨在解决这个问题的尝试。其想法是，接收者向发送者暴露的不是自己的闪电网络位置（<code>node_id</code>），而是一条可以触达自身的路径；并且，这条路径所经过的节点和通道，是不向发送者暴露的（“盲化”）；发送者能知道的仅有这条路径的 “入口节点”，即第一个节点。</p><p>实质上，这意味着，支付路径不再是全部由发送者决定的了；相反，接收者选择了一段路径，并将使用这条路径的必要信息（比如到达入口节点时应该为 HTLC 设置的存续时间和面额）告诉发送者。发送者只需用常规的支付转发消息触达入口节点，并递送接收者提前构造的加密消息，就能触达接收者；从入口节点开始，盲化路径上的节点会逐一解密安排给自己的消息，并依据其中的信息转发支付。</p><p>这再一次体现了闪电<strong>网络</strong>的灵活性！</p><p>关于 “路径盲化” 的详细描述，可见这份提议 <sup><a href=#note11 id=jump-11>11</a></sup>。</p><p>当前，路径盲化的详述已经在 2023 年 4 月进入了闪电网络规范（BOLT）#4 <sup><a href=#note12 id=jump-12>12</a></sup>。主要的闪电网络客户端都在致力于实现路径盲化。</p><p>值得一提的是，蹦床路由和路径盲化实际上可以相结合。Eclair 客户端就实现了将两者相结合的特性 <sup><a href=#note13 id=jump-13>13</a></sup>。</p><h2 id=结语-1><a href=#结语-1 class=headerlink title=结语></a>结语</h2><p>在本文中，我们介绍了一种标准的闪电支付流程所涉及的网络通信步骤：支付的发送者需要依据网络的拓扑图以及接收者所暴露的信息，创建支付路径，并借助节点之间的网络连接逐步转发消息并接力支付。这个过程具备相当好的隐私性，也尽可能降低了节点对稳定的互联网位置的依赖。</p><p>然后，我们介绍了几种优化措施：多路径支付、蹦床路由以及路径盲化。它们分别优化了支付的成功率、发送者节点的启动负担以及接收者的隐私性。这些优化措施都围绕着闪电网络的 “网络” 特性而展开。</p><p>在下一篇文章中，我们将回归用户体验问题，介绍一个普通用户感知很明显的事物：收款码。</p><p>闪电网络的发票本身是一次性的，它包含了一次支付的哈希值及其面额，在支付成功或者超时之后就会作废。这意味着，如果仅有发票这个工具，接收者将无法提供一个可重复使用的收款码。那么，我们该怎么解决这个问题呢？</p><p>（未完）</p><blockquote><p><em><a href=https://www.btcstudy.org/2024/02/27/lightning-network-technology-improvement-and-users-experience-part-4/ >续篇见此处</a></em></p></blockquote><h2 id=脚注><a href=#脚注 class=headerlink title=脚注></a>脚注</h2><p>1.<a id=note1> </a><a target=_blank rel=noopener href=https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-channel_announcement-message>https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-channel_announcement-message</a> <a href=#jump-1>↩</a></p><p>2.<a id=note2> </a><a target=_blank rel=noopener href=https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-channel_update-message>https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-channel_update-message</a> <a href=#jump-2>↩</a></p><p>3.<a id=note3> </a><a target=_blank rel=noopener href=https://github.com/lightning/bolts/blob/master/11-payment-encoding.md>https://github.com/lightning/bolts/blob/master/11-payment-encoding.md</a> <a href=#jump-3>↩</a></p><p>4.<a id=note4> </a><a target=_blank rel=noopener href=https://zh.wikipedia.org/zh-hans/%E6%88%B4%E5%85%8B%E6%96%AF%E7%89%B9%E6%8B%89%E7%AE%97%E6%B3%95>https://zh.wikipedia.org/zh-hans/%E6%88%B4%E5%85%8B%E6%96%AF%E7%89%B9%E6%8B%89%E7%AE%97%E6%B3%95</a> <a href=#jump-4>↩</a></p><p>5.<a id=note5> </a><a target=_blank rel=noopener href=https://docs.lightning.engineering/the-lightning-network/pathfinding/finding-routes-in-the-lightning-network>https://docs.lightning.engineering/the-lightning-network/pathfinding/finding-routes-in-the-lightning-network</a> <a href=#jump-5>↩</a></p><p>6.<a id=note6> </a><a target=_blank rel=noopener href=https://medium.com/@rusty_lightning/routing-dijkstra-bellman-ford-and-bfg-7715840f004>https://medium.com/@rusty_lightning/routing-dijkstra-bellman-ford-and-bfg-7715840f004</a> <a href=#jump-6>↩</a></p><p>7.<a id=note7> </a><a target=_blank rel=noopener href=https://bitcoin.stackexchange.com/questions/89542/single-hop-payment-vs-multi-hop-payments>https://bitcoin.stackexchange.com/questions/89542/single-hop-payment-vs-multi-hop-payments</a> <a href=#jump-7>↩</a></p><p>8.<a id=note8> </a><a href=https://www.btcstudy.org/2023/05/18/what-is-onion-routing-how-does-it-work/ >https://www.btcstudy.org/2023/05/18/what-is-onion-routing-how-does-it-work/</a> <a href=#jump-8>↩</a></p><p>9.<a id=note9> </a><a href=https://www.btcstudy.org/2022/03/29/outsourcing-route-computation-with-trampoline-payments/ >https://www.btcstudy.org/2022/03/29/outsourcing-route-computation-with-trampoline-payments/</a> <a href=#jump-9>↩</a></p><p>10.<a id=note10> </a><a target=_blank rel=noopener href=https://bitcoinops.org/en/topics/trampoline-payments/ >https://bitcoinops.org/en/topics/trampoline-payments/</a> <a href=#jump-10>↩</a></p><p>11.<a id=note11> </a><a href=https://www.btcstudy.org/2023/03/10/route-blinding-proposal-by-bastien-teinturier/ >https://www.btcstudy.org/2023/03/10/route-blinding-proposal-by-bastien-teinturier/</a> <a href=#jump-11>↩</a></p><p>12.<a id=note12> </a><a target=_blank rel=noopener href=https://bitcoinops.org/en/newsletters/2023/04/05/#bolts-765>https://bitcoinops.org/en/newsletters/2023/04/05/#bolts-765</a> <a href=#jump-12>↩</a></p><p>13.<a id=note13> </a><a target=_blank rel=noopener href=https://bitcoinops.org/zh/newsletters/2024/01/31/#eclair-2811>https://bitcoinops.org/zh/newsletters/2024/01/31/#eclair-2811</a> <a href=#jump-13>↩</a></p></article></div></div></main><script src="/js/post.js?v=1682773100887"></script><script src="/js/highlight.min.js?v=1682773100887"></script><script>var containerEl=document.querySelector(".post-container"),postFontSize=localStorage.getItem("post-font-size")||"16",inputEl=document.querySelector("#size-change-input"),inputEl2=document.querySelector("#size-change-input2");inputEl.value=postFontSize,inputEl2.value=postFontSize,containerEl.style.fontSize=postFontSize+"px",$(function(){function e(t){$(".post-container").css("font-size",t+"px"),localStorage.setItem("post-font-size",t),$("#size-change-input").val(t),$("#size-change-input2").val(t)}$("#size-change-input").on("input propertychange",function(t){e(t.target.value)}),$("#size-change-input2").on("input propertychange",function(t){e(t.target.value)})})</script><script>hljs.initHighlightingOnLoad()</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class=sns-container><a title=nostr target=_blank rel="noopener nofollow" href=https://iris.to/npub1g2qs0ca5kpwlrcfug2em4jelmh65clk3yccwjxrs6hvdpd9qj80q022j4m>Nostr</a><a title=rss target=_blank rel="noopener nofollow" href=/atom.xml>rss</a><a title=telegram target=_blank rel="noopener nofollow" href=//t.me/btcstudyorg>Telegram</a></section></footer><script async src="/js/buttons.js?v=1682773100887"></script><script async src="/js/index.js?v=1682773100887"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JVCJ9XXG1Z")</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306",e.async=!0,e.defer=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script></body></html>