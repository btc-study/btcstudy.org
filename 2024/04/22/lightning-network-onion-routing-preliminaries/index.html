<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><title>闪电网络中的洋葱路由：概要描述</title><meta name=keywords content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name=description content=比特币思想的中文集结地><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1"><link rel=icon href=/favicon.ico><link rel=stylesheet href="/style/common/bulma.css?v=1682773100887"><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href="/style/common/iconfont.css?v=1682773100887"><link rel=stylesheet href="/style/base.css?v=1682773100887"><link rel=stylesheet href="/style/common/helper.css?v=1682773100887"><link rel=stylesheet href="/style/themes/animation.css?v=1682773100887"><script>function ready(){var e=document.querySelector(".body-container"),t=localStorage.getItem("theme")||"light";["light","dark"].includes(t)||(t="light",localStorage.setItem("theme","light")),e.classList.remove("appearance-auto"),e.classList.add("appearance-"+t),quickInitialTheme()}function quickInitialTheme(){var e=localStorage.getItem("theme")||"light",t=document.querySelector(".logo-light"),o=document.querySelector(".logo-dark"),d=document.querySelector("#mobile-header-logo > .logo-light"),l=document.querySelector("#mobile-header-logo > .logo-dark"),a=document.getElementById("theme-btn"),i=document.querySelector(".slide-theme-light"),c=document.querySelector(".slide-theme-dark");document.body.classList.add(e),("dark"===e?(t.classList.add("hidden"),o.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden"),a.classList.remove("icon-icon_dark"),a.classList.add("icon-icon_light"),i):c).classList.remove("hidden")}document.addEventListener("DOMContentLoaded",ready)</script><script src="/js/common.js?v=1682773100887"></script><script src=/js/libs/zepto.min.js></script><link rel=stylesheet href="/style/post.css?v=1682773100887"><link rel=stylesheet href="/style/themes/highlight.css?v=1682773100887"><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title="BTC Study" type=application/atom+xml></head><body class="is-flex is-flex-direction-column" onload=initialTheme()><div class=clip></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id=header><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href=/ ><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id=header-menu><a class="is-inline-block header-activity mr-4" href=/ >首页</a><a class="is-inline-block mr-4" href=/archives>全站目录</a><a class="is-inline-block mr-4" href=/tags>标签</a><a class="is-inline-block mr-4" href=/maps>地图</a><a class="is-inline-block mr-4" href=/mempool>mempool</a><a class="is-inline-block mr-4" target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input type=range min=12 max=32 step=2></div></div></div><i class="iconfont icon-icon_dark mr-1" id=theme-btn></i><div class=search-wrap><input class=pl-3 id=search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search" id=search-input-btn></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopic><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">闪电网络中的洋葱路由：概要描述</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn2></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input2 type=range min=12 max=32 step=2></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id=mobile-header><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id=mobile-header-logo><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopicMobile><p class=is-full-height>闪电网络中的洋葱路由：概要描述</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class=mobile-search-wrap><div class=search-input><input class=pl-3 id=mobile-search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class=mobile-search-input-btn>搜 索</button></div></div></header><div class=mobile-slide-menu><a class=header-activity href=/ >首页</a><a href=/archives>全站目录</a><a href=/tags>标签</a><a href=/maps>地图</a><a href=/mempool>mempool</a><a target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class=slide-menu-fontsize><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1682773100887"></script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-text>概述</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%AE%BE%E5%AE%9A%E8%83%8C%E6%99%AF><span class=toc-text>设定背景</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%89%BE%E5%87%BA%E4%B8%80%E6%9D%A1%E8%B7%AF%E5%BE%84><span class=toc-text>找出一条路径</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B7%AF%E5%BE%84-1><span class=toc-text>路径 1</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B7%AF%E5%BE%84-2><span class=toc-text>路径 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%80%90%E8%B7%B3%E8%BD%BD%E8%8D%B7><span class=toc-text>逐跳载荷</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%B2%97%E7%B3%99%E7%9A%84%E6%B4%8B%E8%91%B1%E5%8C%85%E8%A3%B9%E6%9E%84%E9%80%A0><span class=toc-text>粗糙的洋葱包裹构造</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E-CLTV-%E5%88%B0%E6%9C%9F%E6%97%B6%E9%97%B4%E5%B7%AE%E5%80%BC%E7%9A%84%E6%B3%A8%E9%87%8A><span class=toc-text>一个关于 CLTV 到期时间差值的注释</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A5%96%E5%8A%B1%E7%8E%AF%E8%8A%82%EF%BC%9A%E9%80%90%E8%B7%B3%E6%8F%90%E7%A4%BA><span class=toc-text>奖励环节：逐跳提示</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BB%93%E8%AE%BA><span class=toc-text>结论</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id=postTitle>闪电网络中的洋葱路由：概要描述</h1><div class=page-author><div class="is-flex is-flex-direction-row page-data mr-6"><img class=mr-1 src=/images/default_avatar.png alt="Elle Mouton"><div class=page-author-info><strong>Elle Mouton</strong><time class=has-text-grey datetime=2024-04-22T10:34:41.000Z>2024-04-22</time></div></div><div class=is-flex><a href=/tags/%E9%97%AA%E7%94%B5%E7%BD%91%E7%BB%9C><i class="page-tag mr-1 px-1">闪电网络</i></a></div></div><article class="mt-4 post-content"><blockquote><p><em>作者：Elle Mouton</em></p><p><em>来源：<a target=_blank rel=noopener href=https://ellemouton.com/posts/onion-routing-prelims/ >https://ellemouton.com/posts/onion-routing-prelims/</a></em></p></blockquote><p><img src=/images/lightning-network-onion-routing-preliminaries/cover.png alt=img></p><h2 id=概述><a href=#概述 class=headerlink title=概述></a>概述</h2><p>本文会介绍你在理解闪电网络中的转发支付流程时应该具备的背景知识，也会为<a target=_blank rel=noopener href=https://ellemouton.com/posts/sphinx>下一篇文章</a>所要介绍的 “Sphinx 消息包” 构造设定背景。具体来说，我们要回答一些基础问题，比如：“在一个节点要发起一笔支付时，它是如何找出到达目标节点的路径的？如何告诉这路径上的每一个节点他们要干什么？”</p><p>读完这篇文章，你应该能够理解：为了构造一条路径，发送者需要哪些信息；路径上的每一个节点必须要知道哪些信息，以及这些信息是如何传递给他们的。关于最后一点，本文会介绍一种初步的、粗糙的方法，为你理解 Sphinx 消息包构造的必要性打下基础。</p><p>跟往常一样，我会在整篇文章中使用同一个例子。</p><h2 id=设定背景><a href=#设定背景 class=headerlink title=设定背景></a>设定背景</h2><p>这是 Alice 和 Dave，他们是闪电网络中的两个节点（别着急，Bob 在后面会出现的，但今天轮到 Dave 先出场）。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/nd-dave.png alt=img></p><p>Alice 希望给 Dave 支付咖啡钱，所以 Dave 生成了一张发票，并使用一个 QR 码展示给 Alice 看。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/invoice.png alt=img></p><p>如你所见，这张发票里面有一些有用的信息：</p><ul><li><code>amount</code>（数额）：Dave 希望在冲泡咖啡之前从 Alice 处收到的款项的大小，以 “毫聪（千分之一聪）” 为单位。</li><li><code>payment_hash</code>（支付哈希值）：即将用来构造 HTLC（哈希时间锁）的哈希值。</li><li><code>memo</code>（备忘）：一个简短的、人眼可读的描述，关于这笔支付的目的。</li><li><code>payee_pub_key</code>（接收者公钥）：正是 Dave 曾经在自己的 <code>node_announcement</code>（节点宣告）消息中宣布的公钥。</li><li><code>min_final_cltv_expiry_delta</code>（CLTV 最终到期时间下限）：这个数值定义了 Dave 希望得到的能够安全申领 HTLC 资金的时间（也可以用区块数量来度量）。在下文中，该数值的意义会变得更加清楚。</li></ul><h2 id=找出一条路径><a href=#找出一条路径 class=headerlink title=找出一条路径></a>找出一条路径</h2><p>得到发票之后，Alice 离成功支付就只有一步之遥了。发票中的 <code>payee_pub_key</code> 告诉了 Alice 如何在网络中找到 Dave。<a target=_blank rel=noopener href=https://ellemouton.com/posts/open_channel_pre_taproot>记住</a>，Alice 需要收集一定数量的节点和通道的宣告，才能在本地构造出网络的图谱。（假设 Alice 已经有了这样的图谱，那么）现在，Alice 只需在网络中找出 Dave，然后找出通向 Dave 的（由通道连成的）路径。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/3-graph.png alt=img></p><p>上图展示了 Alice 所看到的网络，以及 Dave 在这个网络中的位置。Alice 除了会收到节点和通道的宣告，还会收到来自这些节点为自己所拥有的通道而发出的 <code>channel_update</code>（通道更新）信息。这种消息包含了相关节点将要使用的转发策略的信息，如果其它节点要使用它们的通道来转发支付，就必须遵循这些转发策略。每一条 <code>channel_update</code> 都包含了下列信息：</p><ul><li><code>channel_ID</code>（通道标识符）：指出与本次更新相关的通道。</li><li><code>fee_base_msat</code>（基础手续费）：该节点要向过路的每一笔支付收取的手续费（单位是毫聪），不了支付额有多大。</li><li><code>fee_proportional_millionths</code>（比例手续费）：就是大家所说的 “手续费率”，要向通过该通道的每一笔支付按支付额收取的手续费，每 100 万聪收取 x 聪。</li><li><code>cltv_expiry_delta</code>（CLTV 到期时间差值）：该节点所要求的入账 HTLC 的 CLTV（绝对时间锁）与出账 HTLC 的 CLTV 的到期时间差值（详情见后文）。</li></ul><p>这是 Alice 的视野的更新版本，展示了她所拥有的关于图上每一条通道的 <code>channel_update</code> 信息。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/updates.png alt=img></p><p>如果我们把当前的目标缩小到给 Dave 支付，我们可以将这个图稍微简化，简化到只展示相关的数据。我们只关心 Alice 和 Dave 之间可能路径上的通道，并且只关心可能要用到其出账方向通道的节点的 <code>channel_update</code> 信息。比如说，Bob 和 Charlie 都为通道 <code>BC</code> 广播了 <code>channel_update</code> 消息，但因为 Alice 只关心从 Bob 到 Charlie 这一个方向，所以只需要看 Bob 的 <code>channel_update</code> 信息就够了，因为这部分信息才跟出账方向有关。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/choices.png alt=img></p><p>上图展示了从 Alice 到 Dave 的两条路径：</p><pre><code>1. Alice -&gt; Bob -&gt; Charlie -&gt; Dave，经过通道 AB、BC 和 CD
2. Alice -&gt; Eve -&gt; Charlie -&gt; Dave，经过通道 AE、EC 和 CD
</code></pre><p>如果 Alice 够聪明，她会选择尽可能少付手续费的路径。所以，我们作一些计算，来决定到底那条路径的成本效率更高。</p><h3 id=路径-1><a href=#路径-1 class=headerlink title="路径 1"></a>路径 1</h3><p>要计算一条路径的总手续费，我们需要从目标节点开始往后追溯。</p><ul><li><p>我们知道，Dave 要收到 499 9999 毫聪（他在发票里就是这么说的），这就是我们要通过 Charlie 来转发的聪的数量。所以，支付给 Charlie 的手续费数额应该要这么计算：</p><pre><code>= Charlie 的基础手续费 + Charlie 的比例手续费，后面这部分是：费率数值/1000000 * (通过 Charlie 转发的数额)
= 100 + 1000/1000000(4999999)  
= 100 + 4999999000/1000000
= 100 + 4999.999
= 5099.99
~ 5100
</code></pre><p>那么，应该发送给 Charlie 的数额应该是：</p><pre><code>= 4999999 + 5100 = 5005099 
= 5005099 msats
</code></pre></li><li><p>5005099 是需要通过 Bob 来路由的数额，所以应该支付给 Bob 的手续费是：</p><pre><code>= 200 + 2000/1000000(5005099)
= 200 + 2/1000(5005099)
= 10211
</code></pre><p>所以应该发送给 Bob 的数额是：</p><pre><code>= 5005099 + 10211
= 5015310
</code></pre><p>这意味着，在通过这条路径发送支付时，要付出的手续费是：</p><pre><code>= 5015310 - 4999999 
= 15311 msats
</code></pre></li></ul><h3 id=路径-2><a href=#路径-2 class=headerlink title="路径 2"></a>路径 2</h3><p>选择路径 2，也要运行相同的计算。</p><ul><li><p>Charlie 的部分是一样的：他要收到总计 500 5099 毫聪。</p></li><li><p>然后我们计算要给 Eve 支付多少钱：</p><pre><code>= 300 + 3000/1000000(5005099)
= 300 + 3/1000(5005099)
= 15316 msats
</code></pre><p>所以，要支付给 Eve 的总额是：</p><pre><code>= 5005099 + 15316
= 5020415 msats
</code></pre><p>即，Alice 要支付的总手续费是：</p><pre><code>5020415-4999999 = 20416 msats
</code></pre></li></ul><p>所以，胜出者是：路径 1 ！现在，我们只需要关心以下信息了：</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/6-path1.png alt=img></p><h2 id=逐跳载荷><a href=#逐跳载荷 class=headerlink title=逐跳载荷></a>逐跳载荷</h2><p>现在，Alice 拥有了足够多的信息，知道自己要向路径上的每一 “跳（hop）” 告知哪些信息了。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/7-last-hop-info.png alt=img></p><p>Alice 希望 Dave 能在 <code>CD</code> 通道中收到来自 Charlie 的一条 <code>update_add_htlc</code> 消息。而且这条消息中的 <code>payment_hash</code> 应该跟 Dave 的发票中指定的一致；而且，消息中的 <code>amount_msat</code> 应该是 499 9999，也跟发票所指定的一致。然后，Alice 也要检查当前的区块高度（现在是 1001），并使用发票中的 <code>min_final_cltv_expiry_delta</code> 数值（9）来计算 Charlie 的出账 HTLC 的 CLTV 数值应该是 1010（1001 + 9）。</p><p>使用我们前面已经讲过的手续费计算器，Alice 便可以确定 Bob-Charlie 和 Alice-Bob 通道中的 <code>update_add_htlc</code> 消息应该是什么样。如果你看到下图中从右到左各个 HTLC 的 CLTV 数值是递增的，会感到困惑，那么请看<a target=_blank rel=noopener href=https://ellemouton.com/posts/onion-routing-prelims/#a-note-on-cltv-deltas>文末的这个注释</a>。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/op-info.png alt=img></p><p>那么，剩下的谜团就只有一个了：如果 Alice 只跟 Bob 有联系，她怎么告诉 Charlie 如何给 Dave 路由呢？这就是 <code>update_add_htlc</code> 消息要用到 <code>onion_routing_packet</code>（洋葱路由消息包）的地方了。Alice 把她要告诉各个节点的信息打包在一起；并且，实际上，是用给上一跳的信息载荷来封装给下一跳的信息载荷。看下图会清楚一些：</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/on-info.png alt=img></p><p>所以，当 Bob 拿到来自 Alice 的消息时，同时也就拿到了应该转发给 Charlie 的包裹。Charlie 打开这个包裹、读到对自己有意义的数据时，也同时得到了应该转发给 Dave 的载荷。Dave 得到这个属于他的载荷，就会知道自己是这条路径的最后一个节点。这时候，Dave 会检查他是否拥有这个入账支付哈希值的原像。注意，这就是 “洋葱” 这个形象的由来：每一跳都会得到一个数据包，每一跳都只能剥开一层。</p><h2 id=粗糙的洋葱包裹构造><a href=#粗糙的洋葱包裹构造 class=headerlink title=粗糙的洋葱包裹构造></a>粗糙的洋葱包裹构造</h2><p>我们再花一点时间来想象一下洋葱包裹实际长什么样。请注意，这 <em>并不是</em> 最终的形态。我在这里知识提出一种可能的构造，然后我会解释为什么这不是最终付诸实践的方式。最终形态会在我的<a target=_blank rel=noopener href=https://ellemouton.com/posts/sphinx>下一篇文章</a>中解释。</p><p>假设 Alice 已经知道了自己要告诉每一跳什么信息。这些信息叫做 “逐跳载荷”。她将这些信息全部打包在了一起、发给了 Bob：</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/bob-pkt.png alt=img></p><p>这个包裹由这些部分组成：</p><ul><li>长度为 1 字节的包裹版本号</li><li>Alice 的公钥</li><li>给每一跳的载荷。注意，每一段载荷都有一个 HMAC（基于哈希函数的消息认证码），需要由收到它的一跳转发给下一跳（我们后面会看到它的作用）。</li><li>最后，是一个由 Alice 使用自己的公钥，对这个包裹的载荷生成的 HMAC。</li></ul><p>（什么是 “基于哈希函数的信息认证码”？在下一篇文章中我会好好解释，但眼下，你只需要把它理解成一种用来验证一个载荷的完整性的数字签名。）</p><p>Bob 收到这个包裹后，会执行下列操作：</p><ol><li>检查 HMAC 是有效的（换句话来说，他要检查这个包裹没有被人篡改过）。</li><li>他要阅读为他准备的载荷，以及 HMAC。</li><li>然后，他重新构造一个包裹，并传给 Charlie。他会为这个包裹加上由 Alice交给他的 HMAC，因为他自己没法产生这个 HMAC。</li></ol><p><img src=/../images/lightning-network-onion-routing-preliminaries/lie-pkt.png alt=img></p><p>Charlie 收到这个包裹之后，会执行下列操作：</p><ol><li>检查 HMAC 是有效的。</li><li>他要阅读为他准备的载荷，以及 HMAC。</li><li>然后，他重新构造一个包裹，并传给 Charlie。他会为这个包裹加上由 Alice交给他的 HMAC，因为他自己没法产生这个 HMAC。</li></ol><p><img src=/../images/lightning-network-onion-routing-preliminaries/ave-pkt.png alt=img></p><p>Dave 收到这个包裹之后，会执行下列操作：</p><ol><li>他会检查这个 HMAC 是有效的。</li><li>他会阅读为他准备的载荷，以及 HMAC。</li><li>他所得到的 HMAC 会是一个空的字节数组。这向 Dave 表明，他就是最后一跳。</li></ol><p>那么，这个构造有什么问题呢？</p><ul><li>每一跳都可以读到给后续每一跳的载荷。这将泄露最终的接收者。</li><li>每一跳都被告知 Alice 的公钥，因此每一跳都知道谁是发送者。</li><li>即使每一段载荷都是加密的，包裹也会随着递送的次数增加而逐渐变小，让中间节点能够基于包裹的体积猜测自己离最终的接收者还有多远。</li></ul><p>换句话说，这隐私性很糟。绝对不可以这样做！所以我们要使用 Sphinx 包裹构造！有了 Sphinx 包裹：</p><ul><li>每一段载荷都是加密过的，所以只能被目标节点解密。</li><li>发送者不会分享自己的真实公钥，而是为每一跳使用一个不同的临时公钥。</li><li>每一跳收到的包裹都是相同的体积。</li></ul><p>下一篇文章见！</p><h2 id=一个关于-CLTV-到期时间差值的注释><a href=#一个关于-CLTV-到期时间差值的注释 class=headerlink title="一个关于 CLTV 到期时间差值的注释"></a>一个关于 CLTV 到期时间差值的注释</h2><p>要想理解为什么节点要宣告 CLTV 到期时间差值、支付的发送者如何使用这个数值来确定给每一跳的 CLTV 数值，我们要先回顾一下一个 HTLC 的构造：</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/delta_1.png alt=img></p><p>上图展示了 Charlie 和 Dave 之间的 HTLC（根据本文的例子，这是整条路径上的最后一跳）。一个 HTLC 有两种可能的花费路径：原像路径，如果 Dave 能够提供对应于其中支付哈希值的原像，就能获得其中的资金；超时路径，让资金返回给 Charlie。超时路径要在 <code>CLTV A</code> 所定义的区块高度之后才能使用。假设当前的区块高度是 1001。如果 <code>CLTV A</code> 是 1002，那么有可能就在 Dave 要给出原像的时候，区块 1002 挖出，Charlie 抢先广播创建这个 HTLC 输出的交易并动用这个 HTLC 的超时路径，这样 Dave 就无法用原像路径来领取资金了。为了防止这种情形，Dave 需要一些时间，在超时路径能够动用之前好整以暇地使用原像路径。他在发送给 Alice 的发票中用 <code>min_final_cltv_expiry_delta</code> 字段表示自己要求的缓冲时间是 9 个区块。然后，Alice 就知道，如果她现在（正值区块高度 1001）就要给 Dave 发送支付，那么 Dave 会拒绝所有 <code>CLTV A</code> 数值小于 1010（1001 + 9）。</p><p>那么，再看看 Bob 和 Charlie 之间的 HTLC。现在我们希望搞清楚，Bob 与 Charlie 之间的 HTLC 的 CLTV 参数 <code>CLTV B</code> 应该设置成什么数值。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/delta_2.png alt=img></p><p>假设 Dave 一直拖到最后一刻，才向 Charlie 揭晓原像。也就是说，他一直拖到区块 1010 就要挖出的时候。Charlie 现在需要转过头来向 Bob 揭晓原像。如果 Bob 把这个 HTLC 提交上链，Charlie 也需要一些时间以使用原像分支，而不必担心 Bob 可以动用超时分支。Charlie 所要求的这个缓冲期（从 Dave 处收到原像，到向 Bob 揭晓原像）就是 Charlie 的 CLTV 到期时间差值。他会在自己的 <code>channel_update</code> 消息中公开，而且他预期 Alice 在构造支付路径时会使用这个数值。如果一笔支付来自 Bob，而 <code>CLTV B</code> 与 <code>CLTV A</code> 之间的差值小于 Charlie 所公开的差值，那么他会拒绝转发这笔支付。他要求 <code>CLTV B</code> 的数值大于等于 <code>CLTV A</code> 数值加上他公开过的 CLTV 差值。</p><h2 id=奖励环节：逐跳提示><a href=#奖励环节：逐跳提示 class=headerlink title=奖励环节：逐跳提示></a>奖励环节：逐跳提示</h2><p>这篇文章可以快速向你展示关于逐跳提示及其对寻路过程的影响，你应该知道的事情。</p><p>如果我们回到 Alice 基于所收到的 <code>channel_announcement</code> 建构出来的网络图，有可能 Alice 实际上并不知道 Charlie 和 Dave 之间的通道（即 <code>CD</code>）。这是因为这可能是一条私人通道，Charlie 和 Dave 并未向网络公开。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/ate-hop.png alt=img></p><p>这时候，Alice 就无法找出通往 Dave 的路径，除非 Dave 在发票中给 Alice 提供更多信息。Dave 可以提供的额外信息由一个或多个 “逐跳提示” 组成。这些提示需要弥补 Alice 已经从相关通道的 <code>channel_announcement</code> 和 <code>channel_update</code> 消息中知道的信息。包括 Charlie 的公钥、该通道的 SCID（短通道标识符），以及该通道的路由策略。</p><p><img src=/../images/lightning-network-onion-routing-preliminaries/op-hint.png alt=img></p><p>剩下的部分，就没有什么不同啦 : )</p><h2 id=结论><a href=#结论 class=headerlink title=结论></a>结论</h2><p>完成啦！我希望这篇文章能让一些事情更加清晰，你能够理解一个发送者要如何找出通往一个目标节点的路径，以及要给沿路的每一跳什么信息。在<a target=_blank rel=noopener href=https://ellemouton.com/posts/sphinx>下一篇文章</a>中，我们会深入了解携带逐跳载荷、力求最大化隐私性的洋葱包裹是如何构造的。</p><p>（完）</p></article></div></div></main><script src="/js/post.js?v=1682773100887"></script><script src="/js/highlight.min.js?v=1682773100887"></script><script>var containerEl=document.querySelector(".post-container"),postFontSize=localStorage.getItem("post-font-size")||"16",inputEl=document.querySelector("#size-change-input"),inputEl2=document.querySelector("#size-change-input2");inputEl.value=postFontSize,inputEl2.value=postFontSize,containerEl.style.fontSize=postFontSize+"px",$(function(){function e(t){$(".post-container").css("font-size",t+"px"),localStorage.setItem("post-font-size",t),$("#size-change-input").val(t),$("#size-change-input2").val(t)}$("#size-change-input").on("input propertychange",function(t){e(t.target.value)}),$("#size-change-input2").on("input propertychange",function(t){e(t.target.value)})})</script><script>hljs.initHighlightingOnLoad()</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class=sns-container><a title=nostr target=_blank rel="noopener nofollow" href=https://iris.to/npub1g2qs0ca5kpwlrcfug2em4jelmh65clk3yccwjxrs6hvdpd9qj80q022j4m>Nostr</a><a title=rss target=_blank rel="noopener nofollow" href=/atom.xml>rss</a><a title=telegram target=_blank rel="noopener nofollow" href=//t.me/btcstudyorg>Telegram</a></section></footer><script async src="/js/buttons.js?v=1682773100887"></script><script async src="/js/index.js?v=1682773100887"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JVCJ9XXG1Z")</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306",e.async=!0,e.defer=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script></body></html>