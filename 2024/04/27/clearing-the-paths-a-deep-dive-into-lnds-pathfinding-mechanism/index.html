<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><title>探明道路：深入 LND 的寻路机制</title><meta name=keywords content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name=description content=比特币思想的中文集结地><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1"><link rel=icon href=/favicon.ico><link rel=stylesheet href="/style/common/bulma.css?v=1682773100887"><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href="/style/common/iconfont.css?v=1682773100887"><link rel=stylesheet href="/style/base.css?v=1682773100887"><link rel=stylesheet href="/style/common/helper.css?v=1682773100887"><link rel=stylesheet href="/style/themes/animation.css?v=1682773100887"><script>function ready(){var e=document.querySelector(".body-container"),t=localStorage.getItem("theme")||"light";["light","dark"].includes(t)||(t="light",localStorage.setItem("theme","light")),e.classList.remove("appearance-auto"),e.classList.add("appearance-"+t),quickInitialTheme()}function quickInitialTheme(){var e=localStorage.getItem("theme")||"light",t=document.querySelector(".logo-light"),o=document.querySelector(".logo-dark"),d=document.querySelector("#mobile-header-logo > .logo-light"),l=document.querySelector("#mobile-header-logo > .logo-dark"),a=document.getElementById("theme-btn"),i=document.querySelector(".slide-theme-light"),c=document.querySelector(".slide-theme-dark");document.body.classList.add(e),("dark"===e?(t.classList.add("hidden"),o.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden"),a.classList.remove("icon-icon_dark"),a.classList.add("icon-icon_light"),i):c).classList.remove("hidden")}document.addEventListener("DOMContentLoaded",ready)</script><script src="/js/common.js?v=1682773100887"></script><script src=/js/libs/zepto.min.js></script><link rel=stylesheet href="/style/post.css?v=1682773100887"><link rel=stylesheet href="/style/themes/highlight.css?v=1682773100887"><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title="BTC Study" type=application/atom+xml></head><body class="is-flex is-flex-direction-column" onload=initialTheme()><div class=clip></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id=header><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href=/ ><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id=header-menu><a class="is-inline-block header-activity mr-4" href=/ >首页</a><a class="is-inline-block mr-4" href=/archives>全站目录</a><a class="is-inline-block mr-4" href=/tags>标签</a><a class="is-inline-block mr-4" href=/maps>地图</a><a class="is-inline-block mr-4" href=/tools>工具</a><a class="is-inline-block mr-4" target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input type=range min=12 max=32 step=2></div></div></div><i class="iconfont icon-icon_dark mr-1" id=theme-btn></i><div class=search-wrap><input class=pl-3 id=search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search" id=search-input-btn></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopic><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">探明道路：深入 LND 的寻路机制</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn2></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input2 type=range min=12 max=32 step=2></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id=mobile-header><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id=mobile-header-logo><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopicMobile><p class=is-full-height>探明道路：深入 LND 的寻路机制</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class=mobile-search-wrap><div class=search-input><input class=pl-3 id=mobile-search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class=mobile-search-input-btn>搜 索</button></div></div></header><div class=mobile-slide-menu><a class=header-activity href=/ >首页</a><a href=/archives>全站目录</a><a href=/tags>标签</a><a href=/maps>地图</a><a href=/tools>工具</a><a target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class=slide-menu-fontsize><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1682773100887"></script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8F%91%E8%B5%B7%E6%94%AF%E4%BB%98%E7%9A%84%E5%89%8D%E6%8F%90><span class=toc-text>发起支付的前提</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#LND-%E4%B8%AD%E7%9A%84%E6%94%AF%E4%BB%98%E8%AF%95%E9%94%99%E5%BE%AA%E7%8E%AF><span class=toc-text>LND 中的支付试错循环</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%AF%BB%E8%B7%AF><span class=toc-text>寻路</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A6%82%E7%8E%87-%E6%89%8B%E7%BB%AD%E8%B4%B9-%E5%8F%96%E8%88%8D><span class=toc-text>概率&#x2F;手续费 取舍</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A6%82%E7%8E%87%E6%80%A7%E4%BC%B0%E8%AE%A1%EF%BC%9A%E4%B8%80%E7%A7%8D-%E5%85%88%E9%AA%8C-%E6%A8%A1%E5%9E%8B><span class=toc-text>概率性估计：一种 先验 模型</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BB%93%E8%AE%BA><span class=toc-text>结论</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id=postTitle>探明道路：深入 LND 的寻路机制</h1><div class=page-author><div class="is-flex is-flex-direction-row page-data mr-6"><img class=mr-1 src=/images/default_avatar.png alt=Bitromortac><div class=page-author-info><strong>Bitromortac</strong><time class=has-text-grey datetime=2024-04-27T00:26:44.000Z>2024-04-27</time></div></div><div class=is-flex><a href=/tags/%E5%BC%80%E5%8F%91><i class="page-tag mr-1 px-1">开发</i></a></div></div><article class="mt-4 post-content"><blockquote><p><em>作者：Bitromortac</em></p><p><em>来源：<a target=_blank rel=noopener href=https://lightning.engineering/posts/2024-04-11-pathfinding-1/ >https://lightning.engineering/posts/2024-04-11-pathfinding-1/</a></em></p></blockquote><p>闪电网络的承诺是让比特币支付能够得到近乎瞬时的结算。但是，以自治的方式实现这个目标构成了持续的技术挑战，主因是通道余额的不透明，但这也是内化于闪电网络的设计的。在本文中，我们会深入了解闪电网络中的寻路程序（在更广泛的意义上，是支付的规划），尤其是 LND 客户端中的相关实现。我们将讨论现有的、让支付更加可靠的技术，深入解释 LND 如何确定通道的性能，并探索近期的进展，包括一种新增的概率性估算器。</p><p><img src=/images/clearing-the-paths-a-deep-dive-into-lnds-pathfinding-mechanism/banner.png alt="LND payment loop"></p><p style=text-align:center>- 图 1. 理清围绕寻路的概念 -</p><h2 id=发起支付的前提><a href=#发起支付的前提 class=headerlink title=发起支付的前提></a>发起支付的前提</h2><p>闪电网络上的支付，在使用时给人的感觉是几乎瞬时完成的，但表象之下，一笔支付的处理涉及许许多多的东西。为了在闪电网络上发起一笔多跳支付，我们大体上要满足两个前提：</p><ol><li>我们需要得到一张 “发票（invoice）”，以辨明这一支付的 <em>接收者</em></li><li>我们需要一个完全同步的网络拓扑图视角，以详细地了解 <em>如何</em> 将支付从发送者路由到接收者</li></ol><p>第一个前提可以很容易通过发送者和接收者在支付时候的私下通信（out-of-band communication）得到满足。但第二个前提就更加复杂。</p><p>参与闪电网络的节点通过点对点的 gossip 消息来获得网络拓扑信息（也叫 “网络图谱”）。这些消息包括基本的元数据，比如关于通道容量的信息（通过通道 id 间接获得）、关于 HTLC（哈希时间锁合约）的约束（比如其面额的下限或上限）。这些消息还包括一个通道是否已被标记为不可用，以及每个路由者在转发支付时要收取多少手续费。虽然这些消息都是单个单个传输的，但两个对等节点之间可能同时存在多条通道，需要宣告不同的通道约束。在寻路时，支付者的节点需要将这些平行的通道虚拟成一条边，以便估计最糟糕情况下的约束（例如，要被收取的最大手续费率，或者最大的时间锁差值）。通过这些平行的通道来转发支付的路由节点可以自由选择其中任意一条通道，这叫做 “非严格转发”。这是第一个提高路由可靠性的重要步骤。</p><p>存在能够在需要的地方提供流动性的良好路由节点，结合能够找到流动性的智能的寻路算法，支付可以更加可靠。理想情况下，基于过往的支付经验以及 gossip 图谱提供的所有信号，规划好的支付应该能够一次尝试就成功。但是，路由节点在各自的动作中并不总是具有完美的效率，这也是为什么我们要预料到通道因缺乏流动性而无法转发的情形。因此，发送支付的程序需要试错的循环。而且，一笔闪电支付不仅可以沿着一条路径转发，还可以分割成多个部分（沿着不完全相同的多条路径转发）。</p><h2 id=LND-中的支付试错循环><a href=#LND-中的支付试错循环 class=headerlink title="LND 中的支付试错循环"></a>LND 中的支付试错循环</h2><p>本节会简要介绍在 LND 中一笔支付的生命历程。为了启动支付流程，支付方用户需要向 LND 软件传入由接收者生成的发票；发票也可能携带额外的、可以补充网络图谱的信息，例如可选的中间节点提示，可以用来知晓如何走完触达接收者的 “最后一公里”。支付规划也需要知道支付的数额以及接收者节点所指出的协议特性（例如是否支持多路径支付），这些也都包含在发票里面。这时候，我们就可以进入下图所示的支付试错循环了：</p><p><img src=/../images/clearing-the-paths-a-deep-dive-into-lnds-pathfinding-mechanism/nt_loop.png alt="LND payment loop"></p><p style=text-align:center>- 图 2. LND 中的支付试错循环流程图 -</p><p>我们首先要检查支付的状态，这表示一笔支付要发起了，但尚未发起任何尝试，因此我们可以发送新的 HTLC 尝试。然后，我们计算出一条路径及其总支付额（寻路的细节见下文），然后沿着路径，在选定的通道上按方向发送支付。这时候，这次尝试的命运就已经不在我们控制之中了，这笔支付现在 <em>正在飞行</em>。这时候我们也不会允许新的尝试，因为总支付额已处于待定状态，我们需要等待对等节点要求结算或表示失败。</p><p>最常见的失败原因是 <em>临时的通道故障</em>，表明这条路径上的某一些通道缺乏流动性。别的原因包括某一个中间节点下线了，或者支付给某个节点的手续费不够。这都是有价值的信息，我们可以用来优化我们的下一次路径选择。我们通过求解哪一个节点开始汇报错误，来了解这条路径的通畅部分和不通畅的部分。这个信息会被记录在叫做 “<a target=_blank rel=noopener href=https://github.com/lightningnetwork/lnd/blob/7d74165296116c14a2bf569ba158e8286f50c0f0/routing/missioncontrol.go#L81-L90>任务控制中心</a>” 的程序中，它会跟踪 成功&#x2F;不成功 送达的数额，以及它们的时间戳。</p><p>如果尝试失败，整个循环会在考量由任务控制中心提供的流动性信息之后、使用新选择的路径继续尝试，直至要么支付成功，要么预估的成功几率下降到某个阈值以下（这一点我们后面细说）。这就是我们要使用多路径支付的时候了。为了增加再一次尝试的成功几率，我们要把支付额分成几个较小额的部分。支付额的分割策略还在持续进步，而支付的可靠性可以通过向协议增加冗余的超额支付来进一步强化（在<a target=_blank rel=noopener href=https://github.com/renepickhardt/Maximum-Expected-Value-Flows-For-Redundant-Overpayments/ >这里</a>可以看到早期的概念研究）。LND 当前采用分治（divide and conquer）方案，不断将剩余的支付额分成两半。然后，这些部分会同时送出，然后我们等待它们同时结算或者超时。</p><h2 id=寻路><a href=#寻路 class=headerlink title=寻路></a>寻路</h2><p>迄今为之，我们还没触及如何评估及发现合适的路径。给定一个支付额以及目的地，我们如何选出一条可靠又便宜的路径？事实证明，这个问题的设计空间非常大，而且也会产生取舍。</p><p>因为多路径支付，从数学上来说，发送一笔闪电支付的根本问题就不是找出一条路径，而是找出一片路网（汇集了多条路径），并且还具有期望中的低机会成本和手续费成本。不过，我们前面也提到，LND 当前使用分治分割策略，以迭代式地找到一片路网，这又将问题回归到了使用 “<a target=_blank rel=noopener href="https://en.wikipedia.org/wiki/Dijkstra's_algorithm">戴氏最短路径算法</a>” 找出一条又一条的路径。</p><p>戴氏算法是一种广度优先搜索算法，它会用一个优先级队列来跟踪网络中的节点的 “距离”，就像用水波来探索一个被水淹没的迷宫。这个 “距离” 扮演着重要的角色，并且是用多个元素的组合估算出来的。它最终会用路径的累计手续费单位来表达，但这应该被视作一个（我们希望尽可能小）虚拟的手续费，以便作为一种线索，在真实的路由手续费和路径的特定属性之间取舍。</p><p>寻路的这个侧面具备最大的研究空间。更准确地说，除了基础手续费和比例手续费，HTLC 的锁定时间和其它开销会有利于（或有害于）更长或更短的路径，乃至节点的响应时间、声誉和物理距离，也可以考虑进来。所有这些因素都可能影响送达一笔支付所需的时间。</p><h2 id=概率-手续费-取舍><a href=#概率-手续费-取舍 class=headerlink title="概率&#x2F;手续费 取舍"></a>概率&#x2F;手续费 取舍</h2><p>前面两个问题的答案在于路径的成功率估计。取舍手续费和机会成本的问题，就靠<a target=_blank rel=noopener href=https://github.com/lightningnetwork/lnd/blob/758ae6fbecfca6809bf6d51427717245c3c777db/routing/pathfind.go#L1047-L1079>这些参数</a>来回答。给定两条路径 $A$ 和 $B$ 的支付额相同、成功几率分别为 $P_A$ 和 $P_B$、路由费分别为 $F_A$ 和 $F_B$，我们可以求出两种情形的预期成本：（1）先尝试 $A$、再尝试 $B$；或（2）先尝试 $B$、再尝试 $A$。我们假定每次尝试失败都会产生一个恒定的机会成本 $O$。这个机会成本并不会真的变成手续费，但我们必须为此付出代价（比如我们要等待），这也是为什么我们认为它也是尝试的成本。</p><ul><li><p>先 A 后 B 的预期成本：</p><p>$$F_{AB} &#x3D; P_A * F_A + (1 - P_A) * P_B * (O + F_B) + (1 - P_A)(1 - P_B) * O$$</p></li><li><p>先 B 后 A 的预期成本：</p><p>$$F_{BA} &#x3D; P_B * F_B + (1 - P_B) * P_A * (O + F_A) + (1 - P_B)(1 - P_A) * O$$</p></li></ul><p>对比代价，假设 $F_{AB} &lt; F_{BA}$，一些代数运算可以得出不等式</p><p>$$F_A + O&#x2F;P_A &lt; F_B + O&#x2F;F_B$$</p><p>这表明了我们如何可以比较两条路径的虚拟费用，就是用 $O$ 乘以路径成功率的倒数：$F_{O}(P) &#x3D; O&#x2F;P$ 。</p><p>我们要重点强调，LND 在戴氏优先级队列中考虑总的 <em>路径</em> 成功率。另一种表示虚拟成功率代价的方式是 <em>跳数量</em> 的负对数成功率 $P_i$ 。如果一种算法要求提供各跳的权重，而非一个表示整条路径的参数，那么后面这种方法会更有优势，可以利用算法的乘法分解特性，得到各跳的参数：$log(1&#x2F;P) &#x3D; log(1&#x2F;\prod_{i}^{hops}P_i) &#x3D; - \sum_{i}^{hops}log(P_i)$ 。两种方法都会让总的路径成本依赖于单跳成功概率的的乘积：$P &#x3D; \prod_{i}^{hops}P_i$ 。</p><p>在当前的 LND 中，机会成本是由一个常量和一个取决于支付额 $x$ 的比例项决定的：</p><p>$$O(x) &#x3D; attempt_cost + attempt_cost_ppm * x$$</p><p>代价 $F_O(P)$ 的意思是：为了知晓一笔支付通过已经尝试过的路径以及另一条未知但可能更便宜的路径成功支付的概率差别，我们要多付多少钱？$O$ 是靠这两个参数计算出来的，它的数值越大，表示我们越倾向于前者（已经尝试过的路径），也即越珍视我们的时间。这个取舍暴露在 <a target=_blank rel=noopener href=https://github.com/lightningnetwork/lnd/blob/935e550da67b4df17d29c830c5ea66a02c84af3f/sample-lnd.conf#L1140-L1206>LND 的设定</a> <code>routerrpc.attemptcost</code> 和 <code>routerrpc.attemtpcostppm</code> 中。此外，在支付时，可以通过 <a target=_blank rel=noopener href=https://lightning.engineering/api-docs/api/lnd/lightning/query-routes><code>QueryRoutes</code></a> 和 <a target=_blank rel=noopener href=https://lightning.engineering/api-docs/api/lnd/router/send-payment-v2><code>SendPaymentV2</code></a> 中的时间偏好参数来调整。</p><p>这给了我们 LND 目前在用的最终路径距离度量，如下：</p><p>$$F_{path}(x) &#x3D; F_{fees}(x) + F_{locktime}(x) + F_{O(x)}(P(x))$$</p><p>注意，路由费项（$F_{fees}$）考虑 fees of fees，而总的 HTLC 锁定时间会被转化成一个虚拟的手续费（$F_{locktime}$），这个值又通过一个转换因子，跟支付额 $x$ 成正比。再次强调，使用 $F_O(P)$，我们可以表达我们对手续费和可靠性的偏好，从而平衡前两者的影响。</p><h2 id=概率性估计：一种-先验-模型><a href=#概率性估计：一种-先验-模型 class=headerlink title="概率性估计：一种 先验 模型"></a>概率性估计：一种 <em>先验</em> 模型</h2><p>LND 从 <a target=_blank rel=noopener href=https://github.com/lightningnetwork/lnd/pull/2802>2019</a> 年开始就将路径的成功概率纳入考量。在这一节中，我们要讨论概率是如何估算的。一种用于估算跳跃成功率、已经得到多轮优化的初步模型叫做 <em>priori</em> 模型（这是个拉丁词，表示最早的时候 —— 独立于任何经验），这是用在 LND 中的一个简单但高效的默认估算器。这个概念需要定义一个默认的跳跃成功概率，也就是 <em>先验</em> 的成功率（<code>apriori.hopprob</code> ），我们假设任何从没尝试过的通道和数额都是这个概率。当前其默认值是 60%，稍微偏向于假设会成功而非失败。这个 60% 的先验成功率只是一个假设，并不代表网络的真实情形，更多只是作为提供未知通道的基础机会成本的办法；成功的尝试可以降低这个机会成本的数值，从而倾向于选择这些路径（而非其它路径）。这给了我们一个非常简单的跳跃成功率 $P(x) &#x3D; 60%$，其中 $x$ 是要发送的数额。</p><p>回想一下，任务控制中心记录了以往在一定数额和一定跳数下的成功和失败案例，我们可以用来作出偏离于 <em>先验</em> 概率的明智决策。如果即将发送的数值低于曾经成功发送过的数值 $x_{success}$，<em>先验</em> 估算器会分配一个更高的跳跃成功率，这就给出了一个条件公式：</p><p>$$P(x|x_{success}, x_{fail}) &#x3D; \begin{cases}95%, &amp; x \le x_{success} \ 60%, &amp; else \ 0 \to 60%(time \quad decay), &amp; x \ge x_{fail} \end{cases}$$</p><p>如果某一跳无法路由某个数值 $x_{fail}$，它会被分配一个惩罚，就是降低其成功率，最低是 0，从而因为 1&#x2F;P 的关系产生出无穷大的成本，从而绕开这一跳。为了给这条通道一个机会，一定的指数回退时间（<code>apriori.penaltyhalflife</code>，默认为一个小时）之后，其 <em>先验</em> 成功率会复原。 这跟以前成功的跳相反，后者的成功率会保持在静态的 95% 。这应合了技术规范：应该再次尝试成功过的跳，直至遇上失败、证明其不可用。</p><p>为了给出一个例子，我们来对比三条路径，A、B 和 C，每条路径都有一个给定的手续费率和成功概率。我们忽略基础手续费、fees of fees、锁定时间以及基础尝试成本，以简化问题。路线的 A 的路由费率是 0 ppm（百万分之一），曾经失败过，现在的成功概率 $P_A &#x3D; 10%$ 。路线 B 的路由费率是 50 ppm，尚未尝试过，$P_B &#x3D; 60%$ 。路线 C 的费率是 100 ppm，曾经成功过，$P_C &#x3D; 10%$ 。我们假设一次尝试的代价是 1000 ppm，而支付的数额是 100 ksat。</p><p>总的虚拟手续费是 $F_{path}(x) &#x3D; x * fee_rate + x * attempt_cost_rate&#x2F;P_{path}$ 。因此</p><p>$$F_A &#x3D; 100 ksat * 0 ppm + 100 ksat * 1000 ppm&#x2F;10% &#x3D; 0 sat + 1000 sat &#x3D; 1000 sat$$</p><p>$$F_B &#x3D; 100 ksat * 100 ppm + 100 ksat * 1000 ppm&#x2F;60% &#x3D; 10 sat + 167 sat &#x3D; 177 sat$$</p><p>$$F_C &#x3D; 100 ksat * 300 ppm + 100 ksat * 1000 ppm&#x2F;95% &#x3D; 30 sat + 105 sat &#x3D; 135 sat$$</p><p>对比所有的路线，我们可以看出，我们应该再次尝试 C，因为其虚拟手续费较低，并且我们知道，相对于带有不确定性的新路线 B，C 的成功概率使之便宜了 42 聪。路线 A 则因为高机会成本而出局。</p><p>到目前为止，这样的 <em>先验</em> 模型有一个缺点：<em>先验</em> 概率独立于支付数额和通道容量。直觉上，你应该也同意，发送一笔更小的数额，应该有更高的成功率（相比要用到整个通道容量的大数额）。这个问题在最近一个 <a target=_blank rel=noopener href=https://github.com/lightningnetwork/lnd/pull/6857>PR</a> 中解决了。<em>先验</em> 概率通过乘以一个容量因子，变成容量独立的了：</p><p>$$P_{a priori}(x, c) &#x3D; 60%*(1 - \frac{0.5}{1 + exp[-(x-c_o(c))&#x2F;s_o(c)]})$$</p><p><img src=/../images/clearing-the-paths-a-deep-dive-into-lnds-pathfinding-mechanism/factor.png alt="capacity factor"></p><p style=text-align:center>- 图 3. 在容量为 10 Msat 的通道中，容量因子 P(x, c) 随支付额 x 的变化而变化 -</p><p>这个函数倾向于鼓励小数额，并在支付额逐渐趋近于一个定义好的分数 $c_o(c) &#x3D; c&#x2F;c_o$ 与通道容量的乘积时，大幅降低成功率；这个分数是由 <code>routerrpc.apriori.capacityfraction</code> 设定来控制的。一个涂抹变量 $s_o(c) &#x3D; c&#x2F;s_o$ 则影响成功率下降的速度（<a target=_blank rel=noopener href=https://www.desmos.com/calculator/89aiu9jien>看这个可以交互的样品</a>）。因此，将 <em>先验</em> 概率与这个因子相乘，将厌恶会用尽通道容量的路径。</p><h2 id=结论><a href=#结论 class=headerlink title=结论></a>结论</h2><p>这是寻路主题系列博客的第一篇，我们介绍了寻路的基本概念，从支付循环及其与路由计算的关系开始。我们深入探究了与路径选择有关的基本元素，并围绕支付成功率的一个简单表示、解决了平衡可靠性与手续费的挑战。这些研究引导我们通过考虑容量来提炼成功率，从而让一个简单的模型成为了一个更高级的模型 —— 使用更严格数学描述的模型。本文包含了来自许多影响了 LND 寻路程序开发的人的洞见和想法，一个不完整的清单是：<a target=_blank rel=noopener href=https://github.com/joostjager>Joost Jager</a>、<a target=_blank rel=noopener href=https://github.com/Roasbeef>Roasbeef</a>、<a target=_blank rel=noopener href=https://github.com/renepickhardt>Rene Pickhardt</a> 和 <a target=_blank rel=noopener href=https://github.com/yyforyongyu>yyforyongyu</a> 。非常感谢你们的贡献！敬请期待第二篇，我们会研究双模态寻路、概率估计以及 gossip 信号。</p></article></div></div></main><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],processEscapes:!0,skipTags:["script","noscript","style","textarea","pre","code"]}}),MathJax.Hub.Queue(function(){for(var a=MathJax.Hub.getAllJax(),e=0;e<a.length;e+=1)a[e].SourceElement().parentNode.className+=" has-jax"})</script><script src="/js/post.js?v=1682773100887"></script><script src="/js/highlight.min.js?v=1682773100887"></script><script>var containerEl=document.querySelector(".post-container"),postFontSize=localStorage.getItem("post-font-size")||"16",inputEl=document.querySelector("#size-change-input"),inputEl2=document.querySelector("#size-change-input2");inputEl.value=postFontSize,inputEl2.value=postFontSize,containerEl.style.fontSize=postFontSize+"px",$(function(){function e(t){$(".post-container").css("font-size",t+"px"),localStorage.setItem("post-font-size",t),$("#size-change-input").val(t),$("#size-change-input2").val(t)}$("#size-change-input").on("input propertychange",function(t){e(t.target.value)}),$("#size-change-input2").on("input propertychange",function(t){e(t.target.value)})})</script><script>hljs.initHighlightingOnLoad()</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class=sns-container><a title=nostr target=_blank rel="noopener nofollow" href=https://iris.to/npub1g2qs0ca5kpwlrcfug2em4jelmh65clk3yccwjxrs6hvdpd9qj80q022j4m>Nostr</a><a title=rss target=_blank rel="noopener nofollow" href=/atom.xml>rss</a><a title=telegram target=_blank rel="noopener nofollow" href=//t.me/btcstudyorg>Telegram</a></section></footer><script async src="/js/buttons.js?v=1682773100887"></script><script async src="/js/index.js?v=1682773100887"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JVCJ9XXG1Z")</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306",e.async=!0,e.defer=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script></body></html>