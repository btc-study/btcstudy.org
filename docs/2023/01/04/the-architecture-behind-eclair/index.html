<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>eclair 客户端背后的架构</title><meta name="keywords" content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name="description" content="比特币思想的中文集结地"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css?v=1675838663798"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/style/common/iconfont.css?v=1675838663798"><link rel="stylesheet" href="/style/base.css?v=1675838663798"><link rel="stylesheet" href="/style/common/helper.css?v=1675838663798"><link rel="stylesheet" href="/style/themes/animation.css?v=1675838663798"><script>function ready() {
  var bodyEl = document.querySelector('.body-container');
  var theme = localStorage.getItem('theme') || 'light';
  if (!['light', 'dark'].includes(theme)) {
    theme = 'light';
    localStorage.setItem('theme', 'light');
  }
  bodyEl.classList.remove('appearance-auto');
  bodyEl.classList.add('appearance-' + theme);
  quickInitialTheme();
}
function quickInitialTheme() {
  var theme = localStorage.getItem('theme') || 'light';
  var logoLightEl = document.querySelector('.logo-light');
  var logoDarkEl = document.querySelector('.logo-dark');
  
  var mLogoLightEl = document.querySelector('#mobile-header-logo > .logo-light');
  var mLogoDarkEl = document.querySelector('#mobile-header-logo > .logo-dark');
  var themeBtnEl = document.getElementById('theme-btn');
  
  var slideThemeLightEl = document.querySelector('.slide-theme-light');
  var slideThemeDarkEl = document.querySelector('.slide-theme-dark');
  
  document.body.classList.add(theme);
  if (theme === 'dark') {
    logoLightEl.classList.add('hidden');
    logoDarkEl.classList.remove('hidden');
    
    mLogoLightEl.classList.add('hidden');
    mLogoDarkEl.classList.remove('hidden');
    
    themeBtnEl.classList.remove('icon-icon_dark');
    themeBtnEl.classList.add('icon-icon_light');
    
    slideThemeLightEl.classList.remove('hidden');
  } else {
    slideThemeDarkEl.classList.remove('hidden');
  }
}
document.addEventListener("DOMContentLoaded", ready);</script><script src="/js/common.js?v=1675838663798"></script><script src="/js/libs/zepto.min.js"></script><link rel="stylesheet" href="/style/post.css?v=1675838663798"><link rel="stylesheet" href="/style/themes/highlight.css?v=1675838663798"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="BTC Study" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column" onload="initialTheme()"><div class="clip"></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id="header"><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href="/"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id="header-menu"><a class="is-inline-block header-activity mr-4" href="/">首页</a><a class="is-inline-block mr-4" href="/archives">全站目录</a><a class="is-inline-block mr-4" href="/tags">标签</a><a class="is-inline-block mr-4" href="/maps">地图</a><a class="is-inline-block mr-4" href="/mempool">mempool</a><a class="is-inline-block mr-4" target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input" type="range" min="12" max="32" step="2"></div></div></div><i class="iconfont icon-icon_dark mr-1" id="theme-btn"></i><div class="search-wrap"><input class="pl-3" id="search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search" id="search-input-btn"></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">eclair 客户端背后的架构</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn2"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input2" type="range" min="12" max="32" step="2"></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id="mobile-header"><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id="mobile-header-logo"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopicMobile"><p class="is-full-height">eclair 客户端背后的架构</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class="mobile-search-wrap"><div class="search-input"><input class="pl-3" id="mobile-search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class="mobile-search-input-btn">搜 索</button></div></div></header><div class="mobile-slide-menu"><a class="header-activity" href="/">首页</a><a href="/archives">全站目录</a><a href="/tags">标签</a><a href="/maps">地图</a><a href="/mempool">mempool</a><a target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class="slide-menu-fontsize"><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1675838663798"> </script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0"><span class="toc-text">一个网络，多种实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%94%E5%91%98%E6%A8%A1%E5%9E%8B"><span class="toc-text">演员模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scala%EF%BC%8C%E4%B8%80%E7%A7%8D%E5%8A%9F%E8%83%BD%E6%80%A7%E7%9A%84%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"><span class="toc-text">Scala，一种功能性的编程语言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM%EF%BC%8C%E4%B8%80%E7%A7%8D%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">JVM，一种被严重低估的运行环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6"><span class="toc-text">插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">集群模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-text">结论</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id="postTitle">eclair 客户端背后的架构</h1><div class="page-author"><div class="is-flex is-flex-direction-row page-data mr-6"><img class="mr-1" src="//res.btcstudy.org/btcstudy/images/default_avatar.png" alt="ACINQ"><div class="page-author-info"><strong>ACINQ</strong><time class="has-text-grey" datetime="2023-01-03T17:10:25.000Z">2023-01-04</time></div></div><div class="is-flex"><a href="/tags/%E5%BC%80%E5%8F%91"><i class="page-tag mr-1 px-1">开发<!-- 订正图片路径--></i></a></div></div><article class="mt-4 post-content"><blockquote>
<p><em>作者：ACINQ</em></p>
<p><em>来源：<a target="_blank" rel="noopener" href="https://medium.com/@ACINQ/the-architecture-behind-eclair-ca0c99880962">https://medium.com/@ACINQ/the-architecture-behind-eclair-ca0c99880962</a></em></p>
</blockquote>
<blockquote>
<p>长话短说：eclair 客户端的架构基于 “演员模型”，让开发可靠且可扩展的软件变得更加简单。它支持着闪电网络中最大的节点，已经可靠地运行了接近 5 年。</p>
</blockquote>
<h2 id="一个网络，多种实现"><a href="#一个网络，多种实现" class="headerlink" title="一个网络，多种实现"></a>一个网络，多种实现</h2><p>闪电网络是一种去中心化的支付网络，围绕着一套共享的开源规范 —— <a target="_blank" rel="noopener" href="https://github.com/lightning/bolts">闪电网络 BOLT</a> —— 发展起来。</p>
<p>许多公司都对这套规范有所贡献，最积极的一些是 ACINQ、Blockstream、Lightning Labs 和 Spiral。改变规范需要花时间，也许多这许多团队的共识；这保证了被接受的特性都经过了彻底的审核，并且让闪电网络更高效、更安全，也更易于使用。</p>
<p>但是，规范只是一个起点：它需要被转化成实际上有用的软件。上面提到的四家公司都有自己的实现了 BOLT 的软件：<a target="_blank" rel="noopener" href="https://github.com/acinq/eclair">eclair</a> (ACINQ)、<a target="_blank" rel="noopener" href="https://github.com/ElementsProject/lightning/">cln</a> (Blockstream)、<a target="_blank" rel="noopener" href="https://github.com/lightningnetwork/lnd">lnd</a> (Lightning Labs) 和 <a target="_blank" rel="noopener" href="https://github.com/lightningdevkit/rust-lightning">ldk</a> (Spiral)。虽然每一种实现都有区别，但它们都遵循了同一种规范，而且是可以互通的，这也是为什么尽管节点们运行的软件各有不同，但我们能形成一个闪电网络。</p>
<p>每一种实现都有自己的优点和缺点，这对整个网络是好事：用户可以根据自己最适应的取舍、自己希望使用闪电网络的方式，选择合用的软件。在本文中，我们关注 eclair，这是当前闪电网络中最大的节点 ——  <a target="_blank" rel="noopener" href="https://mempool.space/lightning/node/03864ef025fde8fb587d989186ce6a4a186895ee44a926bfc370e2c366597a3f8f">ACINQ 节点</a> —— 所用的软件。我们的节点从 2018 年初开始就平滑地运行，开启了几千条通道、转发过无数的交易，并且通过流动性服务为非托管的移动钱包（曾用名 “eclair-mobile”，现用名 “Phoenix”）用户提供了良好的体验。</p>
<p>人们常常问我们：在生产环境中运行这么大的节点，一定非常难，有没有什么秘诀？我们的回答常常让人失望 —— 这并不是很难。Eclair 从一开始就是为并发、稳定性和横向可扩展性而设计的，所以部署和管理大量任务都非常简单。来看看让我们能做到这些的技术抉择。</p>
<h2 id="演员模型"><a href="#演员模型" class="headerlink" title="演员模型"></a>演员模型</h2><p>“演员模型” 是一种并发计算的模式，既可以集成到一种编程语言中（例如 <a target="_blank" rel="noopener" href="https://www.erlang.org/">Erlang</a> 和 <a target="_blank" rel="noopener" href="https://elixir-lang.org/">Elixir</a>）、也可以作为已有语言的一个库来实现（例如 JVM 的 <a target="_blank" rel="noopener" href="https://akka.io/">Akka</a>）。发明它是为了在许多机器的集群或者多核心的机器上高效且安全地运行高度并发的任务，办法是移除整个并发错误类型（不设共享的可变更状态）。</p>
<p>“演员” 是非常轻量级的进程，既不绑定到具体的线程，也不通过异步的消息传递来交互，所以不需要 “锁”。演员有可变的内部状态，但并不向彼此公开。在接收一条消息时，一个演员会运行一个同步消息处理器，这个处理器可能会更新其内部状态、向其它演员发送有限数量的消息并创建有限数量的新演员。一个演员一次只处理一条消息，这可以防止数据竞争进入。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/the-architecture-behind-eclair/EsSmMlg.png" alt="img"></p>
<p style="text-align:center">- 演员交换消息 -</p>


<p>上图展示了对等节点连接逻辑的一个简化版本：单个演员（图中的 “switchboard”，总机）接收 “connect” 消息以初始化对其它闪电节点的连接、创建子演员以实际处理 TCP 连接逻辑，并在稍后 —— 收到 “connected” 消息，表明连接已经建立时 —— 更新自己的内部状态。在转发 “connect” 消息给对等节点演员后，总机就可以去处理别的、不相关的消息了。</p>
<p>这种编程模式迫使开发者异步地处理每一个操作，并思考易于被忽略的罕见情形，例如：要是我发送一条消息之后一直得不到响应，那会怎么样？这种模型非常适合于实现有限状态机，而有限状态机完美适配闪电网络。乍看起来很难，但现实中编译器很有用，所以开发体验很舒服。最终生成的代码也很容易测试，而且微妙的罕见情形也很容易复现。</p>
<p>演员模型最重要的特性之一是位置的透明性：因为演员是通过信息来交互的，所以演员在哪里运行并不重要。它们可能在同一个进程中，也可能在同一台机器的不同进程中，甚至在远端的机器上。这是通过演员模型的实现直接处理的：应用逻辑在发送消息时使用演员 “引用”，而且不需要关心信息如何送达目的地（保证最多只需要一次分发）。我们后面会看到 eclair 是如何利用这一点轻易实现横向扩展的。</p>
<h2 id="Scala，一种功能性的编程语言"><a href="#Scala，一种功能性的编程语言" class="headerlink" title="Scala，一种功能性的编程语言"></a>Scala，一种功能性的编程语言</h2><p>Eclair 客户端是用 Scala 语言实现的，这种功能性编程语言运行在 JVM（Java 虚拟机）上。我们使用 <a target="_blank" rel="noopener" href="https://akka.io/">Akka</a> 库来结合演员模型和功能性编程。这两种编程模式相得益彰，而且很容易从简单、可组合的模块创建出复杂的系统，同时保证正确性和高效并发。</p>
<p>功能性编程帮助开发者专注在小型的、严格限定的模块上：数据不可变更性以及对副作用的严格控制，保证了这些模块不会因为竞争进入或者高级模块的误用，而以未预期到的状态结束。它也提供了非常丰富而且有表达力的类型系统。在现实中，这意味着开发者可以专注于寻找正确的架构和解决问题的数据模式，然后，因为有编译器的帮助，实现也会变得轻而易举。它使我们能轻而易举地解决复杂的问题，这也是我们的代码库比别的闪电网络客户端实现小得多的原因。</p>
<p>下面这张代码截图显示了我们是如何创建洋葱加密的支付消息的：注意模板匹配（pattern matching）和功能性组合是如何帮助创建简洁、易于检查正确性的实现的。</p>
<pre><code class="scala">/**
 * @param cmd             command to send the HTLC for this payment.
 * @param outgoingChannel channel to send the HTLC to.
 * @param sharedSecrets   shared secrets (used to decrypt the error in case of payment failure).
 */
case class OutgoingPaymentPacket(cmd: CMD_ADD_HTLC, outgoingChannel: ShortChannelId, sharedSecrets: Seq[(ByteVector32, PublicKey)])

/** Helpers to create outgoing payment packets. */
object OutgoingPaymentPacket &#123;

  case class NodePayload(nodeId: PublicKey, payload: PerHopPayload)
  case class PaymentPayloads(amount: MilliSatoshi, expiry: CltvExpiry, payloads: Seq[NodePayload])

  sealed trait OutgoingPaymentError extends Throwable
  case class CannotCreateOnion(message: String) extends OutgoingPaymentError &#123; override def getMessage: String = message &#125;
  case class CannotDecryptBlindedRoute(message: String) extends OutgoingPaymentError &#123; override def getMessage: String = message &#125;
  case class InvalidRouteRecipient(expected: PublicKey, actual: PublicKey) extends OutgoingPaymentError &#123; override def getMessage: String = s&quot;expected route to $expected, got route to $actual&quot; &#125;
  case class MissingTrampolineHop(trampolineNodeId: PublicKey) extends OutgoingPaymentError &#123; override def getMessage: String = s&quot;expected route to trampoline node $trampolineNodeId&quot; &#125;
  case class MissingBlindedHop(introductionNodeIds: Set[PublicKey]) extends OutgoingPaymentError &#123; override def getMessage: String = s&quot;expected blinded route using one of the following introduction nodes: $&#123;introductionNodeIds.mkString(&quot;, &quot;)&#125;&quot; &#125;
  case object EmptyRoute extends OutgoingPaymentError &#123; override def getMessage: String = &quot;route cannot be empty&quot; &#125;

  sealed trait Upstream
  object Upstream &#123;
    case class Local(id: UUID) extends Upstream
    case class Trampoline(adds: Seq[UpdateAddHtlc]) extends Upstream &#123;
      val amountIn: MilliSatoshi = adds.map(_.amountMsat).sum
      val expiryIn: CltvExpiry = adds.map(_.cltvExpiry).min
    &#125;
  &#125;

  /** Build an encrypted onion packet from onion payloads and node public keys. */
  def buildOnion(packetPayloadLength: Int, payloads: Seq[NodePayload], associatedData: ByteVector32): Either[OutgoingPaymentError, Sphinx.PacketAndSecrets] = &#123;
    val sessionKey = randomKey()
    val nodeIds = payloads.map(_.nodeId)
    val payloadsBin = payloads
      .map(p =&gt; PaymentOnionCodecs.perHopPayloadCodec.encode(p.payload.records))
      .map &#123;
        case Attempt.Successful(bits) =&gt; bits.bytes
        case Attempt.Failure(cause) =&gt; return Left(CannotCreateOnion(cause.message))
      &#125;
    Sphinx.create(sessionKey, packetPayloadLength, nodeIds, payloadsBin, Some(associatedData)) match &#123;
      case Failure(f) =&gt; Left(CannotCreateOnion(f.getMessage))
      case Success(packet) =&gt; Right(packet)
    &#125;
  &#125;

  private case class OutgoingPaymentWithChannel(shortChannelId: ShortChannelId, nextBlinding_opt: Option[PublicKey], payment: PaymentPayloads)

  private def getOutgoingChannel(privateKey: PrivateKey, payment: PaymentPayloads, route: Route): Either[OutgoingPaymentError, OutgoingPaymentWithChannel] = &#123;
    route.hops.headOption match &#123;
      case Some(hop) =&gt; Right(OutgoingPaymentWithChannel(hop.shortChannelId, None, payment))
      case None =&gt; route.finalHop_opt match &#123;
        case Some(hop: BlindedHop) =&gt;
          // We are the introduction node of the blinded route: we need to decrypt the first payload.
          val firstBlinding = hop.route.introductionNode.blindingEphemeralKey
          val firstEncryptedPayload = hop.route.introductionNode.encryptedPayload
          RouteBlindingEncryptedDataCodecs.decode(privateKey, firstBlinding, firstEncryptedPayload) match &#123;
            case Left(e) =&gt; Left(CannotDecryptBlindedRoute(e.message))
            case Right(decoded) =&gt;
              val tlvs = TlvStream(OnionPaymentPayloadTlv.EncryptedRecipientData(firstEncryptedPayload), OnionPaymentPayloadTlv.BlindingPoint(firstBlinding))
              IntermediatePayload.ChannelRelay.Blinded.validate(tlvs, decoded.tlvs, decoded.nextBlinding) match &#123;
                case Left(e) =&gt; Left(CannotDecryptBlindedRoute(e.failureMessage.message))
                case Right(payload) =&gt;
                  val payment1 = PaymentPayloads(payload.amountToForward(payment.amount), payload.outgoingCltv(payment.expiry), payment.payloads.tail)
                  Right(OutgoingPaymentWithChannel(payload.outgoingChannelId, Some(decoded.nextBlinding), payment1))
              &#125;
          &#125;
        case _ =&gt; Left(EmptyRoute)
      &#125;
    &#125;
  &#125;

  /** Build the command to add an HTLC for the given recipient using the provided route. */
  def buildOutgoingPayment(replyTo: ActorRef, privateKey: PrivateKey, upstream: Upstream, paymentHash: ByteVector32, route: Route, recipient: Recipient): Either[OutgoingPaymentError, OutgoingPaymentPacket] = &#123;
    for &#123;
      paymentTmp &lt;- recipient.buildPayloads(paymentHash, route)
      outgoing &lt;- getOutgoingChannel(privateKey, paymentTmp, route)
      onion &lt;- buildOnion(PaymentOnionCodecs.paymentOnionPayloadLength, outgoing.payment.payloads, paymentHash) // BOLT 2 requires that associatedData == paymentHash
    &#125; yield &#123;
      val cmd = CMD_ADD_HTLC(replyTo, outgoing.payment.amount, paymentHash, outgoing.payment.expiry, onion.packet, outgoing.nextBlinding_opt, Origin.Hot(replyTo, upstream), commit = true)
      OutgoingPaymentPacket(cmd, outgoing.shortChannelId, onion.sharedSecrets)
    &#125;
  &#125;

&#125;
</code></pre>
<h2 id="JVM，一种被严重低估的运行环境"><a href="#JVM，一种被严重低估的运行环境" class="headerlink" title="JVM，一种被严重低估的运行环境"></a>JVM，一种被严重低估的运行环境</h2><p>Eclair 运行起来非常快：<a target="_blank" rel="noopener" href="https://github.com/bottlepay/lightning-benchmark#results">我们所知的最新一份独立性能基准测试</a>（虽然现在已经过时了），将 eclair 评为处理支付最快的闪电实现。这可能会让那些认为 JVM 很慢的人感到意外，但现在应该澄清对这种被低估的运行环境的误解了。</p>
<p>虽然基于 JVM 的程序通常比别的编程语言消耗更多的内存，但其运行时性能通常都跟竞争对手打平甚至更好（甚至在没有垃圾回收的程序中也是如此）。这是 JVM 及其垃圾回收器的数十年优化的结果。JVM 也让我们容易跟原生的代码交互（如果有必要的话），感谢 JNI（Java Native Interface）：eclair 使用这个为所有的密码学操作调用 <a target="_blank" rel="noopener" href="https://github.com/bitcoin-core/secp256k1">libsecp256k1</a> 库。</p>
<p>JVM 已经被大量的成熟企业项目使用，并且提供了非常丰富而且经过考验的库和工具（集成开发环境、调试器、代码分析器、过滤器、监控器，等等）。流行的 java 库都有几百万用户（甚至不止），而且已经应用了数十年，这保证了我们不需要重新发明轮子，而且在必要时可以使用可靠的现成模块。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/the-architecture-behind-eclair/4FXsXg.jpeg" alt="img"></p>
<p style="text-align:center">- 罕见图片：功能编程师使用简单模块开发出复杂的系统 -</p>


<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>Eclair 提供了一个非常强大的插件系统：插件接收来自系统的主演员（main singleton actor）的演员引用，而且 可以发送自己想要的任何消息给任何一个演员。它们也可以注册到事件流中的某个事件中，从而允许它们响应重要事件（通道创建、对等节点连接、支付转发，等等）。这给插件的作者创造了无穷无尽的可能性！</p>
<p>但是，这种广泛的可能性也有缺点，就是缺乏易于使用的文档：我们没办法用简单、好读的文档介绍每一次演员的交互。开发者必须关注演员们收到的消息以及什么消息可能被返回，然后发现哪些东西是可以通过数据模式来浏览的。这给新进入的开发者带来了不小的门槛，我们准备通过提供正式的、可以作为样品的插件代码，来帮助插件作者起步。</p>
<h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2><p>默认情况下，eclair 会在同一个 JVM 实例上创建所有的演员：这对于不需要扩展到几万条通道和 TCP 连接的节点来说，更加高效。但我们也支持一种<a target="_blank" rel="noopener" href="https://github.com/ACINQ/eclair/blob/master/docs/Cluster.md">集群模式</a>，可以在分散的 “前端” 机器上运行一些演员，这可以用来扩展更大的节点。</p>
<p>这些前端及其处理连接管理（使用 BOLT8 流量加密）以及 gossip 管理（BOLT7），同时后端及其处理通道和支付。这保证了使用最多流量和最容易遭遇 DoS（拒绝服务式攻击）的模块可以放在负载均衡器后面，甚至基于实时使用量自动扩展（如果有需要的话）。</p>
<p>我们的节点当前使用了三台前端机器。这些机器不是满负载运行的，但是使用多一些机器是验证集群模式的架构、找出优化点的好办法。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/the-architecture-behind-eclair/8Vf_nLw.png" alt="img"></p>
<p style="text-align:center">- ACNIQ 节点的架构 -</p>


<p>当然，我们可以更进一步：eclair 创建的许多其它演员可以分散在多台机器上，这就使得单个逻辑节点可以拓展到几十万甚至几百万通道（如果有需要的话），而不需要复杂的操作设置。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>因为许多原因，Eclair 是知名度最低的实现：我们使用一种可以说有点小众的编程语言（但它真的很棒）、有些人就是不喜欢 JVM、我们也没有花时间来解释我们做了什么和为什么要这样做，而且人们常常以为我们只关心手机钱包（Phoenix）的开发。但桃李不言，下自成蹊：eclair 的可靠性使之成为了最大的闪电网络节点，解释了我们在网络中的重要位置。我们从一开始就参与闪电网络的开发，而且一直致力于创建干净、可以派上用场的软件，以让比特币的点对点支付更加快捷、安全、可靠，并且易于使用。</p>
<p>我们希望这篇文章能分享关于 eclair 工作原理、我们的节点何以如此可靠、eclair 如何设计以应对大型商务需要的洞见。如果你也在运行大型节点，或者你准备这样做，我们很希望能听到你的反馈，我们想知道如何能帮助你更简单把事情做成。为了帮助闪电网络成长，我们要帮助节点扩展。<a target="_blank" rel="noopener" href="https://github.com/ACINQ/eclair/blob/master/README.md#installation">试试 eclair 吧</a>，继续创造吧！</p>
<p>（完）</p>
</article></div></div></main><script src="/js/post.js?v=1675838663798"></script><script src="/js/highlight.min.js?v=1675838663798"></script><script>var containerEl = document.querySelector('.post-container');
var postFontSize = localStorage.getItem('post-font-size') || '16';
var inputEl = document.querySelector('#size-change-input');
var inputEl2 = document.querySelector('#size-change-input2');
inputEl.value = postFontSize;
inputEl2.value = postFontSize;
containerEl.style.fontSize = postFontSize + 'px';
$(function(){
  function setSizeChangeInputValue(size) {
    $('.post-container').css('font-size', size + 'px');
    localStorage.setItem('post-font-size', size);
    $('#size-change-input').val(size);
    $('#size-change-input2').val(size);
  }
  $('#size-change-input').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
  $('#size-change-input2').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
});
</script><script>hljs.initHighlightingOnLoad();</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/btcstudy">Twitter</a><!-- Github--><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml">rss</a><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/btcstudyorg">Telegram</a></section></footer><script async src="/js/buttons.js?v=1675838663798"></script><script async src="/js/index.js?v=1675838663798"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-JVCJ9XXG1Z');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306";
  hm.async = true;
  hm.defer = true;
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script></body></html>