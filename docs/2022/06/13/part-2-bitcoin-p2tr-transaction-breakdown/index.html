<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>比特币 P2TR 交易详解</title><meta name="keywords" content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name="description" content="比特币思想的中文集结地"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css?v=1676011583086"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/style/common/iconfont.css?v=1676011583086"><link rel="stylesheet" href="/style/base.css?v=1676011583086"><link rel="stylesheet" href="/style/common/helper.css?v=1676011583086"><link rel="stylesheet" href="/style/themes/animation.css?v=1676011583086"><script>function ready() {
  var bodyEl = document.querySelector('.body-container');
  var theme = localStorage.getItem('theme') || 'light';
  if (!['light', 'dark'].includes(theme)) {
    theme = 'light';
    localStorage.setItem('theme', 'light');
  }
  bodyEl.classList.remove('appearance-auto');
  bodyEl.classList.add('appearance-' + theme);
  quickInitialTheme();
}
function quickInitialTheme() {
  var theme = localStorage.getItem('theme') || 'light';
  var logoLightEl = document.querySelector('.logo-light');
  var logoDarkEl = document.querySelector('.logo-dark');
  
  var mLogoLightEl = document.querySelector('#mobile-header-logo > .logo-light');
  var mLogoDarkEl = document.querySelector('#mobile-header-logo > .logo-dark');
  var themeBtnEl = document.getElementById('theme-btn');
  
  var slideThemeLightEl = document.querySelector('.slide-theme-light');
  var slideThemeDarkEl = document.querySelector('.slide-theme-dark');
  
  document.body.classList.add(theme);
  if (theme === 'dark') {
    logoLightEl.classList.add('hidden');
    logoDarkEl.classList.remove('hidden');
    
    mLogoLightEl.classList.add('hidden');
    mLogoDarkEl.classList.remove('hidden');
    
    themeBtnEl.classList.remove('icon-icon_dark');
    themeBtnEl.classList.add('icon-icon_light');
    
    slideThemeLightEl.classList.remove('hidden');
  } else {
    slideThemeDarkEl.classList.remove('hidden');
  }
}
document.addEventListener("DOMContentLoaded", ready);</script><script src="/js/common.js?v=1676011583086"></script><script src="/js/libs/zepto.min.js"></script><link rel="stylesheet" href="/style/post.css?v=1676011583086"><link rel="stylesheet" href="/style/themes/highlight.css?v=1676011583086"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="BTC Study" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column" onload="initialTheme()"><div class="clip"></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id="header"><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href="/"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id="header-menu"><a class="is-inline-block header-activity mr-4" href="/">首页</a><a class="is-inline-block mr-4" href="/archives">全站目录</a><a class="is-inline-block mr-4" href="/tags">标签</a><a class="is-inline-block mr-4" href="/maps">地图</a><a class="is-inline-block mr-4" href="/mempool">mempool</a><a class="is-inline-block mr-4" target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input" type="range" min="12" max="32" step="2"></div></div></div><i class="iconfont icon-icon_dark mr-1" id="theme-btn"></i><div class="search-wrap"><input class="pl-3" id="search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search" id="search-input-btn"></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">比特币 P2TR 交易详解</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn2"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input2" type="range" min="12" max="32" step="2"></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id="mobile-header"><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id="mobile-header-logo"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopicMobile"><p class="is-full-height">比特币 P2TR 交易详解</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class="mobile-search-wrap"><div class="search-input"><input class="pl-3" id="mobile-search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class="mobile-search-input-btn">搜 索</button></div></div></header><div class="mobile-slide-menu"><a class="header-activity" href="/">首页</a><a href="/archives">全站目录</a><a href="/tags">标签</a><a href="/maps">地图</a><a href="/mempool">mempool</a><a target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class="slide-menu-fontsize"><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1676011583086"> </script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E5%AF%86%E7%A0%81%E5%AD%A6%E5%9B%9E%E9%A1%BE"><span class="toc-text">比特币密码学回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%AF%86%E7%A0%81%E5%AD%A6"><span class="toc-text">椭圆曲线密码学</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SECP256K1-%E6%9B%B2%E7%BA%BF"><span class="toc-text">SECP256K1 曲线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%EF%BC%88ECDSA%EF%BC%89"><span class="toc-text">椭圆曲线数字签名算法（ECDSA）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E8%A7%81%E8%AF%81-v0-vs-%E9%9A%94%E7%A6%BB%E8%A7%81%E8%AF%81-v1%EF%BC%9A%E5%8D%95%E7%AD%BE%E5%90%8D"><span class="toc-text">隔离见证 v0 vs 隔离见证 v1：单签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E8%A7%81%E8%AF%81-v0%EF%BC%9A%E5%8D%95%E7%AD%BE%E5%90%8D%E4%BA%A4%E6%98%93"><span class="toc-text">隔离见证 v0：单签名交易</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E8%A7%81%E8%AF%81-v1%EF%BC%9A%E5%8D%95%E7%AD%BE%E5%90%8D"><span class="toc-text">隔离见证 v1：单签名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-of-2-%E7%9A%84-P2WSH-vs-2-of-2-MuSig"><span class="toc-text">2-of-2 的 P2WSH vs. 2-of-2 MuSig</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-of-2-P2WSH"><span class="toc-text">2-of-2 P2WSH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-of-2-MuSig"><span class="toc-text">2-of-2 MuSig</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E7%A0%94%E7%A9%B6"><span class="toc-text">进阶研究</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text">参考文献</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id="postTitle">比特币 P2TR 交易详解</h1><div class="page-author"><div class="is-flex is-flex-direction-row page-data mr-6"><img class="mr-1" src="//res.btcstudy.org/btcstudy/images/default_avatar.png" alt="RJ Rybarczyk"><div class="page-author-info"><strong>RJ Rybarczyk</strong><time class="has-text-grey" datetime="2022-06-13T14:12:45.000Z">2022-06-13</time></div></div><div class="is-flex"><a href="/tags/Taproot"><i class="page-tag mr-1 px-1">Taproot<!-- 订正图片路径--></i></a><a href="/tags/%E9%9A%94%E7%A6%BB%E8%A7%81%E8%AF%81"><i class="page-tag mr-1 px-1">隔离见证<!-- 订正图片路径--></i></a></div></div><article class="mt-4 post-content"><blockquote>
<p><em>作者：RJ Rybarczyk</em></p>
<p><em>来源：<a target="_blank" rel="noopener" href="https://medium.com/galaxy-digital-bitcoin-mining/part-2-bitcoin-p2tr-transaction-breakdown-67b5a443554b">https://medium.com/galaxy-digital-bitcoin-mining/part-2-bitcoin-p2tr-transaction-breakdown-67b5a443554b</a></em></p>
</blockquote>
<p>文末的 “进阶研究” 部分提供了许多很棒的讲解 Schnorr 和 Taproot 的资源。为了理解 Taproot 升级的好处，先理解椭圆曲线密码学会有很大帮助，因为椭圆曲线也跟比特币所用的数字签名方案 ECDSA 有关。本文简要介绍了公私钥的生成过程，并解释了为什么 Schnorr 签名不会影响当前的（比如 HD 钱包所用的）地址生成方法。本文还演示了一笔单签名脚本交易的传统的隔离见证 v0 形式（使用 ECDSA 签名）以及它的隔离见证 v1 形式（即 Taproot 交易，使用 Schnorr 签名）；此外，本文还演示了一笔更复杂的 2-of-2 多签名交易的传统 P2WSH 形式以及使用 MuSig 的形式（MuSig 是一种利用了 Schnorr 和 Taproot 的签名方式）。比较同一交易在不同形式下的重量（weight，比特币在隔离见证升级后使用的衡量交易占用区块空间的单位），证明了隔离见证 v1 交易类型相比隔离见证 v0 类型，交易体积有所下降。</p>
<p>本文所用的变量的释义如下表：</p>
<pre><code class="python">G     - 生成点
point - 椭圆曲线上的点 (x, y)，等于某个标量乘以 G  
d     - 私钥
P     - 公钥，P = dG
k     - 随机的 nonce
R     - 随机的 nonce 点，R = kG
m     - 被签名的消息的 SHA256 哈希值
e     - SHA256(tag digest || R.x || P.x || m)
s     - k + e * d
Sig    - 签名算法
</code></pre>
<p><em>注：本文的大部分技术信息都来自 Schnorr 和 Taproot 相关的 BIP（BIP340、BIP341、BIP342），以及出色的 <a target="_blank" rel="noopener" href="https://bitcoinops.org/en/schorr-taproot-workshop">Bitcoin Optech Schnorr Taproot 研讨会</a>。</em></p>
<h2 id="比特币密码学回顾"><a href="#比特币密码学回顾" class="headerlink" title="比特币密码学回顾"></a>比特币密码学回顾</h2><h3 id="椭圆曲线密码学"><a href="#椭圆曲线密码学" class="headerlink" title="椭圆曲线密码学"></a>椭圆曲线密码学</h3><p><em>如果你熟悉 ECDSA、椭圆曲线密码学和 SECP256K1 曲线，可以跳过这一部分。</em></p>
<p>椭圆曲线密码学（ECC）以大数乘法将平面上的许多点组合成一条曲线。这个平面上有许多的点 <code>(x, y)</code> ， <code>x</code> 和  <code>y</code> 都是标量（整数）。曲线的等式（就像任何其它等式一样）指定了平面上的哪些点落在这条曲线上。假设一条曲线的等式为  <code>y = 2</code> （这是一条直线），那么点  <code>(0, 2)</code> 就在这条曲线上，但 <code>(0, 3)</code> 就不在这条曲线上，就这么简单。</p>
<p>下图展示了表示  <code>y = 2 </code> 的曲线（是的它是一条直线）以及落在曲线上的四个点  <code> (x = -1.75, y = 2)</code>，<code>(x = 2, y = 2)</code>，<code>(x = 5, y = 2)</code> 以及 <code>(x = 9, y = 2) </code> ，还有一个点  <code>(x = 2, y = 4)</code>  则不在曲线上。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/pJBIMA.jpeg" alt="img"></p>
<p style="text-align:center">- 实数域中的 y = 2 -</p>


<p>比特币所用的椭圆曲线只考虑正整数，所以点  <code>(x = -1.75, y = 2)</code> 自然是无效的了。</p>
<p>到此为止，我们还没有定义曲线  <code>y = 2</code> 的边界，这意味着整条曲线的定义域是  <code>[-∞, ∞]</code> 。但是，在比特币的椭圆曲线中，平面是有边界的，其边界由一个非常大的质数来指定，这个质数被称为质数阶，用  <code>p</code>  来表示，所以其定义域就是  <code>[0, p]</code> 。此外，这个域被描述为  <code>p </code> 上的一个有限域  <code>𝔽</code>（ <code>p</code> 我们说过了，是一个非常大的质数）。 这就意味着，超出 <code>[0, p]</code> 的  <code>x</code>  值也是有效的，超出 p 的时候它就会回到定义域下界。</p>
<p>我们拿  <code>y = 2 </code> 的等式来举个回到定义域下界的例子，假设其定义域是质数  <code>7</code> 上的有限域，我们画出跟前面一样的有效点<code>x = 2</code>、<code>x = 5 </code> 以及 <code> x = 8</code>。点是否落在曲线上，是根据点的 x 坐标值对  <code>p = 7</code> 取模来决定的。</p>
<pre><code class="python">(x = 2, y = 2) -&gt; x 坐标 = 2 % 7 = 2
(x = 5, y = 2) -&gt; x 坐标 = 5 % 7 = 5
(x = 8, y = 2) -&gt; x 坐标 = 8 % 7 = 1
</code></pre>
<p>请注意，当  <code>x = 8 </code> 时，实际上的点落在  <code>x = 1 </code> 上。用图看会清楚一些。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/9Jk3yg.jpeg" alt="img">-<code>p = 7</code> 的有限域 <code>𝔽_p</code> 上的 <code>y = 2</code>-</p>
<p>现在我们已经知道定义在一个有限域  <code>𝔽_p</code> 上的曲线的含义了，我们继续研究比特币的椭圆曲线密码学所用的那条曲线，SECP256K1。</p>
<h3 id="SECP256K1-曲线"><a href="#SECP256K1-曲线" class="headerlink" title="SECP256K1 曲线"></a>SECP256K1 曲线</h3><p>许多不同类型的曲线都可以用在椭圆曲线密码学中。这些曲线可以表述成所谓的 “魏尔施特拉斯（Weierstrass）形式”，也就是  <code>y² = x³ + ax + b</code> ，其中 a 和 b 都是常量，决定了曲线的形状。比特币使用 SECP256K1 曲线，其  <code>a = 0 </code> 、 <code>b = 7</code> ，因此最终的等式是  <code>y² = x³ + 7 </code> 。如果用实数来绘制这条曲线，将如下图。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/rGv48g.jpeg" alt="img"></p>
<p style="text-align:center">- 实数上的 SECP256K1  <code>y² = x³ + 7</code> -</p>


<p>那么，这条曲线如何用来生成私钥和公钥呢？这对密钥必需具有某些属性，使我们能高度确信，给定一个私钥和生成点，公钥就可以生成出来；但给定生成点和公钥，你<strong>没法</strong> “倒推” 发现私钥。这种可以容易计算一个方向上的值、但很难倒推的能力，是由一种叫做 “陷门函数” 的函数实现的。在 ECC 这里，陷门函数是可以实现的，因为 ECC 的元件保证了可以很容易地计算大数乘法，但几乎不可能从乘积倒推出原本的乘数。</p>
<p>为便于理解这个概念，我们来看看下面这个例子。我们设 SECP256K1 曲线上有一个生成点  <code>G</code> ，然后我们让 G 与 G 相加许多次（也即是将 G 乘以某个数，乘数逐渐加大）。</p>
<p>先绘出 SECP256K1 上的生成点。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/n7jg2Q.jpeg" alt="img"></p>
<p style="text-align:center">- SECP256K1 曲线上的生成点示例 -</p>


<p>现在，我们使用一种叫做 “点倍增（Point Doubling）” 的办法来计算  <code>2G</code> 。我们画出椭圆曲线上过  <code>G</code> 点的切线，然后找到这切线与曲线相交的地方，然后找出这个交点跟 x 轴对称的点，这就是 <code>2G</code> 。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/DiglQw.jpeg" alt="img"></p>
<p style="text-align:center">- SECP256K1 曲线上的 2G 示例 -</p>


<p>现在，我们过 <code>G</code> 和 <code>2G</code> 画一条射线，该线会在另一个位置与曲线相交。该交点与 x 轴对称的点，就是 <code>3G</code> 。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/elbrtQ.jpeg" alt="img"></p>
<p style="text-align:center">- SECP256K1 曲线上的 3G 示例 -</p>


<p>要计算  <code>4G</code> ，只需如法炮制，在 <code>G</code> 和 <code>3G</code> 之间画一条直线，找出该线与曲线的交点，再找出该点与 x 轴对称的点。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/jlNwag.jpeg" alt="img"></p>
<p style="text-align:center">- SECP256K1 曲线上的 4G 示例 -</p>


<p>在这种方法下，假设有限域的阶数比较小，计算几次乘法来找出点  <code>dG</code> 背后的乘数并不困难。但如果有限域的阶数非常大，与  <code>G</code> 自乘的次数就可以变得非常大。要遍历所有的  <code>d</code>  来找出曲线上某一点背后的  <code>d</code> 就会非常费时费力，乃至于完全不可能。</p>
<p>这就是所谓的 “椭圆曲线的离散对数问题”，也是比特币的公钥密码学所以安全的原因。乘数 <code>d</code> 就是私钥，最终的点 <code>dG</code> 就是  <code>d</code> 的公钥。</p>
<p>椭圆曲线密码学是非常有用的，因为你可以用点自乘，但因为曲线是模 <code>p</code> 的有限域，而  <code>p</code> 是专门选择的一个非常大的数，所以，如果你只有公钥和生成点，倒推算出私钥被认为是不可能的（也即不可能逆转乘法）。这就是比特币签名方案获得密码学安全性的办法。</p>
<pre><code class="java">P(x, y) = d * G
</code></pre>
<p>比特币所用的生成点用到了非常大的 <code>x</code> 值和  <code>y</code> 值。</p>
<pre><code class="java">G(x, y) = 
(0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798, 0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8)
</code></pre>
<p>比特币所用的阶数  <code>p</code> 也是非常大的质数。</p>
<pre><code class="java">p = 2²⁵⁶ - 2³² - 2⁹ - 2⁸ - 2⁷ - 2⁶ - 2⁴ - 1
p = 0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f
</code></pre>
<p>这个质数定义了私钥的最大长度，换算成 10 进制是 77 位（非常大）。</p>
<p>而生成点的阶数 <code>n</code> 定义了曲线上的最大点，也即最大的公钥，但它稍小于  <code>p</code> 。</p>
<pre><code class="java">n = 2²⁵⁶ - 2³² - 977
n = 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141
</code></pre>
<p>还有一件事需要说明。在实践中，SECP256K1 曲线并不像上面的图那样看起来如此平滑，如此精美。实际上，随着 <code>p</code> 的提高（请记住这条曲线的定义只包括整数，<strong>而不是</strong>所有实数），整条曲线看起来就像点形成的云团。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/part-2-bitcoin-p2tr-transaction-breakdown/micX9xw.png" alt="img"></p>
<p style="text-align:center">- <code>p = 257</code> 的有限域 <code>𝔽_p</code> 上的 SECP256K1 曲线 -</p>


<h3 id="椭圆曲线数字签名算法（ECDSA）"><a href="#椭圆曲线数字签名算法（ECDSA）" class="headerlink" title="椭圆曲线数字签名算法（ECDSA）"></a>椭圆曲线数字签名算法（ECDSA）</h3><p>数字签名基于公钥密码学（也称 “非对称密码学”）。首先我们要生成一对公私钥（详情上文已述），然后用私钥来签名消息  <code>m</code> 。</p>
<p>数字签名是用来签名消息的。被签名的消息可以是任何东西，但在比特币中，被签名的消息就是用户想要发送的交易。</p>
<p>比特币当前使用的数字签名方案是椭圆曲线数字签名算法（ECDSA）。</p>
<p>要生成一条消息的 ECDSA 签名（在比特币中就是交易的一部分的签名），我们先要生成一对公私钥以及它们的地址，然后我们要创建一笔交易，花费该地址所控制的 UTXO（假设该地址已经拥有了一些 UTXO）。</p>
<h2 id="隔离见证-v0-vs-隔离见证-v1：单签名"><a href="#隔离见证-v0-vs-隔离见证-v1：单签名" class="headerlink" title="隔离见证 v0 vs 隔离见证 v1：单签名"></a>隔离见证 v0 vs 隔离见证 v1：单签名</h2><p>这里我们将展示单签名输出交易的隔离见证 v0 形式以及隔离见证 v1 形式。两种交易形式的签名过程都会详细写出，并且我们会比较最终的交易重量。最终，隔离见证 v0 交易的重量是 437，而隔离见证 v1 交易的重量是 349（使用 2-of-2 的 MuSig 方案的隔离见证 v1 交易也是同样的重量，下文有述）。节约了约 10% 的交易重量。</p>
<h3 id="隔离见证-v0：单签名交易"><a href="#隔离见证-v0：单签名交易" class="headerlink" title="隔离见证 v0：单签名交易"></a>隔离见证 v0：单签名交易</h3><p>本节展示了对一笔隔离见证 v0 交易生成 ECDSA 签名的步骤，这笔交易仅仅是从某地址向另一个地址发送交易，没有复杂的条件。这个过程也展示了 ECDSA 签名方案的细节。比特币当前就是这样工作的（译者注：准确点说，是 Taproot 以前的脚本就是这样工作的）。</p>
<ol>
<li>生成私钥和公钥（译者注：这是为了教学用途才将私钥写出，请千万不要将你的私钥公开给他人！）</li>
</ol>
<pre><code class="java">d = 0xe6075ae177834de90e007bef0307965f8a5b796b064cd86b6ac943c7ab8f5fca
P = 0x02e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569
</code></pre>
<ol start="2">
<li>生成该公钥相关的地址。我们先计算出该公钥的 SHA256 哈希值的 RIPEMD160 哈希值。这个哈希就是见证程序。这个见证程序加上网络版本号（这里使用  <code>0x00</code> ，表明它是隔离见证 v0），生成一个 bech32 编码的地址。我们将这个地址称为发送地址。</li>
</ol>
<pre><code class="java">bcrt1qw0xl67sk04nrgnxq4gcgzv48lhsh6uz5z7etkx
</code></pre>
<ol start="3">
<li>在这个例子中，我们把发送地址中的比特币发到另一个也由同一个密钥对按照步骤 2 生成的地址中。本质上来说，我们这是把钱从左口袋发到右口袋。接收地址如下：</li>
</ol>
<pre><code class="java">bcrt1qpe494cttjy5kwp7z3m6apqm0q3n8hkhrrjesxr
</code></pre>
<ol start="4">
<li>然后我们创建一个从发送地址发送 1 btc 到接收地址的隔离见证 v0 待签名交易。</li>
</ol>
<p>传统交易的版本号是 <code>0x01000000</code> 。输出点（outpoint）则说明使用的是该交易的索引号为 0 的输出。</p>
<pre><code class="java">afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada00000000
</code></pre>
<p>这笔交易将形成一个输出，面额为 50,000,000 聪（也就是 0.5 btc）。这个输出包含了一个锁定脚本，这个锁定脚本是从接收地址推导出来的，可以保证这个输出只能被持有接收地址的私钥的人花费。这个锁定脚本签名要加上声明其长度的字节：</p>
<pre><code class="java">0x1600140e6a5ae16b91296707c28ef5d0836f04667bdae3
</code></pre>
<p>最终的待签名交易如下所示：</p>
<pre><code class="java">0100000001afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada0000000000000000000180f0fa02000000001600140e6a5ae16b91296707c28ef5d0836f04667bdae300000000
</code></pre>
<p>这串数据到底是什么意思呢？</p>
<pre><code class="java">01000000 - 交易的版本号
01 - 交易输入的数量
afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada - 前序交易的 id
00000000 - 前序输出的索引号
00 - 传统签名占位符
00000000 - 序列号
01 - 输出的数量
80f0fa0200000000 - 输出的数额，50,000,000 聪 = 0.5 bitcoin 1600140e6a5ae16b91296707c28ef5d0836f04667bdae3 - 输出的锁定脚本
00000000 - 交易的时间锁
</code></pre>
<p>再说一遍，这就是我们的 ECDSA 算法要签名的内容。</p>
<ol start="5">
<li><code>z</code> 是从这个隔离见证 v0 的待签名交易的 sighash 中推导出来的。所谓的 “sighash”，就是交易的多个部分的 SHA256 哈希值，以及 sighash 的类型（表明签名覆盖的交易字段，也即表明签名的意图，在这个案例中是 SIGHASH_ALL）。</li>
</ol>
<p>锁定脚本必需首先从上面创建的见证程序中推导出来。</p>
<pre><code class="java">witness program = pubkey hash = 0x73cdfd7a167d66344cc0aa308132a7fde17d7054
P2PKH locking script = [ OP_DUP, OP_HASH160, witness program, OP_EQUALVERIFY, OP_CHECKSIG ]
P2PKH locking script = 76a91473cdfd7a167d66344cc0aa308132a7fde17d705488ac
</code></pre>
<p>现在，我们已经获得生成 sighash 的所有元素了，sighash 的值就是  <code>z</code> ，就是我们要签名的内容。</p>
<pre><code class="javascript">nVersion = 0x01000000 (交易版本号)
outpoint = 0xafb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada00000000（输出点，标记交易所使用的输入，也即资金来源）
nSequence = 0x00000000
lockingScript = 0x76a91473cdfd7a167d66344cc0aa308132a7fde17d705488ac（输入所用的锁定脚本）
amount = 0x00e1f50500000000 (100,000,000 sats = 1 bitcoin)（输入的面额）

SHA256(outpoint) = SHA256( 0xafb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada || 0x00000000 ) = 0x7544688d2df453bd49836f034e3eb36ed3e410a0578019310f2d58282693a6ba

SHA256(nSequence) = SHA256(0x00000000) = 0xb90ca5b5653eabdc3341c6f96b3b80689cdd1bd6870265adfe17c8172501b98c

SHA256(txouts) = SHA256() = 0x85daff2e158d437f078d3c9289c86a2b037e67cf68e6eb994f3113ba0f0831b0

SIGHASH_FLAG = SIGHASH_ALL = 0x01000000

z = sighash = SHA256( 
nVersion || SHA256(outpoint) || SHA256(nSequence) || outpoint || lockingScript || amount || nSequence || SHA256(txouts) || nLockTime || SIGHASH_FLAG)

z = sighash = SHA256(0x01000000 || SHA256(0xafb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada || 0x00000000 ) || SHA256(0x00000000) || (0xafb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada || 0x00000000) || 0x76a91473cdfd7a167d66344cc0aa308132a7fde17d705488ac || 0x00e1f50500000000 || 0x00000000 || 0x85daff2e158d437f078d3c9289c86a2b037e67cf68e6eb994f3113ba0f0831b0)

z = sighash = SHA256( 01000000baa6932628582d0f31198057a010e4d36eb33e4e036f8349bd53f42d8d6844758cb9012517c817fead650287d61bdd9c68803b6bf9c64133dcab3e65b5a50cb9afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada000000001976a91473cdfd7a167d66344cc0aa308132a7fde17d705488ac00e1f5050000000000000000b031080fba13314f99ebe668cf677e032b6ac889923c8d077f438d152effda850000000001000000)

z = sighash = 0x28b67faf17c13ced9f2ccf2acd3ee28ebd5c2bc9adb9634073e3336cf2a41141
</code></pre>
<ol start="6">
<li>现在才是真正要用到 ECDSA 签名算法的地方。为便于理解，我们温习一下 ECDSA 签名的定义。</li>
</ol>
<pre><code>s = k⁻¹ * (z + r * d) mod n
</code></pre>
<p>生成另一个大小在  <code>[1, n]</code> 之间的随机私钥 <code>k</code> 。这是一个一次性的私钥，用它来生成公钥点  <code>R</code> 。</p>
<pre><code class="java">k = 0x7925f65c88fc66ee2fecfd4d8f678d4706762e5300023902af006345a9aec9f3
R = (R.x, R.y) = (0x4f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b, 0x60fa3861fc04dac9054398e79407afb088c0aaf8be7e78484a7756319197065d)
</code></pre>
<p>ECDSA 签名中的 <code>r</code> 是公钥 <code>R </code>  的 x 坐标对 n 求模。</p>
<pre><code class="java">r = R.x mod n = 0x4f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b mod 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141
    
r = 0x4f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b
</code></pre>
<p>这个  <code>k⁻¹</code> 是  <code>k mod n</code> 的模逆。</p>
<pre><code class="java">k⁻¹ = 0x14ec7a2f5f095cb2b83cb22f852876ba810ce9c84c162ebcd02e2308efb8c755
</code></pre>
<p>现在我们拥有计算 ECDSA 签名的所有元素了。</p>
<pre><code class="java">s = k⁻¹ * (z + r * d) mod n

s = 0x14ec7a2f5f095cb2b83cb22f852876ba810ce9c84c162ebcd02e2308efb8c755 *(0x28b67faf17c13ced9f2ccf2acd3ee28ebd5c2bc9adb9634073e3336cf2a41141 + 0x4f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b ) mod 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141

s = 0x68ad1571330a5cbcfd0746702a092233c05aa3232fad8059acce0f8ff687cf8e
</code></pre>
<ol start="7">
<li>最终的 ECDSA 签名使用 DER 编码格式。</li>
</ol>
<pre><code class="java">0x30 - DER 序列指示器
0x45 - 序列长度指示 (69 bytes)
0x02 - 表明下一个值是整数
0x21 - 整数的字节长度 (33 bytes)
r    - 随机 nonce 点
0x02 - 表明下一个值是整数
0x20 - 整数的字节长度 (32 bytes)
s    - 签名
SF   - SIGHASH 标签 (1 byte)
</code></pre>
<p>使用上面的  <code>r</code> 和  <code>s</code> ，即可得出最终的 DER 编码格式。</p>
<pre><code class="java">0x30
0x45
0x02
0x4f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b - r
0x02
0x20
0x68ad1571330a5cbcfd0746702a092233c05aa3232fad8059acce0f8ff687cf8e - s
0x01 - SIGHASH_ALL

Sig = 0x304402204f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b022068ad1571330a5cbcfd0746702a092233c05aa3232fad8059acce0f8ff687cf8e01
</code></pre>
<p>最终签好名的交易如下所示：</p>
<pre><code class="java">01000000000101afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada0000000000000000000180f0fa02000000001600140e6a5ae16b91296707c28ef5d0836f04667bdae30247304402204f0c7a2ed699f37346edb7e10a7d9978b94b6623c3b844e6c5208ddac998933b022068ad1571330a5cbcfd0746702a092233c05aa3232fad8059acce0f8ff687cf8e012102e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d49756900000000
</code></pre>
<p>这笔隔离见证 v0 交易的重量是 437。在下一节，我们会以隔离见证 v1 格式（Schnorr 签名和 Taproot）重构这笔交易，然后比较最终交易的重量。</p>
<h3 id="隔离见证-v1：单签名"><a href="#隔离见证-v1：单签名" class="headerlink" title="隔离见证 v1：单签名"></a>隔离见证 v1：单签名</h3><p>我们上面讲的是使用 SECP256K1 曲线上的 ECDSA 签名和 SHA256 哈希值给比特币交易提供授权的过程。本质上，BIP340 所定义的 Schnorr 签名实现使用了相同的椭圆曲线密码学。也就是说，使用了相同的 SECP256K1 曲线，而且原理也都是一样的。这是很棒的，因为这意味着相同的私钥可以用来创建 ECDSA 签名和 Schnorr 签名。这也意味着，在使用 Schnorr 签名方案时，层级确定性钱包（HD 钱包，由 BIP32 定义）这样的技术依然是可以使用的。</p>
<p>使用 Schnorr 签名的过程与 ECDSA 类似。私钥、秘密 nonce，生成点，随机 nonce 点，公钥，都是一样的。</p>
<p>Schnorr 签名定义是：</p>
<pre><code class="java">Sig(s, R)
s = k + e * d
其中 e = SHA256(R || P || m)
</code></pre>
<p>我们使用跟上面的 ECDSA 签名案例同样的交易来演示 Schnorr 签名的步骤。不过，这次我们不是使用隔离见证 v0 格式，而是使用新的隔离见证 v1 格式。</p>
<pre><code class="java">0100000001afb466816ddcf2003bcc64a73b4c3ce627d5af42dd1654b8c4e35e894db73ada0000000000000000000180f0fa02000000001600140e6a5ae16b91296707c28ef5d0836f04667bdae300000000
</code></pre>
<ol>
<li>生成一把随机私钥以及对应的公钥。使用了跟上面的 ECDSA 案例同样的密钥对。</li>
</ol>
<pre><code class="java">privkey, d: 0xe6075ae177834de90e007bef0307965f8a5b796b064cd86b6ac943c7ab8f5fca
pubkey, P: 0x02e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569
</code></pre>
<p>使用 Jacobi 符号来检查公钥是对域大小求模的二次剩余（quadratic residue）。如果不是，就对这个公钥求反（negate the public key）。这是为了避免在随机 nonce 点 R 中包含 y 坐标。要求验证者做这个检查，我们就能避免在签名的随机 nonce 点  <code>R</code> 中包含 y 坐标，从而能够将签名的体积从 96 字节降低到 64 字节。本质上，它是为验证者提供了一种标准化的方式来独立获得 y 坐标。除了检查对域大小求模的二次剩余，还有别的办法，但这是最高效的。</p>
<p>这个公钥是对域大小求模的二次剩余，所以我们不必放弃。</p>
<ol start="2">
<li>使用见证程序推导出 bech32 隔离见证编码的发送地址。隔离见证 v1 交易的见证程序就是公钥的 32 字节的 x 坐标（删除了前缀的  <code>0x02</code> 字节），而不像隔离见证 v0 那样是公钥 SHA256 哈希值的 RIPEMD160 哈希值。</li>
</ol>
<pre><code>witness program = 0xe650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569
</code></pre>
<p>发送地址是一个 bech32 编码的地址，由隔离见证 v1 版本（ <code>0x01</code> ）和见证程序推导出来</p>
<pre><code class="java">bcrt1puegpy5cjy5ah75m9jcmkr8exfk8sklt4qp66nk8vj5ekw82fw45sv76ace
</code></pre>
<ol start="3">
<li>在这个例子中（跟 ECDSA 的例子一样），比特币会从步骤 2 所生成的地址发送到步骤 1 所生成的同一个密钥对的另一个地址中，也即同样是自己发送给自己。这个接收地址是：</li>
</ol>
<pre><code class="java">bcrt1q5lpjwpcnrzcjry7ahewqk986mfje9hu8gwrtw8
</code></pre>
<ol start="4">
<li>然后我们创建一笔隔离见证 v1 的待签名交易，该交易把发送地址的 1 btc 发给接收地址。</li>
</ol>
<pre><code class="java">0100000001fb40c6b15742604fd8c70c21ddea55f64c03c27e1344ebd6c73d83dac67fd6040000000000000000000180f0fa020000000
0160014a7c327071318b12193ddbe5c0b14fada6592df8700000000
</code></pre>
<p>完整的解释如下：</p>
<pre><code class="java">0x01000000 - 版本号
0x01 - 输入的数量
0x04d67fc6da833dc7d6eb44137ec2034cf655eadd210cc7d84f604257b1c640fb - 前序交易的 id
0x00000000 - 前序输出索引号
0x00 - 传统的签名占位符
0x00000000 - sequence number
0x01 - 输出的数量
0x80f0fa0200000000 - 输出的面额，50,000,000 sats = 0.5 bitcoin 
0x160014a7c327071318b12193ddbe5c0b14fada6592df87 - 输出的锁定脚本
0x00000000 - 交易的锁定时间
</code></pre>
<p>这就是我们的 Schnorr 签名要覆盖的东西。</p>
<ol start="5">
<li>为了决定  <code>e</code> ，我们需要这笔待签名交易的隔离见证 v1 sighash（也就是 Taproot sighash）。</li>
</ol>
<p>产生我们正在消费的 UTXO 的交易如下：</p>
<pre><code class="java">020000000001012048b235a15d5514a1ff9750bcd01e340b2ecd8bc7b6c2f185b20232988215f50000000000ffffffff0100e1f50500000000225120e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d49756902473044022062672201ecf2a933a83367f6ca121da9529638fa205d55d9805322544ca5fe4802202627a1fcac38bd537ea6c058e518753e9caf0f7f82e654224c2a4cfe4cfca80e01210240cecf455225bf42ffd09cdfb8ca6aea29c57dfcdf11453b065129a46a7fa16500000000

被花费的 UTXO 的锁定脚本: 0x225120e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569
</code></pre>
<p>通过使用名为 <code>TapSighash</code> 的带标签哈希函数并拼接交易的不同部分，我们就可以算出这笔交易的 sighash。</p>
<p>Taproot 引入了一种新的 sighash 标签 <code>SIGHASH_ALL_TAPROOT</code> 。</p>
<pre><code>0x01 - SIGHASH_ALL
0x02 - SIGHASH_NONE
0x03 - SIGHASH_SINGLE
0x81 - SIGHASH_ALL | SIGHASH_ANYONECANPAY
0x82 - SIGHASH_NONE | SIGHASH_ANYONECANPAY
0x83 - SIGHASH_SINGLE | SIGHASH_ANYONECANPAY
0x00 - SIGHASH_ALL_TAPROOT
</code></pre>
<p>这个标签跟  <code>0x01</code> <code>SIGHASH_ALL </code>  有相同的语义，但不必包含这个字节，而是隐藏掉了。所以，除非另有指定，一笔 taproot 交易的签名默认带有 <code>SIGHASH_ALL</code> 标签。</p>
<pre><code class="java">sighash = Tagged Hash( &quot;TapSighash&quot;, 
0x00 || SIGHASH_ALL_TAPROOT || nVersion || nLockTime || SHA256(outpoint) || SHA256(amount) || SHA256(nSequence) || SHA256(txout) || SPEND_TYPE || locking scrpt of UTXO being consumed || prevIndex )

sighash = Tagged Hash(&quot;TapSighash&quot;, 0x00 || 0x00 || 0x01000000 || 0x00000000 || SHA256(0x04d67fc6da833dc7d6eb44137ec2034cf655eadd210cc7d84f604257b1c640fb || 0x00000000) || SHA256(0x80f0fa0200000000) || SHA256(0x00000000) || SHA256(80f0fa020000000
0160014a7c327071318b12193ddbe5c0b14fada6592df87) || 0x00 || 0x225120e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569 || 0x00000000)

sighash = Tagged Hash(&quot;TapSighash&quot;, 00000100000000000000342803b540671e08fbc1452d83d80eef3a88c0894dbba6cb52764a950f6b86e12c3417ea6a6d07f4a0218f5b1d380037c8b95c24eeb4e70299776a634a0dffa2df3f619804a92fdb4057192dc43dd748ea778adc52bc498ce80524c014b8111997baae7ecdb0eee1e5e66b27a0dd8562a70fda6768f9ef570a6584d0096779f800225120e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d49756900000000)

sighash = 0xb09f298288a1656c160c31d3d7445404bfa6a838bf53f1ca486ec1bc4241a43c
</code></pre>
<ol start="6">
<li>现在就要 Schnorr 签名上场了。我们温习一下签名的定义：</li>
</ol>
<pre><code class="java">s = k + e * d
</code></pre>
<p>为了确定性地生成随机 nonce 值 <code>k</code> ，生成 <code>k</code>  的第一个字节是拼接私钥 <code>d</code> 和消息本身（sighash）后使用名为 <code>BIPSchnorrDerive</code> 的带标签哈希算法推导出来的。这个数据叫做  <code>nonce bytes</code> 。</p>
<pre><code class="java">nonce_bytes = Tagged Hash(&quot;BIPSchnorrDerive&quot;, d || sighash)

nonce_bytes = Tagged Hash(&quot;BIPSchnorrDerive&quot;, 0xe6075ae177834de90e007bef0307965f8a5b796b064cd86b6ac943c7ab8f5fca || 0xb09f298288a1656c160c31d3d7445404bfa6a838bf53f1ca486ec1bc4241a43c)

nonce_bytes = 0x70603f193eeb790b0c8c40a9536f7161314d1b30ad1dcebc5c7db88eca1871e6
</code></pre>
<p>然后 nonce bytes 对阶数  <code>n</code>  求模，得到 <code>k&#39;</code> 。</p>
<pre><code class="java">k&#39; = nonce_bytes % n
k&#39; = 0x70603f193eeb790b0c8c40a9536f7161314d1b30ad1dcebc5c7db88eca1871e6 % 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141
k&#39; = 0x70603f193eeb790b0c8c40a9536f7161314d1b30ad1dcebc5
c7db88eca1871e6
</code></pre>
<p>然后我们用  <code>k&#39;</code>  来生成一个公钥，也就是 nonce 点 <code>R</code> 。</p>
<pre><code class="java">R = (0x50ed3e867619db28fa917c8b6b86912fa68c9140b8dda1ce864c796b918fad36, 0xeedb98506fba05feb5c1606b015594c1d2d9227c2874a2e0ff421fb3957627ee)
</code></pre>
<p>使用 Jacobi 符号检查  <code>R.y</code> 是对域大小求模的二次剩余。如果是，就设定 k 等于 k’。如果不是，对  <code>k</code> 求反 。在这个案例中，  <code>R.y</code> 不是对域大小求模的二次剩余，所以我们对 <code>k</code> 求反。</p>
<pre><code class="java">k = n - k&#39;
k = 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141 - 0x70603f193eeb790b0c8c40a9536f7161314d1b30ad1dcebc5c7db88eca1871e6
k = 0x8f9fc0e6c11486f4f373bf56ac908e9d8961c1b6022ad17f6354a5fe061dcf5b
</code></pre>
<p> <code>e</code> 是使用 nonce 点的 x 坐标 <code>R.x</code> 拼接公钥的 x 坐标 <code>P.x</code> 和消息（sighash）后使用带标签哈希值计算出来的：</p>
<pre><code class="java">e = tagged hash(BIPSchnorr, R.x || P.x || sighash)
e = tagged hash(BIPSchnorr, 0x50ed3e867619db28fa917c8b6b86912fa68c9140b8dda1ce864c796b918fad36 || 0x02e650125312253b7f53659637619f264d8f0b7d750075a9d8ec9533671d497569 || 0xb09f298288a1656c160c31d3d7445404bfa6a838bf53f1ca486ec1bc4241a43c)
e = 0xa7eb946b6b143a8419445e87c3ef24bb541e3098e84c90a6b2b21e51b79f2518
</code></pre>
<p>现在我们已经拥有了计算 Schnorr 签名所需的所有元素。</p>
<pre><code class="java">s = k + e * d mod n
s = 0x8f9fc0e6c11486f4f373bf56ac908e9d8961c1b6022ad17f6354a5fe061dcf5b + 0xa7eb946b6b143a8419445e87c3ef24bb541e3098e84c90a6b2b21e51b79f2518 * 0xe6075ae177834de90e007bef0307965f8a5b796b064cd86b6ac943c7ab8f5fca % 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141
s = 0x50ed3e867619db28fa917c8b6b86912fa68c9140b8dda1ce864c796b918fad36bbf1edd482f1edf878f88e51fc9ede51cc732e7d3df2c4146a746208701251ce
</code></pre>
<p>最终的签名交易如下所示：</p>
<pre><code class="java">01000000000101fb40c6b15742604fd8c70c21ddea55f64c03c27e1344ebd6c73d83dac67fd6040000000000000000000180f0fa0200000000160014a7c327071318b12193ddbe5c0b14fada6592df87014050ed3e867619db28fa917c8b6b86912fa68c9140b8dda1ce864c796b918fad36bbf1edd482f1edf878f88e51fc9ede51cc732e7d3df2c4146a746208701251ce00000000
</code></pre>
<p>这笔交易的重量是 396 vbytes。</p>
<p><strong>将它的重量与 SegWit v0 的单签名脚本交易相比较，我们可以看出它有约 10% 的体积缩减</strong>。</p>
<h2 id="2-of-2-的-P2WSH-vs-2-of-2-MuSig"><a href="#2-of-2-的-P2WSH-vs-2-of-2-MuSig" class="headerlink" title="2-of-2 的 P2WSH vs. 2-of-2 MuSig"></a>2-of-2 的 P2WSH vs. 2-of-2 MuSig</h2><p>Bitcoin Optech Taproot 工作坊给出了一个详解 2-of-2 MuSig 交易的绝佳例子，点出了使用 MuSig 相比传统的 P2WSH 2-of-2 多签名设置的好处。</p>
<p>这里我们会详尽地展示每一个案例，并比较最终的交易重量。最终的 2-of-2 P2WSH 交易的重量是 549，而最终的 2-of-2 MuSig 交易的重量只有 349（跟上面的单签名隔离见证 v1 交易一样）。这节约了近 28%。</p>
<h3 id="2-of-2-P2WSH"><a href="#2-of-2-P2WSH" class="headerlink" title="2-of-2 P2WSH"></a>2-of-2 P2WSH</h3><ol>
<li>生成一个 2-of-2 的 P2WSH 输出和地址。为此，我们要先生成两个公私钥对，以及一个多签名花费脚本。这个脚本的 SHA256 哈希值就是见证程序，并会跟版本号 <code>0x00</code> 一起生成 bech32 编码的发送地址。</li>
</ol>
<pre><code class="java">d1 = 0x2876e4fadeece50216d855e3815ce3ccc77b97d0e023abf5d2527183c30759d6
P1 = 0x0273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed

d2 = 0x32ba129753cb36df53626da1d89a5026ed5e13a71de71eace95850d97f189f3f
P2 = 0x02ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e

multisig script = [OP_2, P1, P2, OP_2, OP_CHECKMULTISIG]
multisig script = 52210273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed2102ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e52ae

program = SHA256(52210273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed2102ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e52ae)
program = 0x62bdb00923ba58c766b4399bdc8e42e5aaa6e8e26b1a4022fc4498a93f39b824
bech32 address = bcrt1qv27mqzfrhfvvwe458xdaerjzuk42d68zdvdyqghugjv2j0eehqjq68lm9r
</code></pre>
<p>我们先通过一笔隔离见证 v0 交易发送 1 btc 到这个地址：</p>
<pre><code class="java">0200000000010133109b8039aa3e727c8806321157af598808495422b1a61f52f98e90c8d035290000000000ffffffff0100e1f5050000000022002062bdb00923ba58c766b4399bdc8e42e5aaa6e8e26b1a4022fc4498a93f39b82402473044022073717413b96c99a3f915925a9053ff2944459a05241845444f9cc1f9e31c79cf02204229a4580e4c3d727197ab34a960bfd66efe994602e3e52469dfdcabbb56f703012102af229d0af30a53f5d8009f53e081c26e57582d01bab48a0e15d5f15984c5742900000000
</code></pre>
<p>这笔交易的 id 是： <code>0xd0faa3906f521839670df16adb1824b87e07e31d75f82757aeb675f1d80e02de</code>。</p>
<ol start="2">
<li>bech32 编码的接收地址使用同一个密钥对生成出来。</li>
</ol>
<pre><code class="java">bcrt1qpane38w0679vxm4dcvys4xgcf0lqzt99a5tc5d
</code></pre>
<ol start="3">
<li>现在，我们生成一笔待签名的隔离见证 v0 花费交易，花费我们上面的交易所生成的 UTXO、发送 0.5 btc 到接收地址。</li>
</ol>
<pre><code class="java">0100000001de020ed8f175b6ae5727f8751de3077eb82418db6af10d673918526f90a3fad00000000000000000000180f0fa02000000001600140f67989dcfd78ac36eadc3090a99184bfe012ca500000000
</code></pre>
<ol start="4">
<li>生成这笔待签名交易的隔离见证 v0 sighash。</li>
</ol>
<pre><code class="java">0x8da30679fd0b4f2012862539abc716b3d0c446820f21c66fbb5f31008d59c48f
</code></pre>
<ol start="5">
<li>使用上述的两把私钥生成两个 ECDSA 签名。</li>
</ol>
<pre><code class="java">sig1 = 30440220311f0ea149bc953e7f5b7f60aca0e2fad3816dd286d98dca4a0a649ffd686fb60220103ea52d3f3c5c11a67fd5afb33a7447b7f76bebd19f9ac67a01bfcd786f5a0901
sig2 = 3045022100d1d291d247ce598fba05b3b523c05297b5b4dcdc51d1a141612c0832048a0d5902202f97bbf7a7f3976c609d9dadf77fcc9
3bd2b01bd2b8949d6d269c85216ad791201
</code></pre>
<ol start="6">
<li>用这两个签名和多签名脚本构造见证数据。</li>
</ol>
<pre><code class="java">witness = sig1, sig2, multisig script
witness = 30440220311f0ea149bc953e7f5b7f60aca0e2fad3816dd286d98dca4a0a649ffd686fb60220103ea52d3f3c5c11a67fd5afb33a7447b7f76bebd19f9ac67a01bfcd786f5a0901,
3045022100d1d291d247ce598fba05b3b523c05297b5b4dcdc51d1a141612c0832048a0d5902202f97bbf7a7f3976c609d9dadf77fcc93bd2b01bd2b8949d6d269c85216ad791201,
52210273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed2102ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e52ae
</code></pre>
<ol start="7">
<li>然后完整的隔离见证 v0 花费交易就构造好了。</li>
</ol>
<pre><code class="java">01000000000101de020ed8f175b6ae5727f8751de3077eb82418db6af10d673918526f90a3fad00000000000000000000180f0fa02000000001600140f67989dcfd78ac36eadc3090a99184bfe012ca504004730440220311f0ea149bc953e7f5b7f60aca0e2fad3816dd286d98dca4a0a649ffd686fb60220103ea52d3f3c5c11a67fd5afb33a7447b7f76bebd19f9ac67a01bfcd786f5a0901483045022100d1d291d247ce598fba05b3b523c05297b5b4dcdc51d1a141612c0832048a0d5902202f97bbf7a7f3976c609d9dadf77fcc93bd2b01bd2b8949d6d269c85216ad7912014752210273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed2102ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e52ae00000000
</code></pre>
<p>这笔隔离见证 v0 交易的重量是 549。在下一节，我们会以隔离见证 v1 形式构造这笔交易（使用聚合 Schnorr 签名），并比较最终交易的重量。</p>
<h3 id="2-of-2-MuSig"><a href="#2-of-2-MuSig" class="headerlink" title="2-of-2 MuSig"></a>2-of-2 MuSig</h3><ol>
<li>使用跟上一例相同的私钥和公钥。这些密钥也用来生成相同的多签名脚本、见证程序、bech32 编码的发送地址</li>
</ol>
<pre><code class="java">d1 = 0x2876e4fadeece50216d855e3815ce3ccc77b97d0e023abf5d2527183c30759d6
P1 = 0x0273e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed

d2 = 0x32ba129753cb36df53626da1d89a5026ed5e13a71de71eace95850d97f189f3f
P2 = 0x02ed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e
</code></pre>
<ol start="2">
<li>为了防止相关的密钥攻击，每一个公钥都使用一个 <em>挑战因子</em> <code>c</code> 调整过，这个  <code>c</code> 跟参与的所有公钥有关，但每个参与者的 c 都是独一无二的。每个参与者都先哈希所有的公钥，将这个哈希值与自己的公钥相拼接，再对这个结果作 SHA256 运算，就得到了挑战因子。当我们有了每一个公钥的挑战因子，就可以生成出聚合公钥以及相应的地址。</li>
</ol>
<p>每一个参与者都必须能确定性地生成挑战因子，这意味着最初被哈希的公钥的顺序必须相同。为保证这一点，我们先去除公钥的前缀（ <code>0x02</code> 或 <code>0x03</code>），然后按从小到大的顺序排列（请记住公钥也是一个数）。排好序之后，它们就拼接起来，运行 SHA256 运算。我们管这个哈希值叫  <code>Lh</code> ，然后每个参与者都能用它算出自己的挑战因子。</p>
<pre><code class="java">Lh = SHA256(P1 || P2)

Lh = SHA256(73e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0eded714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e)

Lh = 0x62f6d67ea8270a2ff1e1a84596a500b8caf0128d3ff2bd78e9bea4ff66e31dd4
</code></pre>
<p>对公钥列表中的每一个公钥，挑战因子都可以用 <code>Lh</code> 以及对应的公钥拼接后作哈希运算计算出来（注意，公钥没有  <code>0x02</code> 或 <code>0x03</code> 的前缀）。</p>
<pre><code class="java">c₁ = SHA256(Lh || P₁)
c₁ = SHA256( 0x62f6d67ea8270a2ff1e1a84596a500b8caf0128d3ff2bd78e9bea4ff66e31dd4 || 0x73e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed)
c₁ = 0xecce388649143900eb4f2b107fcbde7d240336b7f4ad5c37c987701c0eb9159b

c₂ = SHA256(Lh + P₂)
c₂ = SHA256( 0x62f6d67ea8270a2ff1e1a84596a500b8caf0128d3ff2bd78e9bea4ff66e31dd4 || 0xed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e)
c₂ = 0x2b9449f654043b1920e5e17d89bf20d9e6e3e449b2f49122621b18d7756a495d
</code></pre>
<p>要创建聚合公钥，每个公钥都先乘以自己的挑战因子。这个相乘的步骤就是所谓的 “<em>调整</em> 公钥”。调整后的公钥，标记为  <code>P1&#39;</code> 和  <code>P2&#39;</code> ，加在一起，最终的结果就是聚合公钥  <code>P&#39;</code> 。如果最终的聚合公钥是一个负数，那么它将与每个挑战因子一起被求反。这里的聚合公钥是整数，所以不必求反。</p>
<pre><code class="java">P₁&#39; = P₁ * c₁
P₁&#39;  = 0x73e7ab3bcbd3194f01f9a60468cafc557d29043c3d230c98c57107e366ebd0ed * 0xecce388649143900eb4f2b107fcbde7d240336b7f4ad5c37c987701c0eb9159b
P₁&#39;  = 0x031601087da98f7b3afe201984821727f55cc3176278dbcbb1eabbbeb5695da454

P₂&#39; = P₂ * c₂ 
P₂&#39; = 0xed714a5d314dc046d39e07966425d7615c18e4dc787eccd963109308f9b34e5e * 0x2b9449f654043b1920e5e17d89bf20d9e6e3e449b2f49122621b18d7756a495d
P₂&#39; = 0x029294b0c19c018d1495339476a1901b16799c2d00eb7e6b96e85716bab5067348

P = P₁&#39; + P₂&#39;

P = 0x1601087da98f7b3afe201984821727f55cc3176278dbcbb1eabbbeb5695da454 + 0x9294b0c19c018d1495339476a1901b16799c2d00eb7e6b96e85716bab5067348

P = 0x03f2fe19e10684956111438fa7c69f953e91206d12553b8d898a7e0c43b8a93663
</code></pre>
<p>因为我们用调整过的公钥创建了聚合公钥，为了让私钥依然有效，私钥也必须用同样的因子来调整。</p>
<pre><code class="java">d₁&#39; = d₁ * c₁
d₁&#39; = 0x2876e4fadeece50216d855e3815ce3ccc77b97d0e023abf5d2527183c30759d6 * 0xecce388649143900eb4f2b107fcbde7d240336b7f4ad5c37c987701c0eb9159b
d₁&#39; = 0x07cd6d2b4ab956d89bbdf36d6a2b8e27023042ea173f786a9cd86bcdc8cab1dc

d₂&#39; = d₂ * c₂
d₂&#39; = 0x32ba129753cb36df53626da1d89a5026ed5e13a71de71eace95850d97f189f3f * 0x2b9449f654043b1920e5e17d89bf20d9e6e3e449b2f49122621b18d7756a495d
d₂&#39; = 0xb05127d427a5422eb473ea9f90622acbebd5d87065aef83fc5d7e4e93a94ac23
</code></pre>
<p>见证程序依然是公钥的 x 值，只不过这里我们使用了聚合公钥：</p>
<pre><code class="java">witness program = P&#39;.x
witness program = 0xf2fe19e10684956111438fa7c69f953e91206d12553b8d898a7e0c43b8a93663
</code></pre>
<p>现在，我们可以使用见证程序和隔离见证 v1 版本号（ <code>0x01</code> ）推导出 bech32 编码的隔离见证 v1 发送地址了。</p>
<pre><code class="java">bcrt1p7tlpncgxsj2kzy2r37nud8u486gjqmgj25acmzv20cxy8w9fxe3s4evuhr
</code></pre>
<ol start="3">
<li>接收地址也使用这个聚合公钥生成出来。</li>
</ol>
<pre><code class="java">bcrt1qye7d8y5v63uan3kaer5f5a83rkvzt0qajlzm38
</code></pre>
<ol start="4">
<li>创建出待签名的交易，该交易将把发送地址的 0.5 btc 发送到接收地址。</li>
</ol>
<pre><code class="java">0100000001868e26971f2460b6e2f01aadfdc075ba5518fbd9afb1b0ba11396a55399eae650000000000000000000180f0fa0200000000160014267cd3928cd479d9c6ddc8e89a74f11d9825bc1d00000000
</code></pre>
<ol start="5">
<li>用上文 “隔离见证 v1：单签名” 章节中的步骤 5 相同的方法创建隔离见证 v1 待签名交易 sighash。</li>
</ol>
<pre><code class="bach">sighash = 0xab73194e488ee26cf6dd58d2be4b40f969b5647f902e6be19688db491f1959c6
</code></pre>
<p>有一部分的推导需要用到被花费的 UTXO 的锁定脚本：</p>
<pre><code class="java">locking script of UTXO being consumed 225120f2fe19e10684956111438fa7c69f953e91206d12553b8d898a7e0c43b8a93663
</code></pre>
<ol start="6">
<li>Schnorr 聚合签名的形式与 Schnorr 单签名的形式没有什么区别，只不过使用了聚合数值。</li>
</ol>
<pre><code class="java">s&#39; = k&#39; + e * d&#39; mod n
</code></pre>
<p>每个 nonce 都是一个随机的私钥，其对应的公钥就是 nonce 点。如果公钥的 y 值<strong>不是</strong>对域大小求模的二次剩余，就设定 k 等于阶数 n 与 k 的差值。</p>
<pre><code class="java">k₁ = 0x43ae27db41923ba9268683ba53feaa517eabec8b5db62a1612045656dbf64744
R₁ = (0xb642edebb19b616054e945b8dfb9a215dbe56ecaa869cebf0c97c368db35ed48, 0x6a3bf699a3f17b7007ad8f14349270df6b63007ac4ee585104e9af5e9dc9377a)

k₂ = 0x5a7dc060ae2a65a22ddc9e5d10b6b51ee588d0a6c8436014ebc4bae0a4ddb023
R₂ = (0x95c86d7887190be800d05cba00fd44b9805daf7e6eb39a1811a7aa3cccb3c743, 0xef833128e30b2a06eadb6c86ce1e63c150af91fe171a8bfe5e979db83da5355c)
</code></pre>
<p>在这个例子里面，两个 k 都不是，所以我们要更新这两个 nonce 点。</p>
<pre><code class="java">k₁ = n - k₁
k₁ = 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141- 0x43ae27db41923ba9268683ba53feaa517eabec8b5db62a1612045656dbf64744
k₁ = 0xbc51d824be6dc456d9797c45ac0155ad3c02f05b51927625adce0835f43ff9fd

k₂ = n - k₂
k₂ = 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141-0x5a7dc060ae2a65a22ddc9e5d10b6b51ee588d0a6c8436014ebc4bae0a4ddb023
k₂ = 0xa5823f9f51d59a5dd22361a2ef494adfd5260c3fe7054026d40da3ac2b58911e
</code></pre>
<p>生成最终的 nonce 值和 nonce 点（带有  <code>0x03</code> 字节前缀的 x 值）。</p>
<pre><code class="c">k₁ = 0xbc51d824be6dc456d9797c45ac0155ad3c02f05b51927625adce0835f43ff9fd
R₁ = 0x03b642edebb19b616054e945b8dfb9a215dbe56ecaa869cebf0c97c368db35ed48

k₂ = 0xa5823f9f51d59a5dd22361a2ef494adfd5260c3fe7054026d40da3ac2b58911e
R₂ = 0x0395c86d7887190be800d05cba00fd44b9805daf7e6eb39a1811a7aa3cccb3c743
</code></pre>
<p>现在，两个 nonce 和 nonce 点都生成好了，聚合 nonce 值和 nonce 点也可以生成出来了。</p>
<p>聚合 nonce 点  <code>R&#39;</code> 是两个 nonce 点的 x 坐标值之和。检查聚合 nonce 点的 y 坐标值<strong>不是</strong>对域大小求模的二次方剩余。如果是，就对  <code>R&#39;</code> 和 <code>k1</code> 及 <code>k2</code> 求反。在这个例子中我们不必求反。</p>
<pre><code class="c++">R&#39; = k₁ + k₂
R&#39; = 0x03b642edebb19b616054e945b8dfb9a215dbe56ecaa869cebf0c97c368db35ed48 + 0x0395c86d7887190be800d05cba00fd44b9805daf7e6eb39a1811a7aa3cccb3c743
R&#39; = 0x02338b807352528dc74d83bb717f5560ef34f8c94b340f4867d0129a2107e228a7
</code></pre>
<p> <code>e</code> 是拼接 nonce 点的 x 坐标值  <code>R&#39;.X</code> 、聚合公钥 x 坐标值 <code>P&#39;.x</code> 以及消息（sighash）后，使用名为 <code>BIPSchnorr</code> 的带标签哈希算法推导出来的。</p>
<pre><code class="java">e = tagged hash(BIPSchnorr || R&#39;.x + P&#39;.x + sighash)
e = 0x8d507fb1955660ee2180917046f767d2c2a174a497348268a8af0aed2c7dd9f7
</code></pre>
<p>现在，我们已经有了让每一个参与者各自创建 Schnorr 签名的一切元素了。</p>
<pre><code class="java">s&#39;₁ = k₁ + e * d&#39;₁ mod n
s&#39;₁ = 0xbc51d824be6dc456d9797c45ac0155ad3c02f05b51927625adce0835f43ff9fd + 0x8d507fb1955660ee2180917046f767d2c2a174a497348268a8af0aed2c7dd9f7 * 0x07cd6d2b4ab956d89bbdf36d6a2b8e27023042ea173f786a9cd86bcdc8cab1dc
s&#39;₁ = 0xfe37255454d8e26b4ff666b93f36588522c796ac2e3e45c7cd4a6699120cae09

s&#39;₂ = k₂ + e * d&#39;₂ mod n
s&#39;₂ = 0xa5823f9f51d59a5dd22361a2ef494adfd5260c3fe7054026d40da3ac2b58911e + 0x8d507fb1955660ee2180917046f767d2c2a174a497348268a8af0aed2c7dd9f7 * 0xb05127d427a5422eb473ea9f90622acbebd5d87065aef83fc5d7e4e93a94ac23
s&#39;₂ = 0xfe37255454d8e26b4ff666b93f36588522c796ac2e3e45c7cd4a6699120cae09
</code></pre>
<p>最后，我们聚合每个参与者的签名，产生聚合公钥的最终签名。</p>
<pre><code class="java">s&#39; = s&#39;₁ + s&#39;₂ mod n
s&#39; = 0xfe37255454d8e26b4ff666b93f36588522c796ac2e3e45c7cd4a6699120cae09 + 0xfe37255454d8e26b4ff666b93f36588522c796ac2e3e45c7cd4a6699120cae09 mod 0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141
s&#39; = 0xc77d4dad11f338b0e05f76b67dfa06b769d12572160adc45767172673d242493

sig&#39; = R&#39;.x || s&#39;
sig&#39; = 338b807352528dc74d83bb717f5560ef34f8c94b340f4867d0129a2107e228a7c77d4dad11f338b0e05f76b67dfa06b769d12572160adc45767172673d242493
</code></pre>
<p>最终签好名的交易如下所示：</p>
<pre><code class="typescript">01000000000101868e26971f2460b6e2f01aadfdc075ba5518fbd9afb1b0ba11396a55399eae650000000000000000000180f0fa0200000000160014267cd3928cd479d9c6ddc8e89a74f11d9825bc1d0140338b807352528dc74d83bb717f5560ef34f8c94b340f4867d0129a2107e228a7c77d4dad11f338b0e05f76b67dfa06b769d12572160adc45767172673d24249300000000
</code></pre>
<p>这笔交易的重量是 396。</p>
<p><strong>比较可知，隔离见证 v1 的交易比起隔离见证 v0 的 2-of-2 P2WSH交易，可以节省 28% 的交易体积</strong>。</p>
<p style="text-align:center">- - -</p>


<h2 id="进阶研究"><a href="#进阶研究" class="headerlink" title="进阶研究"></a>进阶研究</h2><ul>
<li><a target="_blank" rel="noopener" href="https://bitcoinops.org/workshops/#taproot-workshop">Bitcoin Optech Schnorr&#x2F;Taproot 研讨会</a>是一个非常棒的资源，可以学到更多关于签名和交易的内容，还能上手玩耍。最新的分支是  <code>32-bytes-keys</code> 分支。在本地克隆时请使用 <code>Taproot_V0.1.5-proposed</code> 分支。在这个分支上开发并保证你启用了钱包。</li>
<li><a target="_blank" rel="noopener" href="https://bitcoinops.org/en/topics/taproot/">Bitcoin Optech: Taproot</a></li>
<li>Murch’s <a target="_blank" rel="noopener" href="https://murchandamus.medium.com/2-of-3-multisig-inputs-using-pay-to-taproot-d5faf2312ba3">2-of-3 inputs using Pay-to-Taproot</a></li>
<li><a target="_blank" rel="noopener" href="http://diyhpl.us/~bryan/papers2/bitcoin/bitcoin-tech-dev-talks-schnorr-signatures.2018-02-01.pdf">Bitcoin Technology Development Talks: Schnorr signatures</a></li>
</ul>
<p style="text-align:center">- - -</p>


<p>衷心感谢 Valentine Wallace、Mark Erhardt、Carl Dong 和 Harry Sudock 的反馈。</p>
<p style="text-align:center">- - -</p>


<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>[1]: Pieter Wuille, Jonas Nick, Tim Ruffing. (January 19, 2020). <em>Schnorr Signatures for secp256k1</em>. <a target="_blank" rel="noopener" href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki#design">https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki</a>.</p>
<p>[2]: Pieter Wuille, Jonas Nick, Anthony Towns. (January 19, 2020).<em>Taproot: SegWit version 1 spending rules</em>. <a target="_blank" rel="noopener" href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki#design">https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki</a>.</p>
<p>[3]: Pieter Wuille, Jonas Nick, Anthony Towns. (January 19, 2020). <em>Validation of Taproot Scripts</em>. <a target="_blank" rel="noopener" href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki#design">https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki</a>.</p>
<p>[4]: Bitcoin Optech. (October 29, 2019). Bitcoin Optech Schnorr Taproot Workshop. <a target="_blank" rel="noopener" href="https://bitcoinops.org/en/schorr-taproot-workshop/">https://bitcoinops.org/en/schorr-taproot-workshop/</a>.</p>
<p>[5]: Bitcoin Wiki. (April 24, 2019). Secp256k1. <a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Secp256k1">https://en.bitcoin.it/wiki/Secp256k1</a>.</p>
<p>[6]: Wolfram MathWold. (2021). Weierstrass Form. <a target="_blank" rel="noopener" href="https://mathworld.wolfram.com/WeierstrassForm.html">https://mathworld.wolfram.com/WeierstrassForm.html</a>.</p>
<p>[7]: Wikipedia. (February 19, 2021). Jacobi symbol. <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Jacobi_symbol">https://en.wikipedia.org/wiki/Jacobi_symbol</a>.</p>
<p>[8]: Bitcoin Optech. (October 29, 2019). Bitcoin Optech Schnorr Taproot Workshop: 2.1 segiwth version 1. <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/bitcoinops/taproot-workshop/blob/Colab/2.1-segwit-version-1.ipynb#scrollTo=FviLk51twL_X">https://colab.research.google.com/github/bitcoinops/taproot-workshop/blob/Colab/2.1-segwit-version-1.ipynb#scrollTo=FviLk51twL_X</a>.</p>
<p>（完）</p>
</article></div></div></main><script src="/js/post.js?v=1676011583086"></script><script src="/js/highlight.min.js?v=1676011583086"></script><script>var containerEl = document.querySelector('.post-container');
var postFontSize = localStorage.getItem('post-font-size') || '16';
var inputEl = document.querySelector('#size-change-input');
var inputEl2 = document.querySelector('#size-change-input2');
inputEl.value = postFontSize;
inputEl2.value = postFontSize;
containerEl.style.fontSize = postFontSize + 'px';
$(function(){
  function setSizeChangeInputValue(size) {
    $('.post-container').css('font-size', size + 'px');
    localStorage.setItem('post-font-size', size);
    $('#size-change-input').val(size);
    $('#size-change-input2').val(size);
  }
  $('#size-change-input').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
  $('#size-change-input2').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
});
</script><script>hljs.initHighlightingOnLoad();</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/btcstudy">Twitter</a><!-- Github--><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml">rss</a><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/btcstudyorg">Telegram</a></section></footer><script async src="/js/buttons.js?v=1676011583086"></script><script async src="/js/index.js?v=1676011583086"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-JVCJ9XXG1Z');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306";
  hm.async = true;
  hm.defer = true;
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script></body></html>