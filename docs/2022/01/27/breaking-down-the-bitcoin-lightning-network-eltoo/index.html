<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>Eltoo 详解</title><meta name="keywords" content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name="description" content="比特币思想的中文集结地"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css?v=1673594423018"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/style/common/iconfont.css?v=1673594423018"><link rel="stylesheet" href="/style/base.css?v=1673594423018"><link rel="stylesheet" href="/style/common/helper.css?v=1673594423018"><link rel="stylesheet" href="/style/themes/animation.css?v=1673594423018"><script>function ready() {
  var bodyEl = document.querySelector('.body-container');
  var theme = localStorage.getItem('theme') || 'light';
  if (!['light', 'dark'].includes(theme)) {
    theme = 'light';
    localStorage.setItem('theme', 'light');
  }
  bodyEl.classList.remove('appearance-auto');
  bodyEl.classList.add('appearance-' + theme);
  quickInitialTheme();
}
function quickInitialTheme() {
  var theme = localStorage.getItem('theme') || 'light';
  var logoLightEl = document.querySelector('.logo-light');
  var logoDarkEl = document.querySelector('.logo-dark');
  
  var mLogoLightEl = document.querySelector('#mobile-header-logo > .logo-light');
  var mLogoDarkEl = document.querySelector('#mobile-header-logo > .logo-dark');
  var themeBtnEl = document.getElementById('theme-btn');
  
  var slideThemeLightEl = document.querySelector('.slide-theme-light');
  var slideThemeDarkEl = document.querySelector('.slide-theme-dark');
  
  document.body.classList.add(theme);
  if (theme === 'dark') {
    logoLightEl.classList.add('hidden');
    logoDarkEl.classList.remove('hidden');
    
    mLogoLightEl.classList.add('hidden');
    mLogoDarkEl.classList.remove('hidden');
    
    themeBtnEl.classList.remove('icon-icon_dark');
    themeBtnEl.classList.add('icon-icon_light');
    
    slideThemeLightEl.classList.remove('hidden');
  } else {
    slideThemeDarkEl.classList.remove('hidden');
  }
}
document.addEventListener("DOMContentLoaded", ready);</script><script src="/js/common.js?v=1673594423018"></script><script src="/js/libs/zepto.min.js"></script><link rel="stylesheet" href="/style/post.css?v=1673594423018"><link rel="stylesheet" href="/style/themes/highlight.css?v=1673594423018"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="BTC Study" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column" onload="initialTheme()"><div class="clip"></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id="header"><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href="/"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id="header-menu"><a class="is-inline-block header-activity mr-4" href="/">首页</a><a class="is-inline-block mr-4" href="/archives">全站目录</a><a class="is-inline-block mr-4" href="/tags">标签</a><a class="is-inline-block mr-4" href="/maps">地图</a><a class="is-inline-block mr-4" href="/mempool">mempool</a><a class="is-inline-block mr-4" target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input" type="range" min="12" max="32" step="2"></div></div></div><i class="iconfont icon-icon_dark mr-1" id="theme-btn"></i><div class="search-wrap"><input class="pl-3" id="search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search" id="search-input-btn"></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Eltoo 详解</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn2"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input2" type="range" min="12" max="32" step="2"></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id="mobile-header"><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id="mobile-header-logo"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopicMobile"><p class="is-full-height">Eltoo 详解</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class="mobile-search-wrap"><div class="search-input"><input class="pl-3" id="mobile-search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class="mobile-search-input-btn">搜 索</button></div></div></header><div class="mobile-slide-menu"><a class="header-activity" href="/">首页</a><a href="/archives">全站目录</a><a href="/tags">标签</a><a href="/maps">地图</a><a href="/mempool">mempool</a><a target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class="slide-menu-fontsize"><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1673594423018"> </script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E9%80%9A%E9%81%93"><span class="toc-text">单向通道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E9%80%9A%E9%81%93%E7%9A%84%E9%9A%BE%E9%A2%98"><span class="toc-text">双向通道的难题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eltoo"><span class="toc-text">eltoo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-text">排序问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id="postTitle">Eltoo 详解</h1><div class="page-author"><div class="is-flex is-flex-direction-row page-data mr-6"><img class="mr-1" src="//res.btcstudy.org/btcstudy/images/default_avatar.png" alt="Brandon Arvanaghi"><div class="page-author-info"><strong>Brandon Arvanaghi</strong><time class="has-text-grey" datetime="2022-01-27T09:51:34.000Z">2022-01-27</time></div></div><div class="is-flex"><a href="/tags/%E9%97%AA%E7%94%B5%E7%BD%91%E7%BB%9C"><i class="page-tag mr-1 px-1">闪电网络<!-- 订正图片路径--></i></a><a href="/tags/Eltoo"><i class="page-tag mr-1 px-1">Eltoo<!-- 订正图片路径--></i></a></div></div><article class="mt-4 post-content"><blockquote>
<p><em>作者：Brandon Arvanaghi</em></p>
<p><em>来源：<a target="_blank" rel="noopener" href="https://medium.com/@brandonarvanaghi/breaking-down-the-bitcoin-lightning-network-eltoo-c48554f5ae02">https://medium.com/@brandonarvanaghi/breaking-down-the-bitcoin-lightning-network-eltoo-c48554f5ae02</a></em></p>
</blockquote>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/Nsl4OZQ.png" alt="img"></p>
<p style="text-align:center">- 图片来源：Eltoo 白皮书 -</p>


<p>闪电网络是一种 Layer 2 解决方案，让你可以跟其他比特币友创建微支付通道。它让即时、免信任的交易成为可能，并且只需在链上保留少量数据。</p>
<p>本文中，我将详细解释它是怎么工作的，以及一种新提出来的升级协议，叫做 “eltoo”（跟 “L2” 同音）。</p>
<h2 id="单向通道"><a href="#单向通道" class="headerlink" title="单向通道"></a>单向通道</h2><p>单向的支付通道是最容易实现的，因为资金只会往一个方向流动。最常见的应用场景是川流支付（streaming money），比如，每多付一点钱就可以看多一分钟的视频。</p>
<p>假设你要跟奈飞（Netflix）开启这样一个通道。首先，你创建一笔<strong>充值交易</strong>，就是锁定一些你想支付给奈飞的钱（但还不会立即支付给他们）。</p>
<p>假设你将一笔锁定 10 BTC 充值交易发到了比特币区块链上。该交易的输出资金项可被一个 2-2 的多签名（你的签名和奈飞的签名一起）花费。</p>
<p>奈飞开始给你播放流媒体视频时，你也就开始给他们付费 —— 假设你需要为每分钟的视频支付 0.000001 BTC —— 手法就是为花费充值交易的交易提供你的签名。</p>
<p>使用充值交易作为输入，创建两个新的输出：一个输出是给奈飞发送 0.000001 BTC，另一个输出是给自己发送 9.999999 BTC。给这笔交易签名后你把交易和签名在链下分享给奈飞（也就是说，你不会把它发到比特币区块链上）。这笔交易被认为是 “部分签名的”，正是因为它只包含了你个签名 —— 使之有效的两个必要签名中的一个。</p>
<p>当奈飞收到这笔部分签名的交易时，他可以有所选择。他可以选择加上自己的签名、把交易发送到比特币网络上、立即拿走这 0.000001 BTC（同时把 9.999999 BTC 发送给你）。这就成了 <em>关闭通道</em> 或者说 <em>结算交易</em>。</p>
<p>不过，只要你每次都提供数额更大的部分签名交易，奈飞就会继续给你播放视频。比如，一分钟过后，你要给奈飞发送另一笔部分签名的交易、但同样使用充值交易作为输入。这个部分签名的交易将给奈飞发送 0.000002 BTC、给你自己发送 9.999999 BTC。以此类推。</p>
<p>单向的支付通道中是没有欺诈的。如果你停止给奈飞发送支付数额更高的部分签名交易，奈飞就会停止给你传输视频。他们会签名你发给他们的最近的一笔部分签名交易（也就是给他们支付最多比特币的一笔）、发送到比特币区块链上，从而关闭这个通道。</p>
<p>更进一步地，也没有人会想发布一笔 “过时” 的交易。因为奈飞是唯一一个有能力补完部分签名的交易、使之成为有效交易的实体（因为奈飞有你的签名，但你没有奈飞的签名），而每一笔更新的你发给奈飞的交易，都会给奈飞带来更大的好处。要是奈飞广播了更早的一笔交易，那是搬起石头砸自己的脚。</p>
<p>但如果资金会双向流动，事情就会变得更加棘手。双方都可以广播交易，所以广播一个过时交易的动机是始终存在的。</p>
<h2 id="双向通道的难题"><a href="#双向通道的难题" class="headerlink" title="双向通道的难题"></a>双向通道的难题</h2><p>假设 Alice 和 Bob 开启了一个支付通道，双方都在充值交易中锁入了 0.5 BTC。现在 Alice 同意给 Bob 支付 0.1 BTC 的洗车费。她给 Bob 发了一笔使用充值交易作为输入、有两个输出的部分签名交易：一个输出给自己支付 0.4 BTC，另一个输出给 Bob 支付 0.6 BTC。</p>
<p>Bob 收到交易后如果不广播出去，通道就继续保持开启状态。他后来同意给 Alice 支付 0.3 BTC 的打印费。</p>
<p>如果 Bob 给 Alice 发送了一笔使用充值交易作为输入的部分签名交易，那么，现在就有了两笔交易，这两笔交易是不同的，但都花费了同一笔充值交易，也都可以成为有效的交易。因为交易在比特币上没有超时日期，所以这两笔交易的有效性都是永久的。</p>
<p>他们可能会继续来回交换部分签名的交易，来获得商品或服务；但这不是关键。关键在于，他们中的任何一方都有可能会发布更早的交易（给自己支付更多比特币的交易），从而关闭通道，并让其它所有签名交易失效。这就是所谓的恶意行为。</p>
<p>双向通道需要一种办法来 <em>作废过时的交易</em>，使得 <em>只有最近的签名交易</em> 才可以用来关闭通道。这也是 <em>eltoo</em> 的用意。</p>
<h2 id="eltoo"><a href="#eltoo" class="headerlink" title="eltoo"></a>eltoo</h2><p>闪电网络中的双向支付通道在今天可以上手即用，是因为<a target="_blank" rel="noopener" href="https://lightning.network/lightning-network-paper.pdf">闪电网络白皮书</a>创建了一种可用的协议来作废过期交易。这套协议叫做 “LN-Penalty”，即惩罚尝试发布过时交易的参与者、让对方可以拿走欺诈方所有的比特币。</p>
<p>虽然 LN-Penalty 在今天是可以工作的，它也存在一些问题。除了它自身的复杂性，还有一些罕见的情形，它可能会意外地惩罚诚实的用户。<a target="_blank" rel="noopener" href="https://blockstream.com/eltoo.pdf"><em>eltoo</em></a> 当前还不可用，因为它依赖一种还在提议阶段的签名方案 <a target="_blank" rel="noopener" href="https://github.com/bitcoin/bips/blob/master/bip-0118.mediawiki"><em>SIGHASH_NOINPUT</em></a>（译者注：该文撰写于 2019 年。至翻译之时，BIP-118 早已经改名为 “SIGHASH_ANYPREVOUT”，下文将沿用这个新名称），而这套方案还未被接受，但因为它不是基于惩罚的，所以也不会有意外惩罚的风险。</p>
<p>在 eltoo 中，双方在下图所示的 <strong>Setup</strong> 阶段创建充值交易。充值交易可能会包含来自双方的比特币，因为我们预期资金会双向流动。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/mnYz6gw.png" alt="img"></p>
<p style="text-align:center">- 每个圆都代表着一个交易输出。图片来自 eltoo 白皮书 -</p>


<p>在签名充值交易之前，Alice 和 Bob 先签名一笔 <em>结算交易</em>（上图中的 <strong>Ts,0</strong>），它会将充值交易中的比特币原样返回给双方。在 eltoo 中，“结算交易” 这个术语指代任何将资金分配给参与者双方（而不是他们共同控制的多签名输出）的交易。</p>
<p>在签名第一笔结算交易之后，双方可以安全地签名充值交易。充值交易的锁定逻辑如下：</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/P11YXyw.png" alt="img"></p>
<p style="text-align:center">- 充值交易以及所有状态更新交易的锁定逻辑。图片来自 eltoo 白皮书 -</p>


<p>有两种办法可以花费充值交易：一个是 <em>IF</em> 分支，另一个是 <em>ELSE</em> 分支。这两个路径依赖于两组不同的密钥：IF 分支需要 <em>结算密钥</em>；而 ELSE 分支需要 <em>状态更新密钥</em>。</p>
<p>你可能注意到了，锁定脚本的结算分支（IF 分支）包含 <strong>10 OP_CSV</strong>（OP_CHECKSEQUENCEVERIFY 的缩写）作为第一个指令。任何尝试通过 IF 分支来花费这笔充值交易的操作，都只有等充值交易记录在比特币区块链上之后的 10 个区块以后才能生效。如果 Alice 和 Bob 交换了结算交易的签名、让充值交易上链之后，立即广播结算交易，那么这笔结算交易要等 10 个区块以后才能挖出并产生归还相应资金的效果。</p>
<p style="text-align:center">- - -</p>


<p>假设 Alice 和 Bob 不想结束通道。Alice 想给 Bob 发送 1 BTC，所以他们的新余额将是 Alie 拥有 4 BTC、Bob 拥有 6 BTC.</p>
<p>Alice 和 Bob 最先做的事情是交换一笔 <em>新的</em> 结算交易的签名。这笔新的结算交易将给只有 Alice 能控制的地址支付 4 BTC，给只有 Bob 能控制的地址支付 6 BTC。</p>
<p>这里就到了 eltoo 的关键：这笔新的结算交易不需要花费充值交易。相反，它花费的是一笔 Alice 和 Bob 还没构造出来的输出：一笔 <em>状态更新交易</em>。</p>
<p>状态更新交易的目的实际上就是多重花费充值交易，这样最开始的那笔结算交易（Alice 和 Bob 都签过名的、必须等待 10 个区块后才能上链的那个）就没用了。</p>
<p>回想一下充值交易的锁定脚本：</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/P11YXyw.png" alt="img"></p>
<p style="text-align:center">- 充值交易的锁定脚本 -</p>


<p>虽然结算分支有 10 个区块的延迟，但 <em>更新分支</em>（ELSE 分支）没有。只要 Alice 和 Bob 交换了他们相应的 <em>状态更新</em> 密钥的签名，他们可以在结算交易还未能生效之前立即通过更新分支来花费充值交易。</p>
<p>在 Alice 和 Bob 签名新的结算交易（给 Alice 的结算密钥支付 4 BTC、给 Bob 的结算密钥支付 6 BTC）之后，他们交换相应状态更新密钥的签名来创建状态更新交易。如此一来，旧的结算交易（按初始余额给双方退还资金的交易）就变得没有意义了，而新的结算交易 —— 它会花费当前要创建的状态更新交易 —— 是唯一一个能触发结算的交易。</p>
<p>如图所示，创建状态更新交易和结算交易的过程可以像上面说的这样无限持续下去。最新的结算交易 <strong>Ts, i</strong> 是唯一一笔有意义的结算交易，因为 Alice 和 Bob 签名了一连串立即就可以广播的更新交易，保证了没有一个更早的结算交易可以生效。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/mnYz6gw.png" alt="img"></p>
<p style="text-align:center">- 每个圆都代表着一个交易输出。图片来自 eltoo 白皮书 -</p>


<p style="text-align:center">- - -</p>


<p>你应该也想到了，这个模型理论上是能够工作的，但它需要把每一笔状态更新交易都发布到比特币区块链上。这就跟闪电网络的初衷相违背了，闪电网络本身是想通过在链下发生交易来减少上链的数据的。</p>
<p>这就是我们需要 <strong>SIGHASH_ANYPREVOUT</strong> 的地方。<strong>SIGHASH_ANYPREVOUT</strong> 让你可以无需把整条状态更新交易的链条发布在链上，你可以跳过所有中间的状态更新交易，只发布最后一个你需要的。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/XPty2XQ.png" alt="img"></p>
<p style="text-align:center">- SIGHASH_ANYPREVOUT 允许 “绑定” 到任何更早的交易上 -</p>


<p>虽然一个输出的锁定脚本可以指定 <em>具体的哪那一组私钥</em> 是花费它的必要条件，它并未指定 <em>签名里面要包含什么</em>。一般来说，你会签名自己的交易中的所有输入和输出，并通过 <strong>SIGHASH_ALL</strong> 来告知比特币节点你做了什么操作。SIGHASH_ALL 意味着，你向所有的比特币节点表示，你的交易只有在包含你的签名承诺的特定的输入输出组合时，才是有效的。你是在告诉比特币节点，你的交易中如果出现了偏离签名的任何其它组合 —— 输入不同、输出的数额稍有不同，等等 —— 就都是无效的。</p>
<p>而在 <strong>SIGHASH_ANYPREVOUT</strong> 模式下，你可以创建一笔 “自由浮动” 的交易。你是在向检查你的交易的比特币节点宣布，你 <em>不在乎</em> 你的交易的输入是哪个 —— 你只在乎输出。所以，你的签名，对需要用你的私钥来花费的 <em>任意尚未花费的输入</em>，都是有效的 —— 花它们中的任何一个你都无所谓。</p>
<p>如上图所示，使用 <strong>SIGHASH_ANYPREVOUT</strong> 标签，你可以把最新一笔状态更新交易绑定到充值交易上。最后一笔状态更新交易已经被签名了，而且，虽然它一开始将输入指向前一笔状态更新交易，我们可以改变它所花费的 UTXO 而不使其签名作废，因为我们使用  <strong>SIGHASH_ANYPREVOUT</strong> 明确地指定了，输入与该签名的有效性无关。所有其它状态更新交易都可以被安全地跳过。</p>
<p>因此，自始至终，只有三笔交易需要发布到链上：充值交易、最新一笔状态更新交易以及最后一笔结算交易；结算交易将通过花费最新一笔状态更新交易来为双方分发最后的余额。</p>
<p style="text-align:center">- - -</p>


<h2 id="排序问题"><a href="#排序问题" class="headerlink" title="排序问题"></a>排序问题</h2><p>你可能会想到，自由浮动交易可能产生问题。如果最新的状态更新交易可以被绑定到任何早先的更新交易（包括充值交易上），那么反过来说也成了：任何早先的更新交易也可以绑定到最后一笔更新交易上。这会使最后的更新交易无效！</p>
<p>为了解决这个问题，eltoo 很聪明地在其锁定脚本中加入了一个 <em>状态号</em> 的概念。它维持着更新交易之间的次序，使得更新交易只能无差别地绑定到 <em>早前的交易</em>，但不能绑定到 <em>更新的交易</em>。我们来看看调整后的更新交易的锁定脚本：</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/P11YXyw.png" alt="img"></p>
<p style="text-align:center">- 充值交易的锁定脚本 -</p>


<p>ELSE 分支是为状态更新交易设置的，其第一个指令是：</p>
<blockquote>
<p> <strong>&lt;Si + 1&gt; OP_CHECKLOCKTIMEVERIFY</strong> [缩写为 OP_CLTV]</p>
</blockquote>
<p>OP_CLTV 是一个未花费的输出检查尝试花费它的交易的 <strong>nLockTime</strong> 。当你提交的交易的 nLockTime 设成大于 5 亿时，比特币会把它解释成一个 Unix 时间戳。也就是说，花费交易无法在这个时间之前挖出。小于 5 亿的数值则会被解释成最小区块高度，在这个区块高度以前，这笔交易无法挖出。</p>
<p>但这里有一个很聪明的技巧！如果你让 <em>nLockTime</em> 大于 0 但是小于 5 亿，<em>同时</em> 小于比特币的区块高度，那么你发布的交易可以立即上链。它违背了 nLockTime 用来推迟交易上链时机的初衷，但我们可以使用这个范围内的所有值来为状态更新交易排列顺序，同时无须推迟其挖出的时间。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/mnYz6gw.png" alt="img"></p>
<p>假设充值交易指定了 <em>OP_CLTV</em>  为 1，则第一笔状态更新交易，标记为 <strong>Tu, 1</strong>，将需要把 nLockTime 设得大于 1。这样，Alice 和 Bob 就可以确认下一笔状态更新交易的 nLockTime 至少是 1。第一笔状态更新交易的输出将在锁定脚本中指定 <em>OP_CLTV</em> 为 2；下一笔更新交易指定为 3，以此类推。</p>
<p>现在，假设 Alice 和 Bob 尝试绑定第一笔更新交易到更晚形成的一个输出 —— 比如按顺序是第三个输出（第三笔状态更新交易形成的输出） —— 上，那比特币区块链会拒绝它，因为第一笔更新交易的 nLockTime 是 1，而第三个输出要求 nLockTime 至少是 3。</p>
<p>这样一来，虽然所有的状态更新交易都是用 <strong>SIGHASH_ANYPREVOUT</strong> 签名的，更早的状态更新交易无法绑定到更晚的状态更新交易商上，因为它们的 nLockTime 将低于更新输出的锁定脚本的 <em>OP_CLTV</em> 要求。这一设计保护了最后一笔结算交易（记为 <strong>Ts, i</strong>）的有效性。</p>
<p>结算交易也必须使用 <strong>SIGHASH_ANYPREVOUT</strong>。因为，如果它所花费的交易改变了输入（从指向上一笔状态更新交易变成指向了充值交易，正是通道关闭时发生的事情），它所花费的交易的 ID 会改变，因为交易输入是决定交易 ID 的一部分。因此，任何结算交易都必须有能力处理前序交易 ID 改变带来的影响。</p>
<p>不过，你可能会注意到，锁定脚本的结算分支并不包含状态号。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/breaking-down-the-bitcoin-lightning-network-eltoo/P11YXyw.png" alt="img"></p>
<p style="text-align:center">- 充值交易以及所有状态更新交易的锁定脚本 -</p>


<p>乍看起来，它会导致我们前面讲到的同样的问题：旧的结算交易可以花费后来才形成的状态更新交易，造成结算交易竞争进入区块链的赛跑（race condition）。</p>
<p>但是，这里的解决方案不是使用状态号，而是每一笔结算交易都使用 <em>从它所花费的状态更新交易的状态号里推导出来的不同密钥对</em>。因此，一方面，结算交易通过使用 <strong>SIGHASH_ANYPREVOUT</strong> 保持了改变状态更新交易 ID 也不会使签名作废的能力，另一方面，这些签名又只能用来花费 <em>特定的输出</em>，因为生成这些签名的密钥对 <em>只能用来解锁特定的状态更新交易</em>。因此，结算交易是通过设置只对某个输出有效的特定密钥对，来确保它唯一绑定到特定的状态更新交易的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>双向状态通道可以很复杂，但是 eltoo 提供了一个简单新颖的方式来实现它。希望你喜欢本系列文章！</p>
<p>（完）</p>
</article></div></div></main><script src="/js/post.js?v=1673594423018"></script><script src="/js/highlight.min.js?v=1673594423018"></script><script>var containerEl = document.querySelector('.post-container');
var postFontSize = localStorage.getItem('post-font-size') || '16';
var inputEl = document.querySelector('#size-change-input');
var inputEl2 = document.querySelector('#size-change-input2');
inputEl.value = postFontSize;
inputEl2.value = postFontSize;
containerEl.style.fontSize = postFontSize + 'px';
$(function(){
  function setSizeChangeInputValue(size) {
    $('.post-container').css('font-size', size + 'px');
    localStorage.setItem('post-font-size', size);
    $('#size-change-input').val(size);
    $('#size-change-input2').val(size);
  }
  $('#size-change-input').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
  $('#size-change-input2').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
});
</script><script>hljs.initHighlightingOnLoad();</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/btcstudy">Twitter</a><!-- Github--><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml">rss</a><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/btcstudyorg">Telegram</a></section></footer><script async src="/js/buttons.js?v=1673594423018"></script><script async src="/js/index.js?v=1673594423018"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-JVCJ9XXG1Z');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306";
  hm.async = true;
  hm.defer = true;
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script></body></html>