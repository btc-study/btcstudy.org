<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>闪电网络上的谨慎日志合约</title><meta name="keywords" content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name="description" content="比特币思想的中文集结地"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css?v=1673594422723"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/style/common/iconfont.css?v=1673594422723"><link rel="stylesheet" href="/style/base.css?v=1673594422723"><link rel="stylesheet" href="/style/common/helper.css?v=1673594422723"><link rel="stylesheet" href="/style/themes/animation.css?v=1673594422723"><script>function ready() {
  var bodyEl = document.querySelector('.body-container');
  var theme = localStorage.getItem('theme') || 'light';
  if (!['light', 'dark'].includes(theme)) {
    theme = 'light';
    localStorage.setItem('theme', 'light');
  }
  bodyEl.classList.remove('appearance-auto');
  bodyEl.classList.add('appearance-' + theme);
  quickInitialTheme();
}
function quickInitialTheme() {
  var theme = localStorage.getItem('theme') || 'light';
  var logoLightEl = document.querySelector('.logo-light');
  var logoDarkEl = document.querySelector('.logo-dark');
  
  var mLogoLightEl = document.querySelector('#mobile-header-logo > .logo-light');
  var mLogoDarkEl = document.querySelector('#mobile-header-logo > .logo-dark');
  var themeBtnEl = document.getElementById('theme-btn');
  
  var slideThemeLightEl = document.querySelector('.slide-theme-light');
  var slideThemeDarkEl = document.querySelector('.slide-theme-dark');
  
  document.body.classList.add(theme);
  if (theme === 'dark') {
    logoLightEl.classList.add('hidden');
    logoDarkEl.classList.remove('hidden');
    
    mLogoLightEl.classList.add('hidden');
    mLogoDarkEl.classList.remove('hidden');
    
    themeBtnEl.classList.remove('icon-icon_dark');
    themeBtnEl.classList.add('icon-icon_light');
    
    slideThemeLightEl.classList.remove('hidden');
  } else {
    slideThemeDarkEl.classList.remove('hidden');
  }
}
document.addEventListener("DOMContentLoaded", ready);</script><script src="/js/common.js?v=1673594422723"></script><script src="/js/libs/zepto.min.js"></script><link rel="stylesheet" href="/style/post.css?v=1673594422723"><link rel="stylesheet" href="/style/themes/highlight.css?v=1673594422723"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="BTC Study" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column" onload="initialTheme()"><div class="clip"></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id="header"><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href="/"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id="header-menu"><a class="is-inline-block header-activity mr-4" href="/">首页</a><a class="is-inline-block mr-4" href="/archives">全站目录</a><a class="is-inline-block mr-4" href="/tags">标签</a><a class="is-inline-block mr-4" href="/maps">地图</a><a class="is-inline-block mr-4" href="/mempool">mempool</a><a class="is-inline-block mr-4" target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input" type="range" min="12" max="32" step="2"></div></div></div><i class="iconfont icon-icon_dark mr-1" id="theme-btn"></i><div class="search-wrap"><input class="pl-3" id="search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search" id="search-input-btn"></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">闪电网络上的谨慎日志合约</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn2"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input2" type="range" min="12" max="32" step="2"></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id="mobile-header"><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id="mobile-header-logo"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopicMobile"><p class="is-full-height">闪电网络上的谨慎日志合约</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class="mobile-search-wrap"><div class="search-input"><input class="pl-3" id="mobile-search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class="mobile-search-input-btn">搜 索</button></div></div></header><div class="mobile-slide-menu"><a class="header-activity" href="/">首页</a><a href="/archives">全站目录</a><a href="/tags">标签</a><a href="/maps">地图</a><a href="/mempool">mempool</a><a target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class="slide-menu-fontsize"><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1673594422723"> </script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%97%AA%E7%94%B5%E9%80%9A%E9%81%93%E4%B8%AD%E7%9A%84-DLC%EF%BC%88%E4%BB%A5%E5%8F%8A%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF%EF%BC%89"><span class="toc-text">什么是闪电通道中的 DLC（以及什么不是）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="toc-text">预备知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AA%E7%94%B5%E9%80%9A%E9%81%93"><span class="toc-text">闪电通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E9%85%8D%E5%99%A8%E7%AD%BE%E5%90%8D"><span class="toc-text">适配器签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%A8%E6%85%8E%E6%97%A5%E5%BF%97%E5%90%88%E7%BA%A6"><span class="toc-text">谨慎日志合约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DLC-%E9%80%9A%E9%81%93"><span class="toc-text">DLC 通道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AA%E7%94%B5%E9%80%9A%E9%81%93%E4%B8%AD%E7%9A%84-DLC"><span class="toc-text">闪电通道中的 DLC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E7%BD%91%E6%89%A7%E8%A1%8C"><span class="toc-text">主网执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%B4%E8%B0%A2"><span class="toc-text">致谢</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id="postTitle">闪电网络上的谨慎日志合约</h1><div class="page-author"><div class="is-flex is-flex-direction-row page-data mr-6"><img class="mr-1" src="//res.btcstudy.org/btcstudy/images/default_avatar.png" alt="Thibaut Le Guilly"><div class="page-author-info"><strong>Thibaut Le Guilly</strong><time class="has-text-grey" datetime="2022-12-02T07:50:55.000Z">2022-12-02</time></div></div><div class="is-flex"><a href="/tags/%E9%97%AA%E7%94%B5%E7%BD%91%E7%BB%9C"><i class="page-tag mr-1 px-1">闪电网络<!-- 订正图片路径--></i></a><a href="/tags/Discreet-Log-Contract"><i class="page-tag mr-1 px-1">Discreet Log Contract<!-- 订正图片路径--></i></a></div></div><article class="mt-4 post-content"><blockquote>
<p><em>作者：Thibaut Le Guilly</em></p>
<p><em>来源：<a target="_blank" rel="noopener" href="https://medium.com/crypto-garage/dlc-on-lightning-cb5d191f6e64">https://medium.com/crypto-garage/dlc-on-lightning-cb5d191f6e64</a></em></p>
</blockquote>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/ndF_7g.png" alt="img"></p>
<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>我们已经在主网上开启和关闭了第一条嵌入了一个谨慎日志 合约（DLC）的闪电通道。</p>
<p>我们 Crypto Garage 一直在开发可以在闪电通道中工作的 DLC，而我们最终也到达了一个重要的里程碑：我们成功开启了一条闪电通道并在其中建立了一个 DLC，最终关闭了整个通道。在本文中，我会解释闪电通道与 DLC 建立和关闭的技术细节。</p>
<h2 id="什么是闪电通道中的-DLC（以及什么不是）"><a href="#什么是闪电通道中的-DLC（以及什么不是）" class="headerlink" title="什么是闪电通道中的 DLC（以及什么不是）"></a>什么是闪电通道中的 DLC（以及什么不是）</h2><p>出于本文的目的，我们所谓的 “在闪电通道中开启 DLC”，意思是两个节点<strong>直接</strong>建立一条通道，并在通道内使用（部分）资金建立一个 DLC。这个 DLC 可以关闭（让通道回归常规的闪电通道），也可以更新，而且通道也可以在非合作情境下关闭（我们也正是这么做的，这样会让闪电通道和 DLC 合约的交易结构完完整整在链上展示出来）。</p>
<p>我们要强调的是，当前无法做到通过闪电网络来 <em>路由 DLC</em>（即无法跟没有直接通道的节点开设 DLC）。这份<a target="_blank" rel="noopener" href="https://mailmanlists.org/pipermail/dlc-dev/2021-November/000091.html">邮件组帖子</a>提供了更多信息。</p>
<h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>为了热身以及让这篇文章自足，我们将历数在闪电通道中建立 DLC 所需的各种元素：<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1SndejwtOQC93BieINox2Gg5HtnUgFcLTVQODL8MP5Z4/edit#heading=h.jbsgei7du8a5">闪电通道</a>、<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1SndejwtOQC93BieINox2Gg5HtnUgFcLTVQODL8MP5Z4/edit#heading=h.cb0xldu0vqab">适配器签名</a>、<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1SndejwtOQC93BieINox2Gg5HtnUgFcLTVQODL8MP5Z4/edit#heading=h.it41s33fig1">DLC</a>  和 <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1SndejwtOQC93BieINox2Gg5HtnUgFcLTVQODL8MP5Z4/edit#heading=h.niw3p88jfsaz">DLC 通道</a>。</p>
<h3 id="闪电通道"><a href="#闪电通道" class="headerlink" title="闪电通道"></a>闪电通道</h3><p>如果对常规闪电通道的交易结构没有起码的理解，就很难理解如何在一条闪电通道中建立 DLC，所以我们快速回顾一下闪电通道的原理（若要获得更深入的理解，请看 <a target="_blank" rel="noopener" href="https://bitcoinmagazine.com/technical/understanding-the-lightning-network-part-building-a-bidirectional-payment-channel-1464710791">Bitcoin Magazine 的系列文章</a>）。我们仅仅关注跟我们的需求相关的部分，所以跟路由相关的部分我们全部跳过。</p>
<p>当两个闪电网络节点要开设一条通道时，他们会合作构造和签名两种类型的交易，“<em>注资交易</em>” 和 “<em>承诺交易</em>”。</p>
<p>注资交易以其中一方的几个 UTXO 作为输入（如果支持<a target="_blank" rel="noopener" href="https://bitcoinops.org/en/topics/dual-funding/">双向注资</a>技术，也可以双方都提供 UTXO），然后将资金锁入一个 2-of-2 的多签名输出中，为通道所用；这样的输出需要双方同时提供签名才能花费。</p>
<p>承诺交易则以注资交易的输出为输入，产生两个输出，这两个输出的面额对应双方的余额。注意，这些余额会在通道的生命周期中不断改变，所以，承诺交易需要不断更新以反映这些变化。这是通过让承诺交易变得 <em>可以撤销（revocable）</em> 来实现的。在实践中，这意味着每一方都保存着每一笔承诺的不同版本；在他们保管的承诺交易中，一个支付给他们自己的输出被锁定在这样一个脚本中：这个脚本即可以在一段事件后由他们自己解锁，也可以被掌握了某个秘密值的对手直接解锁。当双方都同意更新通道余额时（例如，一方希望给另一方支付一些钱），他们就构造并交换新的承诺交易和签名，并向对方揭晓在上一笔承诺交易中使用的秘密值，从而撤销掉上一笔交易。如果一方想要欺诈对手 —— 广播比较旧的承诺交易，对方有时间可以反击 —— 使用本地保存的秘密值，拿走通道中所有的资金。</p>
<p>整个交易结构如下图所示：</p>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/dIYJqUpLD3_.png" alt="img"></p>
<p style="text-align:center">- 闪电通道的交易结构 -</p>


<h3 id="适配器签名"><a href="#适配器签名" class="headerlink" title="适配器签名"></a>适配器签名</h3><p>适配器签名是一种加密过的签名（使用了某一个公钥），而且我们可以证明，在（使用对应的私钥）解密之后，可以得到对某条消息的有效签名。它还有一种属性：知晓了适配器签名、加密公钥和解密后的签名，就可以恢复出用来加密的秘密值。<a target="_blank" rel="noopener" href="https://medium.com/crypto-garage/optimizing-numeric-outcome-dlc-creation-6d6091ac0e47#96e9">这里</a>对所设计的模块作了概要的介绍。</p>
<p>下图展示了加密、验证和解密适配器签名的不同操作，以及恢复秘密值的过程。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/MRbdgVVq7wG.png" alt="img"></p>
<h3 id="谨慎日志合约"><a href="#谨慎日志合约" class="headerlink" title="谨慎日志合约"></a>谨慎日志合约</h3><p>DLC 让两方可以建立一个依赖于某些事件（体育比赛、资产价格 ……）的合约，并且直接在比特币区块链上结算。参与的双方需要提前选择一个播报事件的实体（“断言机”），这个实体会通过放出对结果的签名来见证事件的结果。</p>
<p>DLC 乍看起来可能跟闪电通道很像，但是它并不使用从注资交易中花费的承诺交易，而是 “合约执行交易（CET）”，每一笔 CET 都对应着事件的一种可能结果（以及支付数量）。双方都使用断言机会为不同事件结果创建的签名作为原像，加密自己的签名（从而产生适配器签名）（更多细节可见<a target="_blank" rel="noopener" href="https://medium.com/crypto-garage/optimizing-numeric-outcome-dlc-creation-6d6091ac0e47#96e9">此处</a>），然后交换并验证它们。一旦断言机见证了某个结果，DLC 的任意一方都可以解密对方的某一个签名，然后广播对应的 CET、结算合约。注意，因为使用了适配器签名，双方手中的 CET 是一样的。一个 DLC 的交易结构如下图所示。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/rinQigX8y2T.png" alt="img"></p>
<p style="text-align:center">- 链上 CDL 的交易结构 -</p>


<h3 id="DLC-通道"><a href="#DLC-通道" class="headerlink" title="DLC 通道"></a>DLC 通道</h3><p>那么，如果双方希望在上一个 DLC 到期后新建一个合约呢？当然，他们可以先关闭一个，再新建另一个。但是每一笔上链的交易都需要支付手续费。相对的，他们可以使用 DLC 通道（ItchySats 已经撰写了一份很棒的<a target="_blank" rel="noopener" href="https://comit.network/blog/2022/01/11/cfd-protocol-explained/">详细介绍</a>）。DCL 通道允许双方新建合约、在到期之前提前结算合约，当然，也可以在他们希望回收资金的时候在链上关闭合约。一种简单的实现办法是让 CET 变成可以撤销的。但是，那会导致新建合约的时候出现问题。即使某一方撤销掉了以前的 CET，也无法防止对手使用它们。这就意味着，对手方总是可以选择使用旧的 CET 或新的 CET 来关闭通道，而先撤销自己的 CET 的一方则没有选择，只有等待新的合约到期（因为他们需要等待断言机放出签名，这样才能广播 CET）。这给了其中一方不公平的优势。为了解决这个问题，我们引入了一种 “<em>缓冲交易</em>”，它将花费注资交易的输出，并产生相同价值（减去手续费）的输出；缓冲交易的输出再作为 CET 的输入。这样，当我们需要新建合约时，如果某一方不及时撤销前一个合约，另一方可以直接广播新合约的缓冲交易、防止恶意（或误操作的）对手方使用旧合约的 CET 关闭通道。</p>
<p>那我们要如何撤销旧的缓冲交易呢？一种办法是借鉴闪电网络，让双方都保存缓冲交易的不同版本。幸运的是，还有另一种更好的解决方案（最早是由<a target="_blank" rel="noopener" href="https://eprint.iacr.org/2020/476.pdf">这篇论文</a>提出的）。它也依赖于适配器签名，只不过跟常规的 DLC 利用它的方式不同。每一方都使用三组密钥。第一组是注资密钥，用在注资交易输出的 2-of-2 输出中。第二组是撤销密钥，每当一个合约被撤销时就公开。最后一组是公示密钥。这三个密钥都用在缓冲交易的输出脚本中，让这个输出有三种不同的花费方式（我们使用 “Alice” 和 “Bob” 作为两方的代称）：</p>
<ol>
<li>使用 Alice 和 Bob 双方的注资密钥的签名（用在 CET 交易中，就像链上 DLC 一样，必须知道断言机对事件结果的见证才能使用）</li>
<li>一个来自 Alice 注资密钥的签名，以及来自 Bob 的公示密钥和撤销密钥的签名</li>
<li>一个来自 Bob 注资密钥的签名，以及来自 Alice 的公示密钥和撤销密钥的签名</li>
</ol>
<p>当一个合约在通道中建立的时候，Alice 和 Bob 各给对方一个用于缓冲交易输入的适配器签名，是用对手的公示公钥加密过的。要是其中一人希望广播缓冲交易，TA 就要使用自己的公示私钥解密从对方处获得的适配器签名。但是，广播了缓冲交易（其中包含了解密后的签名），TA 就向对方揭开了自己的公示私钥（对方已经知道了适配器签名和加密密钥）。如果缓冲交易还未被撤销，那就没有什么问题，他们可以使用某一条 CET 正当地花费缓冲交易的输出。但如果缓冲交易已经被撤销了，对手方必然就知晓了撤销私钥，因此可以拿走全部的资金。最后，CET 带有一个相对时间锁，让被欺诈的一方可以花费已作废的缓冲交易输出。</p>
<p>下图演示了这种交易的结构及其花费条件。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/pbTOkCdVvun.png" alt="img"></p>
<p style="text-align:center">- DLC通道的花费条件 -</p>


<h2 id="闪电通道中的-DLC"><a href="#闪电通道中的-DLC" class="headerlink" title="闪电通道中的 DLC"></a>闪电通道中的 DLC</h2><p>我们已经解释完了所有的基本模块，现在我们来看看如何在闪电通道中嵌入一个 DLC 通道。</p>
<p>第一种明显的思路是在闪电通道的承诺交易中增加一个输出，以形成一个 DLC 通道。然而，这就意味着，每一次我们更新承诺交易的时候，DLC 的所有适配器签名都要重新计算（以及重新验证），这对于拥有大量可能结果的合约来说是非常昂贵的（这个问题可以靠 SIGHASH_NOINPUT 以及类型的升级修复）。为避免这一点，我们引入了一种 “<em>分割交易</em>”。它会花费注资交易的输出并形成两个输出：一个用于闪电通道，一个用于 DLC（可以通过增加输入来同时开启多个 DLC 通道、同时执行多个合约）。为了能够将通道恢复成 “标准” 的闪电通道，，我们使用<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1SndejwtOQC93BieINox2Gg5HtnUgFcLTVQODL8MP5Z4/edit#heading=h.niw3p88jfsaz">跟 DLC 通道同样的、基于适配器签名的机制</a>，让分割交易变成可撤销的。</p>
<p>不过，这样一来闪电通道又会出问题。为了让一方能够到欺诈的另一方（广播已被撤销的分割交易）作出反应，分割交易需要带有时间锁以阻止立即花费。但是，<a target="_blank" rel="noopener" href="https://github.com/lightning/bolts/blob/master/03-transactions.md#commitment-transaction">闪电网络的规范已经用到了承诺交易的 nLockTime 和 nSequence 字段</a>，以指定承诺号。为了解决这个问题，我们在分割交易与闪电通道承诺交易之间插入了一个 <em>粘合交易</em>，以实施一个相对时间锁（感谢 Matt Corallo 提出了这个简单的解决方案）。注意，这实际上是一个工程问题，可以通过为承诺交易使用不同的规范来解决（但这将需要闪电网络实现加入更多变更以支持它）。</p>
<p>总结一下，如果双方有一个直接的闪电网络通道，并希望在其中建立一个 DLC，他们可以合作创建并签名分割交易、粘合交易以及更新后的承诺交易（反映双方保留在闪电通道中的资金）、缓冲交易以及 DLC 的 CET。然后，他们就可以在闪电通道中路由支付、在 DLC 通道中更新和结算 DLC 合约。如果他们想要关闭 DLC 通道，他们可以作废分割交易，并合作创建和签名更新后的承诺交易。</p>
<p>下图演示了这个交易结构。注意，分割交易和缓冲交易用到了不同的公示和撤销密钥。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/dlc-on-lightning-by-thibaut-le-guilly/HLtd4Fg.png" alt="img"></p>
<p style="text-align:center">- 在闪电通道中嵌入 DLC 通道的交易结构 -</p>


<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>上述构造已经在我们的 <a target="_blank" rel="noopener" href="https://github.com/p2pderivatives/rust-dlc/tree/feature/split-tx-manager-2">rust-dlc 库</a>中实现了，这个库使用了 <a target="_blank" rel="noopener" href="https://github.com/p2pderivatives/rust-lightning/tree/split-tx-experiment">Lightning Development Kit（LDK）</a>的一个分叉，加入了对分割闪电通道的特性的支持。我们也实现了一个基于 LDK 样本的<a target="_blank" rel="noopener" href="https://github.com/p2pderivatives/ldk-sample/tree/ln-dlc-test">小型命令行工具</a>，除了常规的闪电通道功能，还启用了开启和管理 DLC 通道的功能。注意，代码还非常不稳定，而且我们要强调，<strong>在主网上使用非常有可能导致资金丢失</strong>。</p>
<h2 id="主网执行"><a href="#主网执行" class="headerlink" title="主网执行"></a>主网执行</h2><p>我们于 11 月 21 日在我们的两个启用了闪电网络的节点中开启了一条通道，<a target="_blank" rel="noopener" href="https://blockstream.info/tx/f307a6330c25ff4a43290803b088754b03ffd9c90c556aebca9a89d0b0ff9988">注资交易是这一笔</a>。然后，我们从开启通道的节点给另一个节点发送了一笔 keysend 支付（等到 LDK 实现了双向注资的时候，就不必执行这一步了）。我们定义了一个基于比特币在 11 月 21 日下午 4 点（JST）的价格的 DLC，并在闪电通道中开启了一条 DLC 通道。在这个合约到期时，我们让其中一个节点强制关闭通道。这个节点先是广播了分割交易（见<a target="_blank" rel="noopener" href="https://blockstream.info/tx/a110bc985c6b02e5d4a80a6eca4a4561462975dbe65a70a9dd2fb9af47330326">此处</a>）。分割交易得到确认的 288 个区块（缓冲交易和粘合交易的 nSequense 数值）之后，我们让这个节点广播缓冲交易和粘合交易（见<a target="_blank" rel="noopener" href="https://blockstream.info/tx/2084f0fab71ceb05a83cc8c1c7430e9aa101cba23d886fa75ccfc46616659af2">此处</a>和<a target="_blank" rel="noopener" href="https://blockstream.info/tx/5db5f26943af8f8b2e1be37b612d0d6f768c1117d7e6e63d08ee93cede6c63c1">此处</a>），以及本地的承诺交易（见<a target="_blank" rel="noopener" href="https://blockstream.info/tx/bfde28fba3b4873e87f2044e861dc117f321091dc635dafa1ffa2df46c723591">此处</a>）。缓冲交易得到确认的 288 个区块之后，节点获得了断言机对结果的签名，从而解密了另一方对相应结果的适配器签名，然后广播一笔 CET，结束了这个 DLC（见<a target="_blank" rel="noopener" href="https://blockstream.info/tx/c0819ea9d8fe73ce3ad79e7aedbcbe8931258e4961b456317a64420ae402aa7e">此处</a>）。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>可以在闪电通道中开启 DLC 的能力，开启了一些很棒的应用，例如将部分通道的价值与其它货币挂钩、使用通道中的资金交易一些衍生品合约（同时无需放弃资产托管），甚至可以直接跟朋友打赌球赛的胜负。在 rust-dlc 库中实现功能支持，并通过在闪电通道中执行和关闭 DLC 演示了器用途，我们已经证明了我们提出的方法的可行性。要分析和优化这个提议并强化这个实现，还有非常多工作要做。所以，如果你有兴趣贡献一份力量或使用这种技术，甚至仅仅是想了解更多，都欢迎联系我们！</p>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>感谢 LDK 团队审核以及接受让实现本文所述的技术成为可能的多项 PR，以及解答我们对 LDK、闪电网络和 Rust 的许多问题！</p>
<p>（完）</p>
</article></div></div></main><script src="/js/post.js?v=1673594422723"></script><script src="/js/highlight.min.js?v=1673594422723"></script><script>var containerEl = document.querySelector('.post-container');
var postFontSize = localStorage.getItem('post-font-size') || '16';
var inputEl = document.querySelector('#size-change-input');
var inputEl2 = document.querySelector('#size-change-input2');
inputEl.value = postFontSize;
inputEl2.value = postFontSize;
containerEl.style.fontSize = postFontSize + 'px';
$(function(){
  function setSizeChangeInputValue(size) {
    $('.post-container').css('font-size', size + 'px');
    localStorage.setItem('post-font-size', size);
    $('#size-change-input').val(size);
    $('#size-change-input2').val(size);
  }
  $('#size-change-input').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
  $('#size-change-input2').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
});
</script><script>hljs.initHighlightingOnLoad();</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/btcstudy">Twitter</a><!-- Github--><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml">rss</a><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/btcstudyorg">Telegram</a></section></footer><script async src="/js/buttons.js?v=1673594422723"></script><script async src="/js/index.js?v=1673594422723"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-JVCJ9XXG1Z');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306";
  hm.async = true;
  hm.defer = true;
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script></body></html>