<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>闪电网络深入解读（上）：支付通道</title><meta name="keywords" content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name="description" content="比特币思想的中文集结地"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css?v=1675433295430"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/style/common/iconfont.css?v=1675433295430"><link rel="stylesheet" href="/style/base.css?v=1675433295430"><link rel="stylesheet" href="/style/common/helper.css?v=1675433295430"><link rel="stylesheet" href="/style/themes/animation.css?v=1675433295430"><script>function ready() {
  var bodyEl = document.querySelector('.body-container');
  var theme = localStorage.getItem('theme') || 'light';
  if (!['light', 'dark'].includes(theme)) {
    theme = 'light';
    localStorage.setItem('theme', 'light');
  }
  bodyEl.classList.remove('appearance-auto');
  bodyEl.classList.add('appearance-' + theme);
  quickInitialTheme();
}
function quickInitialTheme() {
  var theme = localStorage.getItem('theme') || 'light';
  var logoLightEl = document.querySelector('.logo-light');
  var logoDarkEl = document.querySelector('.logo-dark');
  
  var mLogoLightEl = document.querySelector('#mobile-header-logo > .logo-light');
  var mLogoDarkEl = document.querySelector('#mobile-header-logo > .logo-dark');
  var themeBtnEl = document.getElementById('theme-btn');
  
  var slideThemeLightEl = document.querySelector('.slide-theme-light');
  var slideThemeDarkEl = document.querySelector('.slide-theme-dark');
  
  document.body.classList.add(theme);
  if (theme === 'dark') {
    logoLightEl.classList.add('hidden');
    logoDarkEl.classList.remove('hidden');
    
    mLogoLightEl.classList.add('hidden');
    mLogoDarkEl.classList.remove('hidden');
    
    themeBtnEl.classList.remove('icon-icon_dark');
    themeBtnEl.classList.add('icon-icon_light');
    
    slideThemeLightEl.classList.remove('hidden');
  } else {
    slideThemeDarkEl.classList.remove('hidden');
  }
}
document.addEventListener("DOMContentLoaded", ready);</script><script src="/js/common.js?v=1675433295430"></script><script src="/js/libs/zepto.min.js"></script><link rel="stylesheet" href="/style/post.css?v=1675433295430"><link rel="stylesheet" href="/style/themes/highlight.css?v=1675433295430"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="BTC Study" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column" onload="initialTheme()"><div class="clip"></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id="header"><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href="/"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id="header-menu"><a class="is-inline-block header-activity mr-4" href="/">首页</a><a class="is-inline-block mr-4" href="/archives">全站目录</a><a class="is-inline-block mr-4" href="/tags">标签</a><a class="is-inline-block mr-4" href="/maps">地图</a><a class="is-inline-block mr-4" href="/mempool">mempool</a><a class="is-inline-block mr-4" target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input" type="range" min="12" max="32" step="2"></div></div></div><i class="iconfont icon-icon_dark mr-1" id="theme-btn"></i><div class="search-wrap"><input class="pl-3" id="search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search" id="search-input-btn"></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">闪电网络深入解读（上）：支付通道</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id="change-size-btn2"></i><div class="size-input-wrap"><div class="input-wrap"><input id="size-change-input2" type="range" min="12" max="32" step="2"></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id="mobile-header"><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id="mobile-header-logo"><svg class="logo-light" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#000000"></path></g></g></g></svg><svg class="logo-dark hidden" width="125px" height="23px" viewBox="0 0 125 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>BTCStudy</title><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="首页-响应式" transform="translate(-249.000000, -23.000000)" fill-rule="nonzero"><g id="BTCStudy" transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id="BTC" fill="#F2A900"></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id="Study" fill-opacity="0.85" fill="#FFFFFF"></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id="postTopicMobile"><p class="is-full-height">闪电网络深入解读（上）：支付通道</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class="mobile-search-wrap"><div class="search-input"><input class="pl-3" id="mobile-search-input" placeholder="请输入搜索关键词"><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class="mobile-search-input-btn">搜 索</button></div></div></header><div class="mobile-slide-menu"><a class="header-activity" href="/">首页</a><a href="/archives">全站目录</a><a href="/tags">标签</a><a href="/maps">地图</a><a href="/mempool">mempool</a><a target="_blank" rel="noopener" href="https://123btc.org/">123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class="slide-menu-fontsize"><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1675433295430"> </script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-text">引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E9%80%9A%E9%81%93"><span class="toc-text">支付通道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%94%AF%E4%BB%98%E9%80%9A%E9%81%93%E6%A1%88%E4%BE%8B"><span class="toc-text">一个简单的支付通道案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8D%E4%BF%A1%E4%BB%BB%E7%9A%84%E9%80%9A%E9%81%93"><span class="toc-text">免信任的通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E9%94%81"><span class="toc-text">时间锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%AF%B9%E7%A7%B0%E7%9A%84%E5%8F%AF%E6%92%A4%E9%94%80%E6%89%BF%E8%AF%BA"><span class="toc-text">不对称的可撤销承诺</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text">结语</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id="postTitle">闪电网络深入解读（上）：支付通道</h1><div class="page-author"><div class="is-flex is-flex-direction-row page-data mr-6"><img class="mr-1" src="//res.btcstudy.org/btcstudy/images/default_avatar.png" alt="Magomed Aliev"><div class="page-author-info"><strong>Magomed Aliev</strong><time class="has-text-grey" datetime="2021-09-15T11:59:13.000Z">2021-09-15</time></div></div><div class="is-flex"><a href="/tags/%E9%97%AA%E7%94%B5%E7%BD%91%E7%BB%9C"><i class="page-tag mr-1 px-1">闪电网络<!-- 订正图片路径--></i></a></div></div><article class="mt-4 post-content"><blockquote>
<p><em>作者：Magomed Aliev</em></p>
<p><em>来源：<a target="_blank" rel="noopener" href="https://medium.com/softblocks/lightning-network-in-depth-part-1-payment-channels-b943607950dd">https://medium.com/softblocks/lightning-network-in-depth-part-1-payment-channels-b943607950dd</a></em></p>
</blockquote>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/40e6f854a08f44b4b08211fa99711d87.png" alt="1"></p>
<p>闪电网络是一种去中心化的链下技术方案，可支持每秒上万笔交易并发，接近于 Visa 系统能做到的程度（举个例子）。而在当前的比特币（世界上最流行的密码学货币）区块链上，只能支持每秒处理约 7 笔事务，还要付出高昂的手续费，并等待很长时间来确认交易生效，这些因素都使得几乎不可能用比特币发送小额交易。<strong>而闪电网络把这两个问题都解决了</strong>。</p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>闪电网络是一种支付通道系统，与常见的多签名钱包没有任何区别。所谓开启通道，就是参与方创建一个多签名钱包，并向该钱包充入资金。这个钱包接收到的资金数量就成为这个通道的余额。再然后，参与方之间的后续交易就全部在<strong>区块链以外的环境</strong>中发生了。任一参与方都能随时关闭这个通道，这时候，最后一笔链下的交易（决定着该通道各参与方的余额）会被发送到区块链上，同时作废掉所有中间的交易，因为所有这些交易都使用同样的交易输出。结果是，我们只需一笔交易来开启通道、一笔交易来关闭通道，中间所有的中间交易都是即时收发的，无需记录在区块链上（因此无需等待）。</p>
<p>（译者注：比特币不是账户里面的余额，是一张张的支票；所有的支票都是由具体的某笔交易创造的；每一张支票都只用一次就会作废（也即只能用在一笔交易中）。交易可以任意分配所用支票的价值来生产任意数量的新支票。）</p>
<p>这样的通道所组成的网络使你可以向网络的另一个参与者发送资金，即使你们之间并无直接的通道。唯一的条件是你们之间要能形成一条 “路径”，即有通道能前后相接地把你和对方联系起来。此外，得益于特殊的智能合约（HTLC，哈希时间锁合约），你不需要信任网络中的任何人，合约会保证安全地交付你支付的资金。</p>
<p>要理解闪电网络是如何运行的，首先要理解的是支付通道的运行以及构成支付通道基础的 HTLC。这些话题都不小，所以我把文章分成了两部分，从解释支付通道的工作原理开始。</p>
<h2 id="支付通道"><a href="#支付通道" class="headerlink" title="支付通道"></a>支付通道</h2><p>如上所述，连接两个参与者的支付通道实质就是一个普通的多签名钱包。第一笔交易决定了一个通道的余额，我们称为 “充值事务” 或者 “锚点事务”。这笔交易需要广播到网络中并记录到区块链上，以表明通道开启。</p>
<p>做完了这一步之后，要更新通道双方的余额时，双方就需要手动交换签过名的 “承诺事务”。这些交易本身都是有效的，随时可以发送到比特币网络中，但双方都会暂时保存起来，不会广播出来，除非已准备关闭通道。如此一来，通道内双方的余额状态，一秒内变动几千次也没问题，更新的速度仅受限于双方创建、签名和向对方发送承诺事务的速度。</p>
<p>每次双方交换了一笔新的承诺事务，他们也就把通道的前一个状态作废掉；因此，只有最新的一笔承诺事务可以 “执行”。这样设计的目的是防止某一方欺诈对方，把一个过时的但对自己有利的状态发送到链上来关闭通道。下文我会讲解几种防止这种欺诈的机制。</p>
<p>最后，通道既可以双方一致同意关闭 —— 就是把一笔关闭事务（叫做 “结算事务”）发送到比特币网络中 —— 也可以单方决定关闭，就是把最后一笔承诺事务发送到网络中。这是为了防止某一方离线导致另一方在通道中的余额一直 “锁定” 的情形。</p>
<p>在通道存在的整个生命周期里，只有两笔事务被发到了比特币网络中并记录到了比特币区块链上（就是充值事务和结算事务）。在这两笔事务之间，双方可以交换无数次承诺事务，这些事务都不需要提交到区块链上。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/0338050ab71a4343b3821e1599892f8a.png" alt="2"></p>
<h2 id="一个简单的支付通道案例"><a href="#一个简单的支付通道案例" class="headerlink" title="一个简单的支付通道案例"></a>一个简单的支付通道案例</h2><p>在解释更加复杂的机制之前，我们先来考虑一个简单的、单向的通道的例子。为了简化这个解释，我们假设双方都是诚实的。后面我们会再考虑帮助我们阻止欺诈的机制。</p>
<p>假设一个通道有两个参与者，Emma 和 Fabian。Fabian 提供付费的视频流服务，而观看者通过通道来实现小额支付 —— 每观看一秒就要付出 0.00001 btc，相当于每小时 0.036 btc 。Emma 是一个想看视频的普通用户。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/98740315e3444a39a4eac832e2802dbc.png" alt="3"></p>
<p>Emma 和 Fabian 使用一个特殊的程序来同步播放视频和运行支付通道。Emma 在自己的网络浏览器中启动这个程序，而 Fabian 在自己的服务器上使用同一个程序。这个程序具有一个普通的比特币钱包软件的所有功能，它可以创建和签名交易。支付通道的整个机制可以完全隐藏起来，用户看到的事实就是这个视频是按秒计价的。</p>
<p>现在我们来看看这个付费服务的具体工作流程。一开始，Emma 和 Fabian 要开启通道：建立一个 2-2 的多签名地址。从用户的视角来看，这个程序创建了一个 P2SH 地址（一个多签名钱包）并要求用户充入足以支付一个小时视频服务的资金。Emma 转了 0.036 btc 到这个地址，而这笔交易也就成了所谓的充值事务。</p>
<p>充值事务被打包到某个区块之后，这个通道就算开启了，视频也就开始播放。在第一秒钟，用户创建并签名了一条承诺事务，改变了通道内的余额：现在 Fabian 有了 0.00001 btc，Emma 还剩 0.03599 btc 。这笔事务使用了充值事务的输出，并创建了两个输出，含义就如我们这里所述。从服务商的角度看，程序收到了这笔事务，于是也签上名、连同第一秒的视频发回给 Emma。现在双方都有了一笔对方手动签过名的、反映通道最新状态的承诺事务；如有需要，任何一方都可以把这笔交易发送到比特币网络中。</p>
<p>到了第二秒，Emma 这边的程序又创建了一笔新的承诺事务，使用的同样是充值交易的输出（跟第一笔一样），这一次，承诺事务的第一个输出给了Fabian 0.00002 btc，把 0.03598 给了 Emma。这笔事务用来支付第二秒的视频下载。</p>
<p>我们假设，Emma 看了 10 分钟的视频，然后就退出了。在这段时间里，她签名并发送了 600 笔承诺事务（600 秒的视频）。最后的一笔有两个输出：0.03 btc 给 Emma，和 0.006 给 Fabian。Emma 关闭了通道，把最后一笔承诺事务广播到了比特币网络中作为 结算事务。如此，<strong>这个通道只有一头一尾两笔事务记录到了区块链上</strong>。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/b18e668d15054f95877474ac32024beb.png" alt="4"></p>
<h2 id="免信任的通道"><a href="#免信任的通道" class="headerlink" title="免信任的通道"></a>免信任的通道</h2><p>当然，从这个例子来看，一切都好，但这是因为双方都是诚实的。不难想象某些时候，其中一方会欺骗对方，像上面这么简单的设计可能就不够用了。</p>
<ul>
<li>虽然通道开启着，Emma 还是需要 Fabian 的签名来取出资金，因为这个通道是 2-2 的多签名地址。如果 Fabian 消失了，Emma 的资金可能会永远锁在这个通道里面。</li>
<li>虽然通道开启着，Emma 可以使用任何一笔双方都签过名的承诺事务。在观看视频 10 分钟之后，她可以拿第一笔承诺交易上链，完全不需要经过 Fabian 的再次同意。</li>
</ul>
<h3 id="时间锁"><a href="#时间锁" class="headerlink" title="时间锁"></a><strong>时间锁</strong></h3><p>这些问题的一种解决方案是在承诺事务中使用时间锁（事务层面的时间锁（nLocktime））。为了保证资金不会在通道中永远锁定，Emma 使用她的充值事务的输出创建了一个退款事务。她先给 Fabian 发送这笔事务，等 Fabian 签名并发回后，Emma 才把充值事务广播到比特币网络中，开启他们的通道。</p>
<p>这笔退款事务也成了第一笔承诺事务，而且它的时间锁为通道设置了一个存在时间的上限。假设 Emma 把时间锁设置为 30 天（4320 个比特币区块）（即 30 天之后这笔事务才能记录到区块链上）。接下来所有的承诺事务，所设置的时间锁会一个比一个短，这样更新的事务就能更早广播到网络中。</p>
<p>现在 Emma 不用再担心了，她知道即使 Fabian 玩失踪，她也可以在 30 天之后取回自己的资金（如果这是一条双向的支付通道，即 Fabian 也会存钱进去，那他也从自己的角度提出一笔退款事务）。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/6fa9c09f0a024c82864e59feb90e6375.png" alt="5"></p>
<p>每一笔新的承诺事务的时间锁都比前一笔要短，因此，新一笔承诺事务总是能比旧的更早上链并使旧的事务作废（无法上链），这样就能防止任何一方恶意使用旧的承诺事务。如果一切顺利，Emma 和 Fabian 只需广播双方一致的普通结算事务，因此带时间锁的承诺事务只有一方下线时才会派上用场。</p>
<p>举个例子，如果第一笔承诺事务的时间锁是 4320 个区块，那么第二笔承诺事务可以设成 4319 个区块，以此类推。如此一来，第 600 笔承诺事务可以比第一笔承诺事务早 600个区块上链。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/0854a808ef5640acae05cb9c4770f50f.png" alt="6"></p>
<p>你可能也注意到了，这种方法虽然有助于防止某一方把更早的承诺事务上链（欺诈），但它有两个明显的缺点：</p>
<ul>
<li>第一笔承诺事务的时间锁限制了这个通道的寿命。如果这个时间锁设置的时间太长（比如 1 年），通道可以存在很久，但如果某一方玩失踪，另一方就不得不等待很长时间才能广播最后一笔承诺事务、取回自己的资金。</li>
<li>第一笔承诺事务的时间锁也限制了可以在通道内发生的交易次数。在我们的例子中，这个数值是 4320，这个通道内只能发生 4320 笔事务，因为每一笔新事务都会把时间锁的时间减去 1 个区块。而且，以区块（10 分钟）为间隔，等于是强迫参与方要追踪比特币网络的区块，以免错过什么，以及在情形不对时尽早把最后一笔承诺事务上链。当然，这个间隔是可以延长的，但代价是通道内可以发送的交易数量会变得更少。</li>
</ul>
<p>因此，时间锁让我们可以作废旧的承诺事务并保证通道双方都可以安全地关闭通道：如果他们都同意通道的最新状态，他们可以发送一笔不带时间锁的结算事务（与最后一笔承诺事务意思相同），关闭通道；如果某一方不在线，另一方也可等待最后一笔承诺的时间锁解锁，然后把该笔承诺事务广播到比特币网络中。</p>
<h3 id="不对称的可撤销承诺"><a href="#不对称的可撤销承诺" class="headerlink" title="不对称的可撤销承诺"></a><strong>不对称的可撤销承诺</strong></h3><p>另一种解决上述信任问题的办法是取消早前的承诺事务。实际上，“取消（cancellation）” 这个词是不准确的，因为在比特币网络中，一笔上链的事务（得到区块确认的事务）是永远不可取消的。不过，特殊的构造方式可以使得上链较早的承诺事务无利可图。只需给予各方一个 “撤销密钥（revocation key）” 即可。</p>
<p>假设 Hitesh 和 Irene 决定开启一个通道。双方都充值了 5 btc 到这个通道中，确定了通道的初始余额。现在，双方不是签署同一笔标准的承诺事务，而是各自创建两笔不同的、不对称的承诺事务。</p>
<p>Hitesh 拿到的由 Irene 签名的事务有两个输出，第一个输出不带时间锁，立即给 Irene 支付 5 btc，而第二个输出带有时间锁，支付 5 btc 给 Hitesh，但要等（这笔事务上链后的） 1000 个区块之后，这个输出才能花用。详情如下：</p>
<pre><code class="javascript">Input: 2-of-2 funding output, signed by Irene
​
Output 0 &lt;5 bitcoin&gt;:
    &lt;Irene’s Public Key&gt; CHECKSIG
​
Output 1:
    &lt;1000 blocks&gt;
    CHECKSEQUENCEVERIFY
    DROP
    &lt;Hitesh’s Public Key&gt; CHECKSIG
</code></pre>
<p>与此同时，Irene 也可拿到由  Hitesh 签名的一个承诺事务，有两个输出：一个立即给 Hitesh 支付 5 btc，另一个输出则给 Irene 支付 5 btc，但要等 1000 个区块之后才能花。</p>
<pre><code class="bash">Input: 2-of-2 funding output, signed by Hitesh
​
Output 0 &lt;5 bitcoin&gt;:
    &lt;Hitesh’s Public Key&gt; CHECKSIG
​
Output 1:
    &lt;1000 blocks&gt;
    CHECKSEQUENCEVERIFY
    DROP
     &lt;Irene’s Public Key&gt; CHECKSIG
</code></pre>
<p>因此，双方都拿到了一笔由对方签名的承诺事务。Hitesh 和 Irene 都可以随时把手上的承诺事务签名后广播出去，但是，一旦这么做了，另一方都会立即拿到钱，而自己只能等到 1000 个区块之后才能拿到，这可是大大的不利。不过，这还不足以让双方都诚实守信。</p>
<p><img src="//res.btcstudy.org/btcstudy/images/lightning-network-in-depth-part-1-payment-channels/f4910264881a4d6aa5fecaa4ff12d31c.png" alt="7"></p>
<p>这就要讲到我们的最后一个功能了，可撤销的密钥，使得任一方如果试图欺诈，对方都可以惩罚 TA，使之血本无归。</p>
<p>如上所述，每一笔承诺事务都有一个 “延后” 的输出，我们把这个输出做得再复杂一点：这个输出既可以被等待了 1000 个区块的承诺事务发送者使用，也可以被通道的另一方使用，如果 TA 持有撤销密钥的话。当 Hitesh 创建承诺事务并交给 Irene 时，他的第二个输出既可以为自己所用（要等待 1000 的区块）也可以为 Irene 使用，如果后者掌握了撤销密钥的话。</p>
<p>Hitesh 会秘密地保管这个密钥，仅当他决定使用新的一笔承诺事务来更新通道内状态时才会发给 Irene。事务的详情如下：</p>
<pre><code class="json">Input: 2-of-2 funding output, signed by Irene
​
Output 0 &lt;5 bitcoin&gt;:
    &lt;Irene’s Public Key&gt; CHECKSIG
​
Output 1 &lt;5 bitcoin&gt;:
    IF
         # Revocation penalty output
         &lt;Revocation Public Key&gt;
    ELSE
         &lt;1000 blocks&gt;
         CHECKSEQUENCEVERIFY
         DROP
        &lt;Hitesh’s Public Key&gt;
    ENDIF
    CHECKSIG
</code></pre>
<p>（译者注：看代码会更清晰一些：第一个输出是给立即 Irene 支付 5 btc；第二个输出则是带条件的，既可以使用撤销密钥，立即获得 5 btc，也可在 1000 个区块后，使用 Hitesh 的私钥来使用这个输出。注意这里的 “IF…ELSE…” 式条件，它跟我们在其它的计算机编程中的含义是一样的。）</p>
<p>附带一个例子可能会更容易理解。假设 Irene 希望给 Hitesh 发送 2 btc，这时候他们要更新通道的状态，也就是要创建一笔新的承诺事务。双方各自创建一个不对称的承诺事务，并且，在签名之前，先把上一笔承诺事务的撤销密钥交给对方，如此便 “撤销” 了上一笔承诺事务。如果 Hitesh 希望以通道最后的余额来结算，而 Irene 看着觉得更旧的状态对自己更有利，她可以尝试把自己手中的上一笔承诺事务签名后广播到网络中，但这笔承诺事务的撤销密钥已经暴露给了 Hitesh；如果他发现这笔承诺事务上链了，他有足足 1000 个区块的时间可以把通道内的所有钱都拿走（第一个输出当下就给了他，而第二个输出只需他提供撤销密钥就可以立即使用）（没错，这个 “取消” 的动作没法自动化，Hitesh 必须关注 Irene 是否发送了旧的承诺事务到网络中，然后使用撤销密钥）。</p>
<p>（译者注：这种只设撤销密钥的实现是不够安全的，因为，即使撤销密钥已经曝光，欺诈的一方依然掌握着撤销密钥，也即双方都掌握着撤销密钥，因此，欺诈的一方可以跟被欺诈的一方赛跑，先将相应的花费交易上链的人就可以拿走资金。合理的实现是使用 “被承诺者的哈希锁 + 承诺交易签名者的签名”。假设是 Alice 给 Bob 签名，那么这第二个输出可以使用 Bob 给出的哈希值的原像 + Alice 的签名来花费，或者 Bob 自己在时间锁结束后花费）</p>
<p>因此，这种使用不对称可撤销承诺的通道的效率要更高，因为它不限制通道的寿命，也不限制交易发送的次数。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>到这里，我们的第一篇文章就结束了，估计你也要一段时间来消化一下，你也可以在评论中提问。在下一篇文章，我们会解释 HTLC 的功能，最终解释闪电网络是如何工作的。</p>
<p><strong>链接</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bitcoinbook.info/">“Mastering bitcoin” — Andreas M. Antonopoulos</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/softblocks/segregated-witness-for-dummies-d00606e8de63">Segregated witness for dummies</a></li>
<li><a target="_blank" rel="noopener" href="https://lightning.network/lightning-network-paper.pdf">Lightning network whitepaper</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/softblocks/lightning-network-in-depth-part-2-htlc-and-payment-routing-db46aea445a8">Lightning network in depth, part 2: HTLC and payment routing</a></li>
</ul>
<p>（完）</p>
</article></div></div></main><script src="/js/post.js?v=1675433295430"></script><script src="/js/highlight.min.js?v=1675433295430"></script><script>var containerEl = document.querySelector('.post-container');
var postFontSize = localStorage.getItem('post-font-size') || '16';
var inputEl = document.querySelector('#size-change-input');
var inputEl2 = document.querySelector('#size-change-input2');
inputEl.value = postFontSize;
inputEl2.value = postFontSize;
containerEl.style.fontSize = postFontSize + 'px';
$(function(){
  function setSizeChangeInputValue(size) {
    $('.post-container').css('font-size', size + 'px');
    localStorage.setItem('post-font-size', size);
    $('#size-change-input').val(size);
    $('#size-change-input2').val(size);
  }
  $('#size-change-input').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
  $('#size-change-input2').on('input propertychange', function(e) {
    const size = e.target.value;
    setSizeChangeInputValue(size);
  });
});
</script><script>hljs.initHighlightingOnLoad();</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/btcstudy">Twitter</a><!-- Github--><!-- Ins--><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml">rss</a><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/btcstudyorg">Telegram</a></section></footer><script async src="/js/buttons.js?v=1675433295430"></script><script async src="/js/index.js?v=1675433295430"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-JVCJ9XXG1Z');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306";
  hm.async = true;
  hm.defer = true;
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script></body></html>