<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><title>有趣的比特币脚本（三）：时间锁</title><meta name=keywords content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name=description content=比特币思想的中文集结地><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1"><link rel=icon href=/favicon.ico><link rel=stylesheet href="/style/common/bulma.css?v=1682773100887"><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href="/style/common/iconfont.css?v=1682773100887"><link rel=stylesheet href="/style/base.css?v=1682773100887"><link rel=stylesheet href="/style/common/helper.css?v=1682773100887"><link rel=stylesheet href="/style/themes/animation.css?v=1682773100887"><script>function ready(){var e=document.querySelector(".body-container"),t=localStorage.getItem("theme")||"light";["light","dark"].includes(t)||(t="light",localStorage.setItem("theme","light")),e.classList.remove("appearance-auto"),e.classList.add("appearance-"+t),quickInitialTheme()}function quickInitialTheme(){var e=localStorage.getItem("theme")||"light",t=document.querySelector(".logo-light"),o=document.querySelector(".logo-dark"),d=document.querySelector("#mobile-header-logo > .logo-light"),l=document.querySelector("#mobile-header-logo > .logo-dark"),a=document.getElementById("theme-btn"),i=document.querySelector(".slide-theme-light"),c=document.querySelector(".slide-theme-dark");document.body.classList.add(e),("dark"===e?(t.classList.add("hidden"),o.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden"),a.classList.remove("icon-icon_dark"),a.classList.add("icon-icon_light"),i):c).classList.remove("hidden")}document.addEventListener("DOMContentLoaded",ready)</script><script src="/js/common.js?v=1682773100887"></script><script src=/js/libs/zepto.min.js></script><link rel=stylesheet href="/style/post.css?v=1682773100887"><link rel=stylesheet href="/style/themes/highlight.css?v=1682773100887"><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title="BTC Study" type=application/atom+xml></head><body class="is-flex is-flex-direction-column" onload=initialTheme()><div class=clip></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id=header><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href=/ ><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id=header-menu><a class="is-inline-block header-activity mr-4" href=/ >首页</a><a class="is-inline-block mr-4" href=/archives>全站目录</a><a class="is-inline-block mr-4" href=/tags>标签</a><a class="is-inline-block mr-4" href=/maps>地图</a><a class="is-inline-block mr-4" href=/mempool>mempool</a><a class="is-inline-block mr-4" target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input type=range min=12 max=32 step=2></div></div></div><i class="iconfont icon-icon_dark mr-1" id=theme-btn></i><div class=search-wrap><input class=pl-3 id=search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search" id=search-input-btn></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopic><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">有趣的比特币脚本（三）：时间锁</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn2></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input2 type=range min=12 max=32 step=2></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id=mobile-header><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id=mobile-header-logo><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopicMobile><p class=is-full-height>有趣的比特币脚本（三）：时间锁</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class=mobile-search-wrap><div class=search-input><input class=pl-3 id=mobile-search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class=mobile-search-input-btn>搜 索</button></div></div></header><div class=mobile-slide-menu><a class=header-activity href=/ >首页</a><a href=/archives>全站目录</a><a href=/tags>标签</a><a href=/maps>地图</a><a href=/mempool>mempool</a><a target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class=slide-menu-fontsize><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1682773100887"></script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E2%80%9C%E6%97%B6%E9%97%B4%E9%94%81%E2%80%9D-%E7%AE%80%E4%BB%8B><span class=toc-text>“时间锁” 简介</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%97%B6%E9%97%B4%E9%94%81%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B><span class=toc-text>时间锁脚本示例</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%97%B6%E9%97%B4%E9%94%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF><span class=toc-text>时间锁应用场景</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%AA%E4%BA%BA%E7%9A%84%E5%BC%BA%E5%88%B6%E5%82%A8%E8%93%84><span class=toc-text>个人的强制储蓄</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%81%BE%E5%A4%87%E6%8E%AA%E6%96%BD-%E6%84%8F%E5%A4%96%E5%BA%94%E5%AF%B9><span class=toc-text>灾备措施&#x2F;意外应对</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B5%84%E9%87%91%E7%9A%84%E7%A4%BE%E4%BA%A4%E6%81%A2%E5%A4%8D><span class=toc-text>资金的社交恢复</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%EF%BC%88%E5%8A%A0%E5%BC%BA%EF%BC%89%E5%85%8D%E4%BF%A1%E4%BB%BB%E7%9A%84%E4%BB%B2%E8%A3%81><span class=toc-text>（加强）免信任的仲裁</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B5%84%E9%87%91%E6%89%98%E7%AE%A1%E8%80%85%E7%9A%84%E7%81%BE%E5%A4%87><span class=toc-text>资金托管者的灾备</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%85%8D%E4%BF%A1%E4%BB%BB%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%95%86><span class=toc-text>免信任的服务商</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%B0%8F%E7%BB%93><span class=toc-text>小结</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%A2%98%E5%A4%96%E8%AF%9D><span class=toc-text>题外话</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE><span class=toc-text>参考文献</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id=postTitle>有趣的比特币脚本（三）：时间锁</h1><div class=page-author><div class="is-flex is-flex-direction-row page-data mr-6"><img class=mr-1 src=/images/default_avatar.png alt=Anony><div class=page-author-info><strong>Anony</strong><time class=has-text-grey datetime=2023-04-21T05:08:25.000Z>2023-04-21</time></div></div><div class=is-flex><a href=/tags/%E5%BC%80%E5%8F%91><i class="page-tag mr-1 px-1">开发</i></a><a href=/tags/%E6%97%B6%E9%97%B4%E9%94%81><i class="page-tag mr-1 px-1">时间锁</i></a></div></div><article class="mt-4 post-content"><blockquote><p><em>作者：Anony</em></p><p><em>前篇文章见<a href=https://www.btcstudy.org/2023/04/19/interesting-bitcoin-scripts-and-its-use-cases-part-2-multisig/ >此处</a>。</em></p></blockquote><p>在上一篇文章中，我们介绍最常用的比特币复杂脚本模块：多签名（multisig）。在介绍了多签名可以应用的诸多场景之后，我们还介绍了比特币脚本的流程控制功能（条件语句），这种功能让我们可以在同一笔资金上施加多个并列的解锁条件。如果我们只有多签名这种模块，能够运用条件语句来组合的东西也将是十分有限的。但是，如果我们还有别的模块，它们就可以组合出更加奇妙的东西。</p><p>在本文中，我们将学习另一种人们耳熟的模块：时间锁。</p><h2 id=“时间锁”-简介><a href=#“时间锁”-简介 class=headerlink title="“时间锁” 简介"></a>“时间锁” 简介</h2><p>“时间锁” 就是在某一个时间事件发生后才能打开的锁，即，为了通过这样的操作码的检查，由某种方式取得的当前时间已经越过了脚本预先指定的时间。</p><p>比特币系统可以实现两种时间锁 <sup><a href=#note1 id=jump-1>1</a></sup>：一种称为 “绝对时间锁”，在一个 “具体” 的时间点（比如某个日期或某个区块高度）后解锁；另一种称为 “相对时间锁”，在一定的时延（比如区块的数量）之后解锁，时延的起点就是该时间锁所在脚本（输出）得到确认的时间。</p><p>举个例子，绝对时间锁的意思是：“这笔钱在区块高度 350000 后才可花费”；而相对时间锁的意思是：“这笔钱在得到区块确认的 2 个区块之后才可花费”。</p><p>至于时点和时延的描述方式，有两种：（1）区块高度（区块数量）；（2）秒钟（或以 512 秒为单位的区间）；绝对时间锁可以精确到秒（它是一个 unix 时间戳），相对时间锁则以设定的数值乘以 512 决定（以秒计算的）时延的长度；在检查使用这种度量方式的时间锁时，需要确定一个 “网络当前时间”，而比特币使用的是 BIP 113 <sup><a href=#note2 id=jump-2>2</a></sup> 所描述的 “过往中值时间”，即过去 11 个区块的时间戳的中间值。</p><p>不论是设定时点还是设定时延，都有自己的用途；不论使用区块高度还是秒，也都有自身的复杂性和不确定性，但是，当我们接触到具体的应用之后，我们会发现这种复杂性是无伤大雅的，绝大部分应用都不需要依赖于绝对精确的时间。</p><p>比特币可以在交易层面设置时间锁，也可以在脚本中设置。出于本系列的目的，我们只介绍脚本层面的时间锁：OP_CLTV <sup><a href=#note3 id=jump-3>3</a></sup> 和 OP_CSV <sup><a href=#note4 id=jump-4>4</a></sup>。值得一提的是，两者都是在 2016 年 7 月的软分叉 <sup><a href=#note5 id=jump-5>5</a></sup> 中引入比特币的。</p><h2 id=时间锁脚本示例><a href=#时间锁脚本示例 class=headerlink title=时间锁脚本示例></a>时间锁脚本示例</h2><p>在本系列的上一篇文章中，我们介绍了两种 Policy 函数：<code>thresh()</code>，用于设定门限（阈值）条件；<code>pk()</code>，用于指定公钥和签名检查。</p><p>在这里，我们要引入以下几种 Policy 函数：</p><ul><li><code>after(NUM)</code> 和 <code>older(NUM)</code>，分别对应我们上文说的绝对时间锁和相对时间锁；</li><li><code>and(,)</code>，表示在括号里的条件都需要满足，才能花费；各条件以逗号分隔；</li><li><code>or(,)</code>，表示在括号里的条件只需满足一个，即可花费；各条件以逗号分隔；没错，这里的 and 和 or，就对应于我们在上一篇文章中提到的流程控制语句（条件语句）；随着我们掌握的脚本模块越来越多，我们也越来越需要它们来帮我们实现更复杂的花费条件。</li></ul><p>那么，我们先来编写这样一种脚本：它意味着，我（作为资金的主人），光凭我自己就可以花一笔钱，但不能立即花费出去，必须在区块高度 800000 之后才能花费。用 Policy 语言来描述一下这个花费条件：</p><pre><code>and(after(800000), pk(Alice))
</code></pre><p>使用 Miniscript 编译器 <sup><a href=#note6 id=jump-6>6</a></sup>，我们将它编译成 Miniscript 代码：</p><pre><code>and_v(v:pk(Alice),after(800000))
</code></pre><p>而它对应的 Script 代码是：</p><pre><code>&lt;Alice&gt; OP_CHECKSIGVERIFY &lt;00350c&gt; OP_CHECKLOCKTIMEVERIFY
</code></pre><p>我们再想一个更复杂的策略：我可以随时花费一笔钱，但如果这笔钱很长时间（比如 3 个月）都没有动用，则我指定的另外三个公钥中的其中两个，可以花费它。描述这种条件的 Policy 语句是：</p><pre><code>or(pk(Alice), and(older(12960), thresh(2, pk(Bob), pk(Carol), pk(David))))
</code></pre><p>编译成 Miniscript 代码：</p><pre><code>or_d(pk(Alice),and_v(v:multi(2,Bob,Carol,David),older(12960)))
</code></pre><p>再编译成 Script 代码：</p><pre><code>&lt;Alice&gt; OP_CHECKSIG 
OP_IFDUP OP_NOTIF
  2 &lt;Bob&gt; &lt;Carol&gt; &lt;David&gt; 3 OP_CHECKMULTISIGVERIFY &lt;a032&gt; OP_CHECKSEQUENCEVERIFY
OP_ENDIF
</code></pre><p>代码中的 <code>OP_IFDUP</code>、<code>OP_NOTIF</code>、<code>OP_ENDIF</code> 就扮演了流程控制的功能。值得提醒的是，在这两段 Script 代码中，时间锁检查都被放在了后面；而在常见的一些 Script 示例中，作者手写的代码通常会把时间锁检查放在签名检查的前面，就连 BIP-0112 的示例代码也不例外（可能因为我们人类的思维习惯就是这样的，要把最重要的前提写在前面）。这也说明了，不同的 Script 代码也许能实现相同的花费条件，而一旦脚本公钥不同，脚本签名也必须不同。我们需要 Miniscript 这样的工具，来帮我们驯服其中的复杂性。</p><p>下面，我们来看看时间锁有哪些用途吧。</p><h2 id=时间锁应用场景><a href=#时间锁应用场景 class=headerlink title=时间锁应用场景></a>时间锁应用场景</h2><h3 id=个人的强制储蓄><a href=#个人的强制储蓄 class=headerlink title=个人的强制储蓄></a>个人的强制储蓄</h3><p>这就是上一章中的第一种花费条件的作用。它可以帮助个人强制储蓄：一旦用户的比特币资金使用这种方式锁定，就不可能在 TA 自己设定的时间点之前花费。资金完完全全属于用户自己，无需托管给任何人，其保管方式跟用户常用的单签名钱包只有细微的差别（需要用户备份赎回脚本，可以通过备份 Miniscript 代码和输出描述符 <sup><a href=#note7 id=jump-7>7</a></sup> 来解决）。</p><p>可以协助这样的强制储蓄的产品在比特币世界还不存在，但在现实世界里，强制储蓄服务是有市场的。</p><h3 id=灾备措施-意外应对><a href=#灾备措施-意外应对 class=headerlink title=灾备措施&#x2F;意外应对></a>灾备措施&#x2F;意外应对</h3><p>人总会遇到意外，这些意外可能大到我们无法再跟家人交代重要的事。在保管比特币的同时，我们显然也应该意识到，有一些风险不能仅靠多签名（分散资金的控制权）来消除。时间锁在这里就可以派上用场了：借助条件语句和时间锁、多签名，我们可以实现这样一种花费条件：我（本人）仅凭一个公钥随时可以花费这种脚本锁定的资金；但如果一笔以此脚本锁定的资金长达 3 个月（或 1 年）没有被花费过，则另外三个公钥（我的另一个私钥、我的家人、一个律师所）中的两个可以花费其中的资金。这就实现了一种遗产规划。（注意：这样的条件只能用相对时间锁实现。）</p><p>没错，这正是上一章中的第二种脚本可以起到的作用，其 Policy 语句可以稍微修改一下：</p><pre><code>or(pk(Alice-1), and(older(12960), thresh(2, pk(Alice-2), pk(Bob), pk(Lawyer-Carol))))
</code></pre><p>当前尚未有这样的产品。</p><h3 id=资金的社交恢复><a href=#资金的社交恢复 class=headerlink title=资金的社交恢复></a>资金的社交恢复</h3><p>算是一种特殊灾备措施。使用类似的机制，可以产生这样的效果：假如我弄丢了一把私钥，经过我的 5 个朋友中的 3 个人的帮助，我可以将资金转移到别的地方。跟 “灾备措施” 中的脚本的结构完全一样，都是 “单签名 or 时间锁 + 多签名”。这里的 “单签名” 也可以换成多签名，以减少对朋友的打扰。</p><p>跟中心化账户的 “社交恢复” 不一样的地方在于，我们这种社交恢复需要预先指定朋友，而不能等到有需要时再自由指定。</p><blockquote><p>另一个有趣的问题是：假设我们在这里使用单签名，能否应对相关私钥的失盗风险？换句话说，如果有人偷走了我们在这个单签名条款中使用的私钥，但不知道我们有这样的脚本，我们能否放心使用社交恢复机制？</p><p>按照我们对 P2SH&#x2F;P2WSH 的理解，这是不行的，因为 P2SH&#x2F;P2WSH 输出在花费时需要完整曝光整个脚本；攻击者可以窥伺交易池、等待我们动用社交恢复机制，一旦动用，则整个脚本都会曝光，攻击者就知道了自己手上的私钥可以独自花费这个脚本锁定的资金，然后发起花费相同的输出的交易。在一定条件下，攻击者可以通过提供更多的手续费，抢在我的朋友们的交易得到确认之前拿走资金（假设我的朋友们的交易允许 BIP-125 选择性替换 <sup><a href=#note8 id=jump-8>8</a></sup> 的话）；又或者，攻击者可以尝试直接联系矿工。</p><p>但是，有没有可能，在我的朋友们动用社交恢复机制的时候，不让外部人知道它还有一个单签名花费条款呢？有的，这就是 Taproot 升级给我们带来的东西，我们在文末揭晓。</p></blockquote><p>暂无这样的社交恢复产品。最接近的用法是利用支持多签名的软件钱包，自己搭建一个使用了朋友的公钥的多签名设置。这样的做法更接近于我们上一篇文章提到的 “免信任托管”。</p><h3 id=（加强）免信任的仲裁><a href=#（加强）免信任的仲裁 class=headerlink title=（加强）免信任的仲裁></a>（加强）免信任的仲裁</h3><p>多签名本身已经可以提供免信任的仲裁机制，见上一篇文章 <sup><a href=#note9 id=jump-9>9</a></sup>。利用时间锁，我们可以让第三方仲裁者只能在争议发生的一段时间后（表现为合约双方没有使用自己的 2-of-2 多签名解锁资金）才介入。</p><p>实际上，这种用法可能对仲裁商更为有用：一个仲裁商可以公开声明，如果你要使用我作为仲裁，请在我所在的条款中加入一个长达 2 个星期的相对时间锁。意思是说：你们应该先有两个星期的私人协商时间，然后再要求我们的帮助。</p><h3 id=资金托管者的灾备><a href=#资金托管者的灾备 class=headerlink title=资金托管者的灾备></a>资金托管者的灾备</h3><p>上一篇文章的 “联盟侧链” 一节提到，Liquid Network 侧链使用了 11-of-15 的多签名结构来托管资金。多签名虽然分散了资金的控制权，消除了单一私钥的单点故障，但它的容错能力也是有上限的：当（n-m+1）个私钥 损坏&#x2F;丢失 之后，资金就完全锁死了。这意味着即使是这样大的多签名结构，也需要灾备措施。</p><p>一个直觉是，我们可以用条件语句来叠加又一套多签名；但是，这又面临另一个问题：两套多签名结构的资金处置权限完全相同，如何解决其中的利益冲突呢？答案是，使用相对时间锁，仅在第一套多签名长时间无动作时，才允许第二套时间锁动用。</p><p>多签名加时间锁，才是完整的资金托管方案。</p><h3 id=免信任的服务商><a href=#免信任的服务商 class=headerlink title=免信任的服务商></a>免信任的服务商</h3><p>想象这样一种脚本，它有两个条款：（1）Alice 和 Bob 的 2-of-2 多签名；（2）时间锁解锁后，Alice 的单签名。使用绝对时间锁的话，它的 Policy 语句是这样的：</p><pre><code>or(5@and(pk(Alice),pk(Bob)),and(after(800000),pk(Alice-2)))
</code></pre><p>在这里我们使用了一种新的 Policy 记号，就是 <code>数字@</code>，它用来指明 or 的哪一个分支（条款）更常被使用，比如这里的 <code>5</code>，就表示使用它的概率是第二个分支的 5 倍。</p><pre><code>对应的 Mniscript 代码：
andor(pk(Alice),pk(Bob),and_v(v:pkh(Alice-2),after(800000)))

对应的 Script 代码：
&lt;Alice&gt; OP_CHECKSIG OP_NOTIF
  OP_DUP OP_HASH160 &lt;HASH160(Alice-2)&gt; OP_EQUALVERIFY OP_CHECKSIGVERIFY &lt;00350c&gt;
  OP_CHECKLOCKTIMEVERIFY
OP_ELSE
  &lt;Bob&gt; OP_CHECKSIG
OP_ENDIF

如果我们使用thresh(2, pk(Alice), pk(Bob)) 而不是 and() 函数，会怎么样？自己在编译器网站里试试看！
</code></pre><p>你能想象这种脚本的用途吗？我们逐一来分析：</p><ol><li>第一个条款意味着，不论 Bob 想要怎么花这笔钱，都需要经过 Alice 的同意！</li><li>第二个条款意味着，在某个时间点之后，Alice 就可以独自花费这笔钱！</li></ol><p>把这里的 “Alice” 和 “Bob” 分别替换成 “用户” 和 “服务商”！这意味着，在这种脚本中，服务商可以帮我们做一些事情，如果我们同意，就可以使用我们注入其中的资金；同时，如果服务商不按我们的要求行动，我们也完全不用担心，因为这笔钱最终是属于我的！</p><p>大量的服务，都可以使用这种脚本来去除信任。例如，一个付费观看电影的网站，可以在每次为我提供新电影时都要求我支付（利用第一种条款的单向支付通道特性），但我不需要让资金进入网站的托管，当我停止观看、停止签名链下的支付交易之后，我的资金就不会再减少，网站将提交我之前签过名的交易，拿走属于 TA 的那一份资金。</p><p>甚至，连托管式在线密码货币交易所也可以使用这种脚本：用户存入的资金不是进入交易所掌控的单签名输出，而是进入由这种脚本锁定的输出；每当用户需要换取其它密码货币的时候，就签名花费这个输出的多签名条款的交易，而如果用户没有买卖，则在一段时间后，资金会完全回到用户的掌控中。相当于交易所给了一种可信的承诺：我不会挪用您的资金；如果你不使用这笔资金，它会自动回到您的掌控中，不需要您发起取款操作，自然，也不需要您支付取款费用。</p><p>现在，已经有使用这种脚本结构的应用了，就是 Lightning Pool <sup><a href=#note10 id=jump-10>10</a></sup>。当我们学习闪电网络之后，我们会详细介绍这种脚本在闪电网络场景中的用法。</p><h2 id=小结><a href=#小结 class=headerlink title=小结></a>小结</h2><p>如果说多签名的作用是分配控制一笔资金（参与一个合约）的权限，那么时间锁的作用就是分配不同的人群在不同时间段的权限。在我们上文的几乎所有案例中，时间锁的作用都是在某个时间之后，启用一种新的资金控制方法，使得这种方法既不会与原有的方法冲突，又不至于让资金在原有的方法失效时就锁死。</p><p>用智能合约编程的术语来说，时间锁可以在某个时间点后自动启用一种新的合约状态转换规则。而搭配比特币隐藏合约内容（脚本仅在被花费时才曝光）的特性，这意味着比特币链上输出（合约）可以在外人无法察觉的环境中自动启用一条新规则。这其中的意义，怎么夸大都不为过。</p><p>时间锁通过流程控制来结合多签名，其想象空间可以说是无穷无尽的。或者说，正是因为它自身如此简单、抽象，我们才会意识到简单的结构可以用在许多场景中，才会为此惊叹。</p><p>下一篇文章，我们将学习第三种常见的脚本功能模块：哈希锁。</p><h2 id=题外话><a href=#题外话 class=headerlink title=题外话></a>题外话</h2><p>上文提到，有一种办法，可以让我们在花费一笔资金时，仅曝光实际被使用的那个条款，而不必曝光完整的脚本（用上文 “社交恢复” 的例子来说，就是只需要曝光社交恢复条款，而不需要曝光另一条单签名条款）。是什么呢，就是 Taproot 升级引入的 MAST（默克尔抽象语法树） <sup><a href=#note11 id=jump-11>11</a></sup>。</p><p>MAST 的想法是在 P2SH 的基础上更进一步：P2SH 的意思是，在形成输出的时候，脚本公钥字段记录的不是赎回脚本，而是赎回脚本的哈希值；而 MAST 的想法是，可以记录多个脚本作为叶子所形成的默克尔树的树根值（本身也是一个哈希值），从而：</p><ul><li>单个哈希值可以承诺数量巨大得多的条款</li><li>在花费时，只需曝光其中一个条款，而无需让所有条款曝光</li><li>因为最终只需曝光一个实际被使用的条款，添加并列的解锁条件不会直接影响交易的体积，也就是交易手续费不会因为使用了更大的脚本而线性提高，人们可以使用整体上更复杂、更大的花费条件，不必担心添加条款带来的经济负担</li></ul><p>MAST 不仅继承了 P2SH 的良好特性，还进一步发扬光大，提高了隐私性和经济性，让我们可以更放肆地编程比特币脚本。</p><p>此外，本文（包括上一篇）文章所用的 Miniscript，编译出来的其实都是在 P2SH&#x2F;P2WSH 下经济性更好的 Script 代码，而在 MAST 之后，为了将各条款分割到不同的叶子中，我们需要产生不同的 Script 代码和 MAST，这是当前的 Miniscript 还需要进一步开发的地方。</p><p>如果说在 Taproot 升级之前，我们在案例中提到的这些脚本结构需要担心自己的经济性、隐私性，在 Taproot 之后，这样的顾虑就可以进一步打消了。</p><h2 id=参考文献><a href=#参考文献 class=headerlink title=参考文献></a>参考文献</h2><p>1.<a id=note1> </a><a href=https://www.btcstudy.org/2021/10/31/bitcoins-time-locks/ >https://www.btcstudy.org/2021/10/31/bitcoins-time-locks/</a> <a href=#jump-1>↩</a></p><p>2.<a id=note2> </a><a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki>https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki</a> <a href=#jump-2>↩</a></p><p>3.<a id=note3> </a><a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki>https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki</a> <a href=#jump-3>↩</a></p><p>4.<a id=note4> </a><a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki>https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki</a> <a href=#jump-4>↩</a></p><p>5.<a id=note5> </a><a href=https://www.btcstudy.org/2022/09/05/a-complete-history-of-bitcoins-consensus-forks/#2016-%E5%B9%B4-7-%E6%9C%88-4-%E6%97%A5%EF%BC%88%E7%9B%B8%E5%AF%B9%E6%97%B6%E9%97%B4%E9%94%81%EF%BC%89>https://www.btcstudy.org/2022/09/05/a-complete-history-of-bitcoins-consensus-forks/#2016-%E5%B9%B4-7-%E6%9C%88-4-%E6%97%A5%EF%BC%88%E7%9B%B8%E5%AF%B9%E6%97%B6%E9%97%B4%E9%94%81%EF%BC%89</a> <a href=#jump-5>↩</a></p><p>6.<a id=note6> </a><a target=_blank rel=noopener href=https://bitcoin.sipa.be/miniscript/ >https://bitcoin.sipa.be/miniscript/</a> <a href=#jump-6>↩</a></p><p>7.<a id=note7> </a><a href=https://www.btcstudy.org/2022/05/10/what-are-output-descriptors/ >https://www.btcstudy.org/2022/05/10/what-are-output-descriptors/</a> <a href=#jump-7>↩</a></p><p>8.<a id=note8> </a><a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki>https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki</a> <a href=#jump-8>↩</a></p><p>9.<a id=note9> </a><a href=https://www.btcstudy.org/2023/04/19/interesting-bitcoin-scripts-and-its-use-cases-part-2-multisig/ >https://www.btcstudy.org/2023/04/19/interesting-bitcoin-scripts-and-its-use-cases-part-2-multisig/</a> <a href=#jump-9>↩</a></p><p>10.<a id=note10> </a><a target=_blank rel=noopener href=https://lightning.engineering/pool/ >https://lightning.engineering/pool/</a> <a href=#jump-10>↩</a></p><p>11.<a id=note11> </a><a href=https://www.btcstudy.org/2021/09/07/what-is-a-bitcoin-merklized-abstract-syntax-tree-mast/ >https://www.btcstudy.org/2021/09/07/what-is-a-bitcoin-merklized-abstract-syntax-tree-mast/</a> <a href=#jump-11>↩</a></p><blockquote><p><em>续篇见<a href=https://www.btcstudy.org/2023/04/23/interesting-bitcoin-scripts-and-its-use-cases-part-4-hash-locks/ >此处</a>。</em></p></blockquote></article></div></div></main><script src="/js/post.js?v=1682773100887"></script><script src="/js/highlight.min.js?v=1682773100887"></script><script>var containerEl=document.querySelector(".post-container"),postFontSize=localStorage.getItem("post-font-size")||"16",inputEl=document.querySelector("#size-change-input"),inputEl2=document.querySelector("#size-change-input2");inputEl.value=postFontSize,inputEl2.value=postFontSize,containerEl.style.fontSize=postFontSize+"px",$(function(){function e(t){$(".post-container").css("font-size",t+"px"),localStorage.setItem("post-font-size",t),$("#size-change-input").val(t),$("#size-change-input2").val(t)}$("#size-change-input").on("input propertychange",function(t){e(t.target.value)}),$("#size-change-input2").on("input propertychange",function(t){e(t.target.value)})})</script><script>hljs.initHighlightingOnLoad()</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class=sns-container><a title=nostr target=_blank rel="noopener nofollow" href=https://iris.to/npub1g2qs0ca5kpwlrcfug2em4jelmh65clk3yccwjxrs6hvdpd9qj80q022j4m>Nostr</a><a title=rss target=_blank rel="noopener nofollow" href=/atom.xml>rss</a><a title=telegram target=_blank rel="noopener nofollow" href=//t.me/btcstudyorg>Telegram</a></section></footer><script async src="/js/buttons.js?v=1682773100887"></script><script async src="/js/index.js?v=1682773100887"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JVCJ9XXG1Z")</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306",e.async=!0,e.defer=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script></body></html>