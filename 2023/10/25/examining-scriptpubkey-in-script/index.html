<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><title>限制条款：在比特币脚本中求出脚本公钥</title><meta name=keywords content="比特币, 中本聪, 比特币区块链, 闪电网络, 比特币 layer 2, 健全货币, 密码货币, 密码朋克, 学习比特币, BTC, BTC Study, Bitcoin, bitcoin, proof of work"><meta name=description content=比特币思想的中文集结地><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1"><link rel=icon href=/favicon.ico><link rel=stylesheet href="/style/common/bulma.css?v=1682773100887"><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href="/style/common/iconfont.css?v=1682773100887"><link rel=stylesheet href="/style/base.css?v=1682773100887"><link rel=stylesheet href="/style/common/helper.css?v=1682773100887"><link rel=stylesheet href="/style/themes/animation.css?v=1682773100887"><script>function ready(){var e=document.querySelector(".body-container"),t=localStorage.getItem("theme")||"light";["light","dark"].includes(t)||(t="light",localStorage.setItem("theme","light")),e.classList.remove("appearance-auto"),e.classList.add("appearance-"+t),quickInitialTheme()}function quickInitialTheme(){var e=localStorage.getItem("theme")||"light",t=document.querySelector(".logo-light"),o=document.querySelector(".logo-dark"),d=document.querySelector("#mobile-header-logo > .logo-light"),l=document.querySelector("#mobile-header-logo > .logo-dark"),a=document.getElementById("theme-btn"),i=document.querySelector(".slide-theme-light"),c=document.querySelector(".slide-theme-dark");document.body.classList.add(e),("dark"===e?(t.classList.add("hidden"),o.classList.remove("hidden"),d.classList.add("hidden"),l.classList.remove("hidden"),a.classList.remove("icon-icon_dark"),a.classList.add("icon-icon_light"),i):c).classList.remove("hidden")}document.addEventListener("DOMContentLoaded",ready)</script><script src="/js/common.js?v=1682773100887"></script><script src=/js/libs/zepto.min.js></script><link rel=stylesheet href="/style/post.css?v=1682773100887"><link rel=stylesheet href="/style/themes/highlight.css?v=1682773100887"><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title="BTC Study" type=application/atom+xml></head><body class="is-flex is-flex-direction-column" onload=initialTheme()><div class=clip></div><div class="body-container appearance-auto"><header class="header-widget is-hidden-mobile is-flex is-flex-shrink-0 is-align-items-center is-justify-content-center" id=header><div class="is-flex header-widget-container is-flex-shrink-0 is-align-items-center"><section class="is-hidden-mobile is-flex-shrink-0"><h1><a href=/ ><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></a></h1></section><div class="is-flex is-flex-direction-column header-menu-wrap"><aside class="is-flex-shrink-0 is-flex is-flex-direction-row is-align-items-center" id=header-menu><a class="is-inline-block header-activity mr-4" href=/ >首页</a><a class="is-inline-block mr-4" href=/archives>全站目录</a><a class="is-inline-block mr-4" href=/tags>标签</a><a class="is-inline-block mr-4" href=/maps>地图</a><a class="is-inline-block mr-4" href=/tools>工具</a><a class="is-inline-block mr-4" target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div class="right-content is-flex is-flex-direction-row is-align-items-center"><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input type=range min=12 max=32 step=2></div></div></div><i class="iconfont icon-icon_dark mr-1" id=theme-btn></i><div class=search-wrap><input class=pl-3 id=search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search" id=search-input-btn></i></div></div></aside><div class="header-title is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopic><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">限制条款：在比特币脚本中求出脚本公钥</p><div class="size-wrap mr-1"><i class="iconfont icon-a-bianzu5" id=change-size-btn2></i><div class=size-input-wrap><div class=input-wrap><input id=size-change-input2 type=range min=12 max=32 step=2></div></div></div></div></div></div></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-tablet" id=mobile-header><div class="is-flex is-flex-direction-row is-align-items-center"><i class="iconfont icon-icon_bar mobile-header-menu"></i><div id=mobile-header-logo><svg class=logo-light width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#000000></path></g></g></g></svg><svg class="logo-dark hidden" width=125px height=23px viewBox="0 0 125 23" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><title>BTCStudy</title><g id=页面-1 stroke=none stroke-width=1 fill=none fill-rule=evenodd><g id=首页-响应式 transform="translate(-249.000000, -23.000000)" fill-rule=nonzero><g id=BTCStudy transform="translate(249.680000, 23.192000)"><path d="M9.072,17.808 C11.312,17.808 13.024,17.408 14.208,16.608 C15.392,15.808 15.984,14.672 15.984,13.2 C15.984,12.192 15.712,11.332 15.168,10.62 C14.624,9.908 13.872,9.384 12.912,9.048 C13.632,8.68 14.188,8.18 14.58,7.548 C14.972,6.916 15.168,6.2 15.168,5.4 C15.168,4.056 14.608,2.988 13.488,2.196 C12.368,1.404 10.736,1.008 8.592,1.008 L8.592,1.008 L-5.68434189e-14,1.008 L-5.68434189e-14,17.808 L9.072,17.808 Z M7.968,7.68 L4.704,7.68 L4.704,4.44 L7.968,4.44 C9.568,4.44 10.368,4.976 10.368,6.048 C10.368,7.136 9.568,7.68 7.968,7.68 L7.968,7.68 Z M8.688,14.376 L4.704,14.376 L4.704,10.968 L8.688,10.968 C10.352,10.968 11.184,11.536 11.184,12.672 C11.184,13.808 10.352,14.376 8.688,14.376 L8.688,14.376 Z M26.544,17.808 L26.544,4.776 L31.68,4.776 L31.68,1.008 L16.632,1.008 L16.632,4.776 L21.792,4.776 L21.792,17.808 L26.544,17.808 Z M41.592,18.144 C43.128,18.144 44.512,17.872 45.744,17.328 C46.976,16.784 48,16 48.816,14.976 L48.816,14.976 L45.792,12.24 C44.704,13.552 43.384,14.208 41.832,14.208 C40.92,14.208 40.108,14.008 39.396,13.608 C38.684,13.208 38.132,12.644 37.74,11.916 C37.348,11.188 37.152,10.352 37.152,9.408 C37.152,8.464 37.348,7.628 37.74,6.9 C38.132,6.172 38.684,5.608 39.396,5.208 C40.108,4.808 40.92,4.608 41.832,4.608 C43.384,4.608 44.704,5.264 45.792,6.576 L45.792,6.576 L48.816,3.84 C48,2.816 46.976,2.032 45.744,1.488 C44.512,0.944 43.128,0.672 41.592,0.672 C39.832,0.672 38.252,1.044 36.852,1.788 C35.452,2.532 34.352,3.568 33.552,4.896 C32.752,6.224 32.352,7.728 32.352,9.408 C32.352,11.088 32.752,12.592 33.552,13.92 C34.352,15.248 35.452,16.284 36.852,17.028 C38.252,17.772 39.832,18.144 41.592,18.144 Z" id=BTC fill=#F2A900></path><path d="M56.64,18.144 C58.24,18.144 59.6,17.9 60.72,17.412 C61.84,16.924 62.68,16.272 63.24,15.456 C63.8,14.64 64.08,13.728 64.08,12.72 C64.08,11.552 63.772,10.628 63.156,9.948 C62.54,9.268 61.812,8.772 60.972,8.46 C60.132,8.148 59.072,7.856 57.792,7.584 C56.656,7.344 55.832,7.112 55.32,6.888 C54.808,6.664 54.552,6.328 54.552,5.88 C54.552,5.432 54.768,5.068 55.2,4.788 C55.632,4.508 56.32,4.368 57.264,4.368 C58.768,4.368 60.32,4.8 61.92,5.664 L61.92,5.664 L63.384,2.136 C62.568,1.656 61.624,1.292 60.552,1.044 C59.48,0.796 58.392,0.672 57.288,0.672 C55.672,0.672 54.308,0.912 53.196,1.392 C52.084,1.872 51.248,2.524 50.688,3.348 C50.128,4.172 49.848,5.096 49.848,6.12 C49.848,7.288 50.152,8.216 50.76,8.904 C51.368,9.592 52.096,10.092 52.944,10.404 C53.792,10.716 54.848,11.008 56.112,11.28 C57.264,11.536 58.1,11.78 58.62,12.012 C59.14,12.244 59.4,12.6 59.4,13.08 C59.4,13.992 58.488,14.448 56.664,14.448 C55.704,14.448 54.728,14.296 53.736,13.992 C52.744,13.688 51.872,13.288 51.12,12.792 L51.12,12.792 L49.56,16.296 C50.36,16.856 51.4,17.304 52.68,17.64 C53.96,17.976 55.28,18.144 56.64,18.144 Z M71.856,18.024 C72.48,18.024 73.068,17.96 73.62,17.832 C74.172,17.704 74.64,17.52 75.024,17.28 L75.024,17.28 L73.896,14.088 C73.496,14.36 73.032,14.496 72.504,14.496 C72.088,14.496 71.756,14.364 71.508,14.1 C71.26,13.836 71.136,13.472 71.136,13.008 L71.136,13.008 L71.136,8.688 L74.112,8.688 L74.112,5.28 L71.136,5.28 L71.136,1.896 L66.576,1.896 L66.576,5.28 L64.68,5.28 L64.68,8.688 L66.576,8.688 L66.576,13.056 C66.576,14.704 67.032,15.944 67.944,16.776 C68.856,17.608 70.16,18.024 71.856,18.024 Z M82.248,18.024 C83,18.024 83.712,17.888 84.384,17.616 C85.056,17.344 85.632,16.944 86.112,16.416 L86.112,16.416 L86.112,17.808 L90.456,17.808 L90.456,4.8 L85.896,4.8 L85.896,11.064 C85.896,12.104 85.668,12.876 85.212,13.38 C84.756,13.884 84.168,14.136 83.448,14.136 C82.744,14.136 82.208,13.912 81.84,13.464 C81.472,13.016 81.288,12.304 81.288,11.328 L81.288,11.328 L81.288,4.8 L76.728,4.8 L76.728,12.072 C76.728,14.056 77.228,15.544 78.228,16.536 C79.228,17.528 80.568,18.024 82.248,18.024 Z M99.048,18.024 C100.744,18.024 102.016,17.52 102.864,16.512 L102.864,16.512 L102.864,17.808 L107.208,17.808 L107.208,0 L102.648,0 L102.648,5.928 C101.8,5.032 100.6,4.584 99.048,4.584 C97.864,4.584 96.784,4.856 95.808,5.4 C94.832,5.944 94.06,6.724 93.492,7.74 C92.924,8.756 92.64,9.936 92.64,11.28 C92.64,12.624 92.924,13.808 93.492,14.832 C94.06,15.856 94.832,16.644 95.808,17.196 C96.784,17.748 97.864,18.024 99.048,18.024 Z M100.008,14.4 C99.208,14.4 98.552,14.124 98.04,13.572 C97.528,13.02 97.272,12.256 97.272,11.28 C97.272,10.32 97.528,9.568 98.04,9.024 C98.552,8.48 99.208,8.208 100.008,8.208 C100.808,8.208 101.46,8.48 101.964,9.024 C102.468,9.568 102.72,10.32 102.72,11.28 C102.72,12.256 102.464,13.02 101.952,13.572 C101.44,14.124 100.792,14.4 100.008,14.4 Z M112.368,22.68 C113.728,22.68 114.88,22.356 115.824,21.708 C116.768,21.06 117.568,19.936 118.224,18.336 L118.224,18.336 L123.84,4.8 L119.496,4.8 L116.28,12.744 L113.088,4.8 L108.408,4.8 L113.976,17.976 C113.784,18.36 113.548,18.64 113.268,18.816 C112.988,18.992 112.632,19.08 112.2,19.08 C111.832,19.08 111.468,19.012 111.108,18.876 C110.748,18.74 110.44,18.552 110.184,18.312 L110.184,18.312 L108.6,21.504 C109.032,21.856 109.596,22.14 110.292,22.356 C110.988,22.572 111.68,22.68 112.368,22.68 Z" id=Study fill-opacity=0.85 fill=#FFFFFF></path></g></g></g></svg></div><div class="mobile-header-title is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height hidden" id=postTopicMobile><p class=is-full-height>限制条款：在比特币脚本中求出脚本公钥</p></div></div></div><i class="iconfont icon-icon_search mobile-header-searchIcon"></i><div class=mobile-search-wrap><div class=search-input><input class=pl-3 id=mobile-search-input placeholder=请输入搜索关键词><i class="iconfont icon-icon_search mobile-search-input-btn"></i><button class=mobile-search-input-btn>搜 索</button></div></div></header><div class=mobile-slide-menu><a class=header-activity href=/ >首页</a><a href=/archives>全站目录</a><a href=/tags>标签</a><a href=/maps>地图</a><a href=/tools>工具</a><a target=_blank rel=noopener href=https://123btc.org/ >123btc</a><div><p class="slide-menu-theme is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center"><span>主题设置</span><span><i class="iconfont icon-icon_light slide-theme-light hidden"></i><i class="iconfont icon-icon_dark slide-theme-dark hidden"></i></span></p><p class=slide-menu-fontsize><span>字体设置</span><span><i class="iconfont icon-bianzubeifen"></i><i class="iconfont icon-bianzu"></i></span></p></div></div><div class="search-mask hidden"><script src="/js/header.js?v=1682773100887"></script></div><main><main class="container is-max-widescreen content section post-page pt-4"><div class="columns is-flex-desktop is-justify-content-center"><div class="column is-3 silde-bar is-hidden-mobile"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%9C%A8%E8%84%9A%E6%9C%AC%E4%B8%AD%EF%BC%8C%E5%88%B6%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-Taproot-%E8%84%9A%E6%9C%AC%E5%85%AC%E9%92%A5><span class=toc-text>在脚本中，制作一个简单的 Taproot 脚本公钥</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81-OP-CAT%EF%BC%8C%E6%88%96%E8%80%85-OP-MULTISHA256><span class=toc-text>步骤 1：我们需要 OP_CAT，或者 OP_MULTISHA256</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%E4%B8%80%E4%B8%AA%E5%85%AC%E9%92%A5%EF%BC%8COP-KEYADDTWEAK><span class=toc-text>步骤 2：我们需要调整一个公钥，OP_KEYADDTWEAK</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%AD%A5%E9%AA%A4-3-%EF%BC%9A%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%8A%A0%E5%85%A5-Taproot-%E5%AD%97%E8%8A%82%E5%89%8D%E7%BC%80><span class=toc-text>步骤 3 ：我们需要加入 Taproot 字节前缀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%9C%A8%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%AE%8C%E6%95%B4%E7%9A%84-Taproot><span class=toc-text>在脚本中实现一个更完整的 Taproot</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%B8%A6%E6%A0%87%E7%AD%BE%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC><span class=toc-text>步骤 1：带标签的哈希值</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%AF%B9%E6%AF%94%E7%84%B6%E5%90%8E%E5%93%88%E5%B8%8C%EF%BC%9A%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81-OP-LESS-%E6%88%96%E8%80%85-OP-CONDSWAP><span class=toc-text>步骤 2：对比然后哈希：我们需要 OP_LESS 或者 OP_CONDSWAP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%88%B6%E4%BD%9C%E6%9B%B4%E6%9C%89%E7%94%A8%E7%9A%84%E6%A8%A1%E6%9D%BF%EF%BC%9A%E5%89%8A%E5%BC%B1-OP-SUCCESS-%E7%9A%84%E5%A8%81%E5%8A%9B><span class=toc-text>制作更有用的模板：削弱 OP_SUCCESS 的威力</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-text>总结</span></a></li></ol></div><div class="column is-9 post-container"><h1 class="mt-0 mb-2" id=postTitle>限制条款：在比特币脚本中求出脚本公钥</h1><div class=page-author><div class="is-flex is-flex-direction-row page-data mr-6"><img class=mr-1 src=/images/default_avatar.png alt="Rusty Russell"><div class=page-author-info><strong>Rusty Russell</strong><time class=has-text-grey datetime=2023-10-25T03:22:38.000Z>2023-10-25</time></div></div><div class=is-flex><a href=/tags/covenant><i class="page-tag mr-1 px-1">covenant</i></a></div></div><article class="mt-4 post-content"><blockquote><p><em>作者：Rusty Russell</em></p><p><em>来源：<a target=_blank rel=noopener href=https://rusty.ozlabs.org/2023/10/20/examining-scriptpubkey-in-script.html>https://rusty.ozlabs.org/2023/10/20/examining-scriptpubkey-in-script.html</a></em></p></blockquote><p><em>限制条款（covenants）</em> 是一种允许内省的构造：交易的输出可以为花费它的交易设置条件（超越了具体的 “必须提供一个具体的公钥以及这个公钥的有效签名”。</p><p>我偏爱的实现内省的方式，是让 Bitcoin Script 拥有一种办法将花费交易的多个部分放入堆栈中（也即 <code>OP_TX</code>），以便于直接的测试（按照我的<a target=_blank rel=noopener href=https://rusty.ozlabs.org/2023/07/09/covenant-taxonomy.html>分类学</a>（<a href=https://www.btcstudy.org/2023/07/12/covenants-in-bitcoin-a-useful-review/ >中文译本</a>），可以定义为 “全方位的限制条款”，与 “等式限制条款” —— 使用一些交易哈希值、要求脚本在产生一个相匹配的哈希值时才能通过 —— 相对）。在全方位限制条款中，你可以这样做：</p><pre><code># 检查 nLocktime 是否 大于 100
OP_TX_BIT_NLOCKTIME OP_TX 100 OP_GREATERTHAN OP_VERIFY
</code></pre><p>而在等式限制条款中，你需要这样做：</p><pre><code># 为堆栈提供 nLocktime 的数值
OP_DUP
# 先检查这个数值是否大于 100
100 OP_GREATERTHAN OP_VERIFY
# 现在，检查这个被检查的数值真的就是所要求的数值，通过比较一个哈希值与 nLocktime 数值的哈希值
OP_SHA256
OP_TX_BIT_NLOCKTIME OP_TXHASH OP_EQUALVERIFY
</code></pre><p>但是，当我们要检查一个输出的脚本公钥时，我们不得不采取后面这种模式（等式限制条款），除非我们要的是一个精确的一直：脚本公钥（几乎总是）实际上的花费条件的单向函数。</p><h2 id=在脚本中，制作一个简单的-Taproot-脚本公钥><a href=#在脚本中，制作一个简单的-Taproot-脚本公钥 class=headerlink title="在脚本中，制作一个简单的 Taproot 脚本公钥"></a>在脚本中，制作一个简单的 Taproot 脚本公钥</h2><p>我们举一个简单 taproot 的例子。你想要断言一个脚本公钥支付给了一个已知的公钥 <code>K</code>，以及一个由限制条款花费者给出的一个脚本。这是 Taproot 的最简单的有趣形式 —— 只有一个脚本路径。</p><p>（根据 <a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki>BIP 341</a>）将这些条件转变一个脚本公钥需要采取以下步骤：</p><ol><li>获得这个脚本的一个带标签的 tapleaf 哈希值</li><li>使用这个哈希值来调整公钥 <code>K</code></li><li>加上两个字节的前缀 “0x51 0x20”</li><li>与这笔交易的脚本公钥相比较</li></ol><h3 id=步骤-1：我们需要-OP-CAT，或者-OP-MULTISHA256><a href=#步骤-1：我们需要-OP-CAT，或者-OP-MULTISHA256 class=headerlink title="步骤 1：我们需要 OP_CAT，或者 OP_MULTISHA256"></a>步骤 1：我们需要 OP_CAT，或者 OP_MULTISHA256</h3><p>如果我们列出需要哈希的内容，看起来会是这样的：</p><pre><code>SHA256(SHA256(&quot;TapLeaf&quot;) + SHA256(&quot;TapLeaf&quot;) + 0xC0 + CSCRIPTNUM(LEN(脚本)) + 脚本)
</code></pre><p><code>CSCRIPTNUM(X)</code> 的值是（若要让 <code>X</code> 具备规范形式，<code>X</code> 应该来自 OP_SIZE）：</p><ul><li>如果 <code>X</code> 小于 253：<ul><li><code>X</code></li></ul></li><li>否则，如果 <code>X</code> 的长度小于 256：<ul><li>0xFD 0x00 <code>X</code></li></ul></li><li>否则，如果 <code>X</code> 的长度小于 65536：<ul><li>0xFD <code>X</code></li></ul></li><li>否则，不论什么原因，请写一个更短的脚本！</li></ul><p>最显然的实现上述运算的方法是启用 <code>OP_CAT</code>，但这个操作码已经被移除了，因为它允许构造巨大的堆栈变量。如果这是一个问题的话，我们可以转而使用一种 “拼接并哈希” 函数 <code>OP_MULTISHA256</code>，可以证明这个函数更易于使用，如果我们要哈希堆栈上自顶到底的所有元素的话。</p><p><code>OP_MULTISHA256</code> 定义：</p><ol><li>如果堆栈为空，传出错误。</li><li>从堆栈中弹出 <code>N</code> 。</li><li>如果 <code>N</code> 不是一个 CScriptNumb，传出错误。</li><li>如果堆栈中的元素少于 <code>N</code> 个，传出错误。</li><li>初始化一个 SHA256 语境（context）。</li><li>如果 <code>N</code> &gt; 0：<ol><li>弹出堆栈顶部的元素。</li><li>将该元素哈希到 SHA256 的语境中</li><li><code>N</code> 递减 1</li></ol></li><li>结束 SHA256 语境，将结果的 32 字节推入堆栈：</li></ol><p>最终成果是这样的：</p><pre><code># 目标脚本已经在堆栈中，需要产生它的带标签的 tapleaf 哈希值

# 首先，编码长度
OP_SIZE
OP_DUP
# 是否小于 253？
OP_PUSHDATA1 1 253 OP_LESSTHAN 
OP_IF
    # 堆栈中的空字节：
    0
OP_ELSE
    OP_DUP
    # 是否大于 255？
    OP_PUSHDATA1 1 0xFF OP_GREATERTHAN 
    OP_IF
        OP_PUSHDATA1 1 0xFD
    OP_ELSE
        # 需要补充字节
        OP_PUSHDATA1 2 0xFD 0x00
    OP_ENDIF
OP_ENDIF

# 将叶子版本号 0xC0 推入堆栈
OP_PUSHDATA1 1 0xC0

# 将哈希标签推入堆栈，需要做两次
OP_PUSHDATA1 7 &quot;TapLeaf&quot;
OP_SHA256
OP_DUP

# 现在，将它们一起哈希
6 OP_MULTISHA256
</code></pre><p>或者，如果我们使用 <code>OP_CAT</code> 的话（假设它可以将堆栈顶部的元素跟第二个元素拼接起来）：</p><pre><code># 目标脚本已经在堆栈中，需要产生它的带标签的 tapleaf 哈希值

# 首先，编码长度
OP_SIZE
OP_DUP
#是否小于 253？
OP_PUSHDATA1 1 253 OP_LESSTHAN 
OP_NOTIF
    OP_DUP
    # 是否大于 255？
    OP_PUSHDATA1 1 0xFF OP_GREATERTHAN 
    OP_IF
        OP_PUSHDATA1 1 0xFD
    OP_ELSE
        # 需要补充字节
        OP_PUSHDATA1 2 0xFD 0x00
    OP_ENDIF
    OP_CAT
OP_ENDIF
# 给脚本加入长度作为前缀
OP_CAT

# 将叶子版本号 0xC0 作为前缀
OP_PUSHDATA1 1 0xC0
OP_CAT

# 将哈希标签推入堆栈，两次，并作为前缀
OP_PUSHDATA1 7 &quot;TapLeaf&quot;
OP_SHA256
OP_DUP
OP_CAT
OP_CAT

# 哈希一切
OP_SHA256
</code></pre><h3 id=步骤-2：我们需要调整一个公钥，OP-KEYADDTWEAK><a href=#步骤-2：我们需要调整一个公钥，OP-KEYADDTWEAK class=headerlink title="步骤 2：我们需要调整一个公钥，OP_KEYADDTWEAK"></a>步骤 2：我们需要调整一个公钥，OP_KEYADDTWEAK</h3><p>现在，我们需要调整一个根据，根据 <a target=_blank rel=noopener href=https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki>BIP 341</a> 的细节：</p><pre><code>def taproot_tweak_pubkey(pubkey, h):
    t = int_from_bytes(tagged_hash(&quot;TapTweak&quot;, pubkey + h))
    if t &gt;= SECP256K1_ORDER:
        raise ValueError
    P = lift_x(int_from_bytes(pubkey))
    if P is None:
        raise ValueError
    Q = point_add(P, point_mul(G, t))
    return 0 if has_even_y(Q) else 1, bytes_from_int(x(Q))
</code></pre><p>假设有一个操作码 <code>OP_KEYADDTWEAK</code>，是这样工作的：</p><ol><li>如果堆栈中的元素少于 2 个，传出错误。</li><li>将调整因子 <code>t</code> 弹出堆栈。如果 <code>t &gt;= SECP256K1_ORDER</code>，传出错误。</li><li>见公钥 <code>P</code> 弹出堆栈。如果它不是一个有效的压缩公钥，传出错误。如有必要，转化成 Y 值为偶数的形式（即 <code>lift_x()</code>）。</li><li><code>Q = P + t*G</code></li><li>将 Q 的 X 坐标值推入堆栈。</li></ol><p>那么我们就只需创建带标签的哈希值，然后将它喂入 <code>OP_KEYADDTWEAK</code>：</p><pre><code># 公钥、tapscript 哈希值已经在堆栈中

OP_OVER
OP_PUSHDATA1 8 &quot;TapTweak&quot;
OP_SHA256
OP_DUP

# 堆栈中现在是：公钥、tapscript、公钥、H(TapTweak)、H(TapTweak)
4 OP_MULTISHA256
OP_KEYADDTWEAK
</code></pre><p>或者，如果使用 <code>OP_CAT</code> 而不是 <code>OP_MULTISHA256</code> 的话：</p><pre><code># 公钥、tapscript 哈希值已经在堆栈中

OP_OVER
OP_PUSHDATA1 8 &quot;TapTweak&quot;
OP_SHA256
OP_DUP

# 堆栈中现在是：公钥、tapscript、公钥、H(TapTweak)、H(TapTweak)
OP_CAT
OP_CAT
OP_CAT
OP_SHA256
OP_KEYADDTWEAK
</code></pre><h3 id=步骤-3-：我们需要加入-Taproot-字节前缀><a href=#步骤-3-：我们需要加入-Taproot-字节前缀 class=headerlink title="步骤 3 ：我们需要加入 Taproot 字节前缀"></a>步骤 3 ：我们需要加入 Taproot 字节前缀</h3><p>如果有 <code>OP_CAT</code>，那就简单了：</p><pre><code># 脚本公钥、Taproot 公钥已经在堆栈中

# Prepend &quot;OP_1 32&quot; to make Taproot v1 ScriptPubkey
OP_PUSHDATA1 2 0x51 0x20
OP_CAT
OP_EQUALVERIFY
</code></pre><p>如果使用 <code>OP_MULTISHA256</code>，我们需要哈希脚本公钥，以检查它（或者，如果我们只有 <code>OP_TXHASH</code> 的话，那它已经哈希过了）：</p><pre><code># 脚本公钥、Taproot 公钥已经在堆栈中

OP_SHA256
# 加入 “OP_1 32” 作为前缀，使之成为一个 Taproot v1 脚本公钥
OP_PUSHDATA1 2 0x51 0x20
2 OP_MULTISHA256

# 检查 SHA256(ScriptPubkey) == SHA256(0x51 0x20 taproot)
OP_EQUALVERIFY
</code></pre><h2 id=在脚本中实现一个更完整的-Taproot><a href=#在脚本中实现一个更完整的-Taproot class=headerlink title="在脚本中实现一个更完整的 Taproot"></a>在脚本中实现一个更完整的 Taproot</h2><p>上一节中的技巧已经覆盖了 “一个公钥、一个脚本” 的情形。</p><p>如果我们需要使用超过一个 taproot 叶子的 taproot 脚本公钥，我们需要对这些叶子执行默克尔运算，而不能直接使用 taproot 叶子。为了简化，假设我们需要放置两个脚本：</p><ol><li>产生脚本的带标签叶子哈希值，分别称为 <code>H1</code> 和 <code>H2</code></li><li>如果 <code>H1</code> &lt; <code>H2</code>，那么默克尔值是 <code>TaggedHash(&quot;TapBranch&quot;, H1 + H2)</code>，否则为 <code>TaggedHash(&quot;TapBranch&quot;, H2 + H1)</code></li></ol><h3 id=步骤-1：带标签的哈希值><a href=#步骤-1：带标签的哈希值 class=headerlink title="步骤 1：带标签的哈希值"></a>步骤 1：带标签的哈希值</h3><p>这在上一节中已经做到了。</p><h3 id=步骤-2：对比然后哈希：我们需要-OP-LESS-或者-OP-CONDSWAP><a href=#步骤-2：对比然后哈希：我们需要-OP-LESS-或者-OP-CONDSWAP class=headerlink title="步骤 2：对比然后哈希：我们需要 OP_LESS 或者 OP_CONDSWAP"></a>步骤 2：对比然后哈希：我们需要 OP_LESS 或者 OP_CONDSWAP</h3><p>不幸的是，除了 <code>OP_EQUAL</code>，所有的算术函数都只接收 CScriptNum 对象，所以我们需要一种新的操作码来比较 32 字节的数据。最简单的是 <code>OP_LESS</code>，不过 <code>OP_CONDSWAP</code>（将更小的数值放在栈顶）也够用了。在这里我们并不在乎数据不等长的时候要怎么做，但如果我们假设更有可能使用大端数值（big-endian values），我们可以在比较之前为较短的数值填充 “0” 前缀。</p><p>结果是这样的：</p><pre><code># Hash1、Hash2 已在堆栈中

# 将更小的哈希值换到栈顶
OP_LESS
OP_NOTIF OP_SWAP OP_ENDIF

OP_PUSHDATA1 9 &quot;TapBranch&quot;
OP_SHA256
OP_DUP

4 OP_MULTISHA256
</code></pre><p>或者，使用 <code>OP_CAT</code> 和 <code>OP_CONDSWAP</code>：</p><pre><code># Hash1、Hash2 已在堆栈中

# 将更小的哈希值换到栈顶
OP_CONDSWAP

OP_PUSHDATA1 9 &quot;TapBranch&quot;
OP_SHA256
OP_DUP

OP_CAT
OP_CAT
OP_CAT
OP_SHA256
</code></pre><p>现在，我们已经可以在比特币脚本中制作任意复杂的默克尔树了！</p><h2 id=制作更有用的模板：削弱-OP-SUCCESS-的威力><a href=#制作更有用的模板：削弱-OP-SUCCESS-的威力 class=headerlink title="制作更有用的模板：削弱 OP_SUCCESS 的威力"></a>制作更有用的模板：削弱 OP_SUCCESS 的威力</h2><p>如果我们只是想要一个类似于 “…… OR anything you want” 的条件的话，那么允许限制条款花费者指定自身的一个脚本分支就够了。但是这并不总是能奏效：考虑保险柜合约，我们希望任何花费行为都强制执行一个时延；这时候我们需要的是 “…… AND anything you want ”。</p><p>当然，我们可以让送进去的脚本以 <code>1000 OP_CHECKSEQUENCEVERIFY</code> 开头。但是，因为任何位置的操作码都会导致脚本立即通过（而不是实际执行它们），他们只需在剩余的脚本中插入一个无效的操作码，就可以覆盖掉这个检查。</p><p>我认为，有两种办法可以解决这个问题：一个是委托，就是让剩余的脚本弹出堆栈（<code>OP_POPSCRIPT</code>？）。你只需坚决要求所提供的脚本正是 <code>1000 OP_CHECKSEQUENCEVERIFY OP_POPSCRIPT</code>。</p><p>另一种办法是削弱 <code>OP_SUCCESSx</code> 操作码。这必须谨慎！具体来说，我们可以使用一种分隔符，例如 <code>OP_SEPARATOR</code>，从而改变 <code>OP_SUCCESSx</code> 的语义：</p><ul><li>如果在 <code>OP_SUCCESSx</code> 之前有一个 <code>OP_SEPARATOR</code>：<ul><li>考虑 <code>OP_SEPARATOR</code> 前面的部分：<ul><li>如果（<code>OP_IF</code> 的次数）+（<code>OP_NOTIF</code> 的次数）&gt; （<code>OP_ENDIF</code> 的次数）：传出错误</li><li>否则，按照脚本原来的样子执行：该出错，就出错。</li></ul></li></ul></li><li>让脚本通过</li></ul><p>这将一个前缀跟 <code>OP_SUCCESSx</code> 隔离开来，但必须小心，因为它是一个完整的脚本片段：未来的 <code>OP_SUCCESSx</code> 定义不能让一个无效脚本变成一个有效脚本（通过展示一个 <code>OP_ENDIF</code> 将让脚本变得有效）。</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>我尝试列举了在 Script 中实现通用的限制条款需要什么元件：假设有某种方式（例如 <code>OP_TXHASH</code> 可以访问一个输出的脚本），这样的通用限制条款可以有意义底检查花费条件。有（完整性考虑以外的）理由认为这是可欲的：特定的保险柜构造需要这个。</p><p>我们需要 3 种新的脚本操作码：我的提议是 <code>OP_MULTISHA256</code>、<code>OP_KEYADDTWEAK</code> 和 <code>OP_LESS</code>，以及对 <code>OP_SUCCESSx</code> 的处理的一个（软分叉）修订。这些新操作码都不算非常复杂。</p><p>最终的脚本非常长（而且我的脚本是没有经过测试的，所以肯定有很多 bug）。需要 41 字节来哈希一个 tapleaf，19 个字节来拼接两个 tapleaf，8 个字节来对比它们并产生最终的脚本公钥。至少需要 109 单位的见证重量，才能制作一个保险柜，而且你还得提供你想要在输出中使用的脚本。这似乎非常昂贵，但并非毫无道理：如果这种应用变得普遍，可以使用新的操作码将这些步骤合并起来。</p><p>我没有认真考虑关于这些操作码的普遍适用性，所以在别的用途中，可能会有更好的变体。</p><p>感谢阅读！</p><p>（完）</p></article></div></div></main><script src="/js/post.js?v=1682773100887"></script><script src="/js/highlight.min.js?v=1682773100887"></script><script>var containerEl=document.querySelector(".post-container"),postFontSize=localStorage.getItem("post-font-size")||"16",inputEl=document.querySelector("#size-change-input"),inputEl2=document.querySelector("#size-change-input2");inputEl.value=postFontSize,inputEl2.value=postFontSize,containerEl.style.fontSize=postFontSize+"px",$(function(){function e(t){$(".post-container").css("font-size",t+"px"),localStorage.setItem("post-font-size",t),$("#size-change-input").val(t),$("#size-change-input2").val(t)}$("#size-change-input").on("input propertychange",function(t){e(t.target.value)}),$("#size-change-input2").on("input propertychange",function(t){e(t.target.value)})})</script><script>hljs.initHighlightingOnLoad()</script></main></div><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class=sns-container><a title=nostr target=_blank rel="noopener nofollow" href=https://iris.to/npub1g2qs0ca5kpwlrcfug2em4jelmh65clk3yccwjxrs6hvdpd9qj80q022j4m>Nostr</a><a title=rss target=_blank rel="noopener nofollow" href=/atom.xml>rss</a><a title=telegram target=_blank rel="noopener nofollow" href=//t.me/btcstudyorg>Telegram</a></section></footer><script async src="/js/buttons.js?v=1682773100887"></script><script async src="/js/index.js?v=1682773100887"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVCJ9XXG1Z"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JVCJ9XXG1Z")</script><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?c92c073c85be5be8d9b1b76f62a7e306",e.async=!0,e.defer=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script></body></html>